# REPORT_REQUIREMENTS.md

## Core Report Requirements Specification

This document defines the canonical requirements for astrological chart reports generated by the Woven Map application, based on the Raven Calder system.

---

## âœ… Raw Math Requirements

Each generated report must expose the math that underwrites the mirror.

1. **Provenance header** â€“ `calculation_timestamp` (UTC ISO 8601), `software_version` (git SHA), `ephemeris`, `timezone_db_version`.
2. **Birth data echo** â€“ birth date/time/location, lat/lon, `tz_offset`, `rectification_status` (`exact|rounded|unknown`), `source` (`user|system`).
3. **Configuration** â€“ `zodiac`, `house_system`, `orbs_profile`, and `location_context` for translocation.
4. **Planetary positions** â€“ name, longitude, sign, degrees in sign, speed, retrograde flag, house for each body (Sun, Moon, Mercury, Venus, Mars, Jupiter, Saturn, Uranus, Neptune, Pluto, Chiron; optional Node/Lilith/Vertex).
5. **Angles & houses** â€“ ASC, MC, IC, DC plus 12 house cusps with longitudes and signs.
6. **Aspect table** â€“ rows `{a, b, type, orb_deg, phase, exact}`. Supported aspects: conjunction, opposition, square, trine, sextile (quintile optional).
7. **Transit context** â€“ separate transit aspect table with `transiting_body`, `natal_target`, `orb_deg`, `phase`, `location_context`, optional `exact_hits`. Seismograph rollup uses `{date, magnitude, valence, volatility, drivers[]}`.
8. **JSON + Markdown** â€“ include human-friendly tables and a collapsed block with the full raw JSON payload.

### Default Orb Policy

| Aspect      | Max Orb (deg) |
| ----------- | ------------- |
| Conjunction | 8 |
| Opposition  | 8 |
| Square      | 7 |
| Trine       | 7 |
| Sextile     | 5 |

Moon aspects expand by +1Â°. Outer-to-personal tighten by âˆ’1Â°.

### Supported Bodies

Sun, Moon, Mercury, Venus, Mars, Jupiter, Saturn, Uranus, Neptune, Pluto, Chiron, optional Node, Lilith, Vertex.

### Notes

Missing upstream fields must render placeholders and surface a warning in the provenance block.

---

## âœ… Context & Provenance

### Required Fields
- **Contract ID** + spec version
- **Provenance fields**:
  - `math_brain_version` - Backend version identifier
  - `ephemeris_source` - Astrological data source
  - `build_ts` - Generation timestamp
  - `timezone` - Default Person A timezone
  - `scaling_strategy` + `confidence` - Calculation methodology
- **Relocation flag**: If active, show both natal + relocated frames

---

## âœ… Natal Chart (Person A or B if also selected)

### Required Components
- **Angles**: ASC, DSC, IC, MC
- **Planetary positions**: degrees, sign, house placement
- **Nodes**: True Node primary; South Node auto-inverted
- **Minor bodies**: Lilith + Chiron included by default
- **House cusps** + house meanings
- **Label**: Section titled "Reveal the Weave" (mythic framing)

---

## âœ… Transit Analysis (Solo mode)

### Required Components
- **Current date range**
- **Hooks**: Tight aspects first, orb caps enforced
- **Seismograph summary**: Magnitude, Valence, Volatility metrics
- **Climate Line**: Current snapshot
- **Translation Bridge**: FIELD â†’ MAP â†’ VOICE summary
- **Label**: Section titled "Trace the Threads"

---

## âœ… Relational Modes

### Mandatory Clarification
- **Relationship type**: Partner, Family [relation], Friend/Acquaintance
- **Location context**: Are A & B in the same city now? (affects relocation/transit overlays)
- **Interaction status**: Are they currently interacting?

### Relationship Context Schema (Required for synastry/composite)

#### Primary Categories
- **PARTNER** (romantic / undefined-intimate)
- **FRIEND** (includes colleague)  
- **FAMILY** (kinship connection)

#### Partner Requirements
Must specify intimacy tier:
- **P1**: Platonic partnership (no sexual/romantic expectations)
- **P2**: Friends-with-benefits (sexual, no romantic commitment)
- **P3**: Situationship / undefined (fluid rules/expectations)  
- **P4**: Low-commitment (uneven investment, minimal care)
- **P5a**: Committed romantic + sexual
- **P5b**: Committed romantic, non-sexual

#### Family Requirements  
Must specify role:
- Parent, Offspring, Sibling, Cousin, Extended, Guardian, Mentor, Other, Custom

#### Friend Requirements
Optional role specification:
- Acquaintance, Mentor, Other, Custom

#### Modifiers
- **Ex / Estranged flag**: Valid for PARTNER or FAMILY only (rejected for FRIEND)
- **Notes**: Free-text clarifications (max 500 chars)

### Analysis Types

#### Synastry: Dynamic Interactions
- How Person A's planets vs Person B's planets (activation threads)
- **Woven Map Language**: "Threads" - how Person A's weave pulls on Person B's

#### Composite: Structural Pattern  
- Midpoint chart as "relationship entity"
- **Woven Map Language**: "Weave" - the joint tapestry the two create together

Both modes can include transit overlays.

---

## âœ… Scaling & Filtering

### Required Metrics
- **Scaling confidence** + strategy (prior, blended, rolling)
- **Volatility index**: Dispersion of hook weights
- **Rejection taxonomy**: OUT_OF_CAP, DUPLICATE_PAIR, DIVERSITY_FILTERED, etc.
- **Orb caps enforced**: 8Â° luminaries, 6Â° inner planets, 5Â° outer, 4Â° minor points

---

## âœ… Special Handling

### Technical Requirements
- **Retrograde flags**: Explicit, with "revision/re-threading" nuance if â‰¥2 hooks
- **Node preference**: True Node primary; Mean Node fallback noted
- **Station sensitivity**: 0.2Â° precision
- **Relocation**: Dual-frame support when enabled

### Relocation Implementation
- **Default**: Both Person A and Person B relocated to same location when Person B present
- **Optional exclusion**: Checkbox to exclude Person B from relocation
- **Panama City, FL default**: 30Â°10'N, 85Â°40'W with user override capability
- **Persistence**: localStorage preference for auto-application (opt-in)

---

## âœ… Validation & Error Handling

### API Validation
Backend validates relationship context for synastry/composite modes:
- Returns `400 REL_CONTEXT_INVALID` with specific issues if malformed
- Injects sanitized `relationship` block into successful responses

### Frontend Validation  
Form prevents submission with missing required fields:
- Relationship type required for synastry/composite modes
- Intimacy tier required for PARTNER type
- Family role required for FAMILY type
- Ex/Estranged flag validation (not allowed for FRIEND)

---

## âœ… Glossary Injection

### Auto-append for Clarity (when not using Raven Calder GPT)
- **Weave**: Natal structural pattern
- **Threads**: Active transits tugging natal vectors  
- **Currents**: Aggregate symbolic pressures
- **Seismograph**: Magnitude / Valence / Volatility snapshot (never first priority in interpretation)

---

## ðŸ“‹ Implementation Status

### âœ… Completed
- Backend relationship context validation
- OpenAPI schema updates with RelationshipContextModel
- Frontend form enhancements with all intimacy tiers and roles
- Validation preventing submission with missing required fields
- Test suite verifying all validation scenarios
- Relocation dual-frame support with persistence
- Dynamic explanatory labels for relocation state

### ðŸ”„ In Progress
- Report generation integration with relationship context
- Seismograph summary display optimization

### ðŸ“‹ Pending
- Automated runtime assertions for relocation effect validation
- Modal or repositioning UI variants (if requested)

---

## ðŸŽ¯ Summary

The report must:
1. **Ground itself** in provenance + math
2. **Provide natal weave** and/or relational frame with validated context
3. **Show transit threads** + seismograph with filtering
4. **Auto-glossary** injection in Markdown output
5. **Validate relationship requirements** for synastry/composite modes
6. **Support relocation overlays** with clear state management

This ensures consistent, complete astrological analysis across all supported modes while maintaining the Raven Calder system's geometric-first, falsifiable approach.
