<!DOCTYPE html>
<html>
<head>
    <title>Transit Debug Test</title>
</head>
<body>
    <h1>Transit API Debug Test</h1>
    <button onclick="testTransitAPI()">Test Transit API</button>
    <div id="results" style="margin-top: 20px; white-space: pre-line;"></div>

    <script>
        async function testTransitAPI() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = 'Testing transit API...';
            
            const testData = {
                personA: {
                    name: "DH Cross",
                    city: "New York",
                    nation: "US",
                    year: 1990,
                    month: 6,
                    day: 15,
                    hour: 12,
                    minute: 0,
                    latitude: 40.7128,
                    longitude: -74.0060,
                    zodiac_type: "Tropic",
                    timezone: "America/New_York"
                },
                context: {
                    mode: "natal-transits",
                    relationship_type: "self",
                    intimacy_tier: "P1"
                },
                transit: {
                    startDate: "2025-08-22",
                    endDate: "2025-08-22",
                    step: "1d"
                }
            };
            
            try {
                console.log('Sending request to backend:', testData);
                
                const response = await fetch('/.netlify/functions/astrology-mathbrain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                console.log('Backend response:', result);
                
                let output = 'API RESPONSE RECEIVED\n\n';
                
                // Check for error
                if (result.error) {
                    output += `‚ùå ERROR: ${result.error}\n`;
                    output += `Details: ${JSON.stringify(result, null, 2)}`;
                    resultsDiv.textContent = output;
                    return;
                }
                
                // Success case
                output += '‚úÖ SUCCESS!\n\n';
                output += `Person A has transitsByDate: ${!!(result.person_a?.chart?.transitsByDate)}\n`;
                
                if (result.person_a?.chart?.transitsByDate) {
                    const dates = Object.keys(result.person_a.chart.transitsByDate);
                    output += `Transit dates available: ${dates.join(', ')}\n`;
                    
                    dates.forEach(date => {
                        const dayData = result.person_a.chart.transitsByDate[date];
                        const aspectCount = dayData?.aspects?.length || 0;
                        output += `  ${date}: ${aspectCount} aspects\n`;
                        
                        if (aspectCount > 0) {
                            dayData.aspects.forEach((aspect, i) => {
                                const bodyA = aspect.p1_name || "?";
                                const bodyB = aspect.p2_name || "?";
                                const aspectName = aspect.aspect || "?";
                                const orb = Math.abs(aspect.orbit || aspect.orb || 0).toFixed(1);
                                output += `    ${i+1}. ${bodyA} ${aspectName} ${bodyB} (${orb}¬∞ orb)\n`;
                            });
                        }
                    });
                } else {
                    output += 'No transitsByDate found\n';
                }
                
                // Test the frontend filtering logic too
                const startDate = "2025-08-22";
                const endDate = "2025-08-22";
                if (result.person_a?.chart?.transitsByDate) {
                    const transits = result.person_a.chart.transitsByDate;
                    const relevantDates = Object.keys(transits).filter(date => {
                        return date >= startDate && date <= endDate;
                    }).sort();
                    
                    output += `\nüîç Frontend filtering test:\n`;
                    output += `  Date range: ${startDate} to ${endDate}\n`;
                    output += `  Relevant dates found: ${relevantDates.length} (${relevantDates.join(', ')})\n`;
                    
                    if (relevantDates.length > 0) {
                        output += `  ‚úÖ This should show transits in the report!\n`;
                    } else {
                        output += `  ‚ùå No relevant dates - would show "No significant transits found"\n`;
                    }
                }
                
                resultsDiv.textContent = output;
            } catch (error) {
                console.error('Test failed:', error);
                resultsDiv.textContent = `FETCH ERROR: ${error.message}`;
            }
        }
    </script>
</body>
</html>