<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Eldritch GM Tool Suite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* General Body and Theming */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a2327;
            color: #e0e0e0;
        }

        h1, h2 {
            text-align: center;
            color: #4CAF50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Tab Navigation */
        .tab-nav {
            overflow: hidden;
            background-color: #2c3e50;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-nav button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: #e0e0e0;
            font-size: 1em;
            flex-grow: 1;
        }

        .tab-nav button:hover {
            background-color: #45a049;
        }

        .tab-nav button.active {
            background-color: #4CAF50;
        }

        /* Tab Content Panes */
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            background-color: #2c3e50;
        }

        /* General Form Styling */
        label {
            display: block;
            margin-bottom: 5px;
            color: #4CAF50;
            font-weight: bold;
        }

        select, input[type="text"], input[type="number"], button {
            font-size: 1em;
            padding: 10px;
            margin: 5px 0 15px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            background-color: #1a2327;
            color: #e0e0e0;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            font-weight: bold;
            text-transform: uppercase;
        }

        button:hover {
            background-color: #45a049;
        }

        /* Sliders */
        .slider-container {
            margin-bottom: 20px;
        }
        .slider {
            width: 100%;
            -webkit-appearance: none;
            height: 15px;
            border-radius: 5px;
            background: #5a6b7c;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
        }
        .slider:hover {
            opacity: 1;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        /* Checkboxes */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .checkbox-container input {
            width: auto;
            margin-right: 10px;
        }
        .checkbox-container label {
            font-weight: normal;
            margin: 0;
        }

        /* Output Areas */
        #encounterOutput, #character-output, #battlePhaseOutput, #monsterHPOutput {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            border: 1px solid #4CAF50;
            padding: 15px;
            margin-top: 20px;
            background-color: #0a0f0d;
            color: #e0e0e0;
            border-radius: 8px;
            line-height: 1.6;
            min-height: 100px;
        }
        
        /* Battle Phase Specific */
        .combatant-list ul, .defeated-list ul {
            list-style-type: none;
            padding: 0;
        }
        .combatant-list li, .defeated-list li {
            background-color: #1a2327;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .defeated-list li {
            background-color: #4a2c2c;
            border-left-color: #a04545;
        }
        .input-group-half {
            width: 48%;
            display: inline-block;
        }
        .input-group-half:first-child {
            margin-right: 4%;
        }
        .hidden { display: none; }

        /* Styles from new Character Generator */
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
          animation: fadeIn 0.5s ease-out forwards;
        }
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .custom-alert-box {
            background-color: #2c3e50;
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid #4CAF50;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 90%;
            width: 400px;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .custom-alert-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
         .custom-alert-overlay.visible .custom-alert-box {
            transform: scale(1);
        }
        #character-output .card {
             background-color: #1a2327;
             padding: 1.5rem;
             border-radius: 1rem;
             border: 1px solid #4CAF50;
             color: #e0e0e0;
        }
        #character-output h2, #character-output h3 {
            color: #4CAF50;
        }
        #character-output .text-gray-500 { color: #9ab; }
        #character-output .bg-gray-50 { background-color: #2c3e50; }
        #character-output .bg-blue-50 { background-color: #2c3e50; border: 1px solid #45a049; }
        #character-output .text-gray-800, #character-output .text-gray-900 { color: #e0e0e0; }
        #character-output .list-disc { list-style-position: inside; }
        #character-output .columns-2 { column-count: 2; }
    </style>
</head>
<body>

    <h1>Eldritch GM Tool Suite</h1>

    <div class="tab-nav">
        <button class="tab-link active" onclick="openTool(event, 'EncounterGenerator')">Encounter Generator</button>
        <button class="tab-link" onclick="openTool(event, 'CharacterGenerator')">Character Generator</button>
        <button class="tab-link" onclick="openTool(event, 'BattleCalculator')">Battle Calculator</button>
        <button class="tab-link" onclick="openTool(event, 'MonsterHP')">Monster HP</button>
    </div>

    <!-- Encounter Generator Tab -->
    <div id="EncounterGenerator" class="tab-content" style="display: block;">
        <h2>Advanced Encounter Generator</h2>
        
        <div class="slider-container">
            <label for="partySize">Party Size: <span id="partySizeValue">4</span></label>
            <input type="range" id="partySize" min="1" max="4" value="4" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="slider-container">
            <label for="defenseLevel">Party Defense Level: <span id="defenseLevelValue">Practitioner</span></label>
            <input type="range" id="defenseLevel" min="1" max="5" value="1" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="slider-container">
            <label for="difficulty">Desired Difficulty: <span id="difficultyValue">Moderate</span></label>
            <input type="range" id="difficulty" min="1" max="6" value="2" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="slider-container">
            <label for="nonMediumPercentage">Non-Medium Size %: <span id="nonMediumPercentageValue">10</span>%</label>
            <input type="range" id="nonMediumPercentage" min="0" max="100" value="10" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="slider-container">
            <label for="nonMundanePercentage">Non-Mundane Nature %: <span id="nonMundanePercentageValue">20</span>%</label>
            <input type="range" id="nonMundanePercentage" min="0" max="100" value="20" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="slider-container">
            <label for="specialTypePercentage">Fast/Tough Creature %: <span id="specialTypePercentageValue">30</span>%</label>
            <input type="range" id="specialTypePercentage" min="0" max="100" value="30" class="slider" oninput="updateSliderValues()">
        </div>

        <div class="checkbox-container">
            <label><input type="checkbox" name="creatureTypes" value="Minor" checked> Minor</label>
            <label><input type="checkbox" name="creatureTypes" value="Standard" checked> Standard</label>
            <label><input type="checkbox" name="creatureTypes" value="Exceptional" checked> Exceptional</label>
            <label><input type="checkbox" name="creatureTypes" value="Legendary"> Legendary</label>
        </div>

        <button onclick="generateEncounter()">Generate Encounter</button>

        <div id="encounterOutput"></div>
    </div>

    <!-- Character Generator Tab -->
    <div id="CharacterGenerator" class="tab-content">
        <h2>Detailed Character Generator</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div>
              <label for="race">Race</label>
              <select id="race"></select>
            </div>
            <div>
              <label for="class">Class</label>
              <select id="class"></select>
            </div>
            <div>
              <label for="level">Level</label>
              <select id="level"></select>
            </div>
            <div id="magic-path-container" class="hidden">
              <label for="magic-path">Chosen Magic Path</label>
              <select id="magic-path"></select>
            </div>
        </div>
        <div class="checkbox-container" style="margin-top: 1rem;">
            <input type="checkbox" id="magical-item-checkbox">
            <label for="magical-item-checkbox">Iconic Arcane Inheritance (Costs 4 CP)</label>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button id="generate-btn">Generate Character</button>
            <button id="export-md-btn">Export Markdown</button>
            <button id="copy-md-btn">Copy Markdown</button>
        </div>
        <div id="character-output"></div>
    </div>

    <!-- Battle Calculator Tab -->
    <div id="BattleCalculator" class="tab-content">
        <h2>Battle Phase Calculator</h2>
        
        <div class="combatant-form">
            <h3>Add Combatant</h3>

            <div class="checkbox-container">
                <input type="checkbox" id="autoRollToggle" onchange="toggleAutoRoll()">
                <label for="autoRollToggle">Auto-Roll Armor Dice</label>
            </div>

            <label for="combatantType">Combatant Type:</label>
            <select id="combatantType" onchange="toggleFields()">
                <option value="pa">Player Adventurer (PA)</option>
                <option value="npc">Non-Player Character (NPC)</option>
                <option value="qsb">Quick Stat Block (QSB) Creature</option>
            </select>

            <label for="combatantName">Name:</label>
            <input type="text" id="combatantName" placeholder="Enter combatant name">

            <label for="prowess" id="prowessLabel">Prowess Die:</label>
            <select id="prowess">
                <option value="12">d12 (Phase 1)</option>
                <option value="10">d10 (Phase 2)</option>
                <option value="8">d8 (Phase 3)</option>
                <option value="6">d6 (Phase 4)</option>
                <option value="4">d4 (Phase 5)</option>
            </select>
            
            <div id="paFields">
                <label for="reactionFocus">Reaction Focus Bonus:</label>
                <input type="text" id="reactionFocus" placeholder="e.g., 2">
                <label for="spiritPoints">Spirit Points (SP):</label>
                <input type="text" id="spiritPoints" placeholder="e.g., 10">
            </div>

            <div class="input-group-half">
                <label for="adp">Active Defense Pool (ADP):</label>
                <input type="text" id="adp" placeholder="e.g., 22">
            </div>
            <div class="input-group-half">
                <label for="pdp">Passive Defense Pool (PDP):</label>
                <input type="text" id="pdp" placeholder="e.g., 18">
            </div>

            <button onclick="addCombatant()">Add Combatant</button>
        </div>

        <div id="battlePhaseOutput">
             <div class="combatant-list">
                <h3>Active Combatants</h3>
                <ul id="turnOrder"></ul>
            </div>
             <div class="defeated-list">
                <h3>Defeated</h3>
                <ul id="defeatedList"></ul>
            </div>
        </div>
    </div>

    <!-- Monster HP Calculator Tab -->
    <div id="MonsterHP" class="tab-content">
        <h2>Monster HP Calculator</h2>
        
        <label for="monsterNature">Monster Nature:</label>
        <select id="monsterNature">
            <option value="1">Mundane</option>
            <option value="2">Magical</option>
            <option value="3">Preternatural</option>
            <option value="4">Supernatural</option>
        </select>
    
        <label for="monsterSize">Monster Size:</label>
        <select id="monsterSize">
            <option value="0">Minuscule or Tiny</option>
            <option value="1">Small or Medium</option>
            <option value="2">Large</option>
            <option value="3">Huge</option>
            <option value="4">Gargantuan</option>
        </select>

        <label for="threatTier1">Threat Tier 1 (MV):</label>
        <select id="threatTier1">
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
        </select>
         <label for="threatTier2">Threat Tier 2 (MV):</label>
        <select id="threatTier2">
             <option value="0">None</option>
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
        </select>
         <label for="threatTier3">Threat Tier 3 (MV):</label>
        <select id="threatTier3">
             <option value="0">None</option>
            <option value="4">d4</option>
            <option value="6">d6</option>
            <option value="8">d8</option>
            <option value="10">d10</option>
            <option value="12">d12</option>
        </select>

        <button onclick="calculateMonsterHP()">Calculate Hit Points</button>
        <div id="monsterHPOutput"></div>
    </div>

    <!-- Custom Alert Box HTML -->
    <div id="custom-alert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <p id="custom-alert-message"></p>
            <button id="custom-alert-close">OK</button>
        </div>
    </div>

    <script>
        // --- Tab Management ---
        function openTool(evt, toolName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(toolName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // --- Shared Alert Function ---
        function showAlert(message) {
            const alertOverlay = document.getElementById('custom-alert');
            const alertMessage = document.getElementById('custom-alert-message');
            alertMessage.textContent = message;
            alertOverlay.classList.add('visible');
        }

        // --- Encounter Generator Logic ---
        const difficultyLevels = ['Easy', 'Moderate', 'Difficult', 'Demanding', 'Formidable', 'Deadly'];
        const defenseLevels = ['Practitioner', 'Competent', 'Proficient', 'Advanced', 'Elite'];
        const encounterDifficultyTable = {
            1: { Practitioner: [7,10,12,14,16,18], Competent: [14,20,24,28,32,36], Proficient: [21,29,36,42,48,55], Advanced: [28,39,48,56,64,73], Elite: [35,49,60,70,80,110] },
            2: { Practitioner: [14,20,24,28,32,36], Competent: [28,39,48,56,64,73], Proficient: [42,59,72,84,96,108], Advanced: [56,77,96,112,128,144], Elite: [70,95,120,140,160,190] },
            3: { Practitioner: [21,30,36,42,48,54], Competent: [42,59,72,84,96,108], Proficient: [63,84,108,126,144,162], Advanced: [84,111,144,168,192,216], Elite: [105,140,180,210,240,270] },
            4: { Practitioner: [28,42,50,56,64,72], Competent: [56,77,96,112,128,144], Proficient: [84,111,144,168,192,216], Advanced: [112,147,180,224,256,288], Elite: [140,185,228,280,320,360] }
        };
        const threatDiceByCategory = {
            Minor: ['1d4','1d6','1d8','1d10','1d12'],
            Standard: ['2d4','2d6','2d8','2d10','2d12'],
            Exceptional: ['3d4','3d6','3d8','3d10','3d12'],
            Legendary: ['3d12','3d14','3d16','3d18','3d20']
        };
        const hpMultipliers = {
            'Minuscule': {'Mundane': 0.5, 'Magical': 1, 'Preternatural': 1.5, 'Supernatural': 2},
            'Tiny': {'Mundane': 0.5, 'Magical': 1, 'Preternatural': 1.5, 'Supernatural': 2},
            'Small': {'Mundane': 1, 'Magical': 1.5, 'Preternatural': 2, 'Supernatural': 2.5},
            'Medium': {'Mundane': 1, 'Magical': 1.5, 'Preternatural': 2, 'Supernatural': 2.5},
            'Large': {'Mundane': 1.5, 'Magical': 2, 'Preternatural': 2.5, 'Supernatural': 3},
            'Huge': {'Mundane': 2, 'Magical': 2.5, 'Preternatural': 3, 'Supernatural': 3.5},
            'Gargantuan': {'Mundane': 2.5, 'Magical': 3, 'Preternatural': 3.5, 'Supernatural': 4}
        };

        function updateSliderValues() {
            document.getElementById('partySizeValue').textContent = document.getElementById('partySize').value;
            document.getElementById('defenseLevelValue').textContent = defenseLevels[document.getElementById('defenseLevel').value - 1];
            document.getElementById('difficultyValue').textContent = difficultyLevels[document.getElementById('difficulty').value - 1];
            document.getElementById('nonMediumPercentageValue').textContent = document.getElementById('nonMediumPercentage').value;
            document.getElementById('nonMundanePercentageValue').textContent = document.getElementById('nonMundanePercentage').value;
            document.getElementById('specialTypePercentageValue').textContent = document.getElementById('specialTypePercentage').value;
        }

        function generateEncounter() {
            const partySize = parseInt(document.getElementById('partySize').value);
            const defenseLevel = defenseLevels[document.getElementById('defenseLevel').value - 1];
            const difficulty = parseInt(document.getElementById('difficulty').value);
            const nonMediumPercentage = parseInt(document.getElementById('nonMediumPercentage').value);
            const nonMundanePercentage = parseInt(document.getElementById('nonMundanePercentage').value);
            const specialTypePercentage = parseInt(document.getElementById('specialTypePercentage').value);
            const selectedTypes = Array.from(document.querySelectorAll('input[name="creatureTypes"]:checked')).map(checkbox => checkbox.value);

            if (selectedTypes.length === 0) { showAlert("Please select at least one creature type."); return; }

            const threatScore = encounterDifficultyTable[partySize][defenseLevel][difficulty - 1];
            let output = `ENCOUNTER DETAILS\n=========================\n`;
            output += `Party Size: ${partySize} | Defense Level: ${defenseLevel}\n`;
            output += `Difficulty: ${difficultyLevels[difficulty - 1]} | Total Threat Score: ${threatScore}\n\n`;
            output += `CREATURES\n=========================\n`;

            let remainingThreat = threatScore;
            let monsters = [];
            while (remainingThreat > 5 && monsters.length < 20) { // Safety break
                const monster = generateMonsterForEncounter(remainingThreat, selectedTypes, nonMediumPercentage, nonMundanePercentage, specialTypePercentage);
                if (monster.threatMV > 0) {
                    monsters.push(monster);
                    remainingThreat -= monster.threatMV;
                } else {
                    break; // Prevent infinite loops
                }
            }

            monsters.forEach((monster, index) => {
                output += `Monster ${index + 1}: ${monster.creatureType} ${monster.size} ${monster.nature} ${monster.category}\n`;
                output += `  TD: ${monster.threatDice} (MV: ${monster.threatMV}) | HP: ${monster.hitPoints} (${monster.activeDefense}A/${monster.passiveDefense}P)\n`;
                output += `  ST: ${monster.savingThrow} | BP: ${monster.battlePhase}\n\n`;
            });

            document.getElementById('encounterOutput').textContent = output;
        }
        
        function calculateHitPoints(baseHP, size, nature) {
            const multiplier = hpMultipliers[size][nature];
            return {
                hitPoints: Math.round(baseHP * multiplier),
                multiplier: multiplier
            };
        }

        function generateMonsterForEncounter(maxThreat, selectedTypes, nonMediumPercentage, nonMundanePercentage, specialTypePercentage) {
            const category = selectedTypes[Math.floor(Math.random() * selectedTypes.length)];
            const threatDiceOptions = threatDiceByCategory[category].filter(dice => (parseInt(dice.split('d')[0]) * parseInt(dice.split('d')[1])) <= maxThreat);
            const threatDice = threatDiceOptions.length > 0 ? threatDiceOptions[Math.floor(Math.random() * threatDiceOptions.length)] : threatDiceByCategory[category][0];
            const threatMV = parseInt(threatDice.split('d')[0]) * parseInt(threatDice.split('d')[1]);
            
            const sizes = ['Minuscule', 'Tiny', 'Small', 'Medium', 'Large', 'Huge', 'Gargantuan'];
            let size = 'Medium';
            if (Math.random() * 100 < nonMediumPercentage) {
                const nonMediumSizes = sizes.filter(s => s !== 'Medium');
                size = nonMediumSizes[Math.floor(Math.random() * nonMediumSizes.length)];
            }

            const natures = ['Mundane', 'Magical', 'Preternatural', 'Supernatural'];
            let nature = 'Mundane';
            if (Math.random() * 100 < nonMundanePercentage) {
                const nonMundaneNatures = natures.filter(n => n !== 'Mundane');
                nature = nonMundaneNatures[Math.floor(Math.random() * nonMundaneNatures.length)];
            }

            let creatureType = 'Normal';
            if (Math.random() * 100 < specialTypePercentage) {
                creatureType = Math.random() < 0.5 ? 'Fast' : 'Tough';
            }
            
            const { hitPoints, multiplier } = calculateHitPoints(threatMV, size, nature);
            
            let activeDefense, passiveDefense;
            if (creatureType === 'Fast') {
                activeDefense = Math.round(hitPoints * 0.75);
                passiveDefense = hitPoints - activeDefense;
            } else if (creatureType === 'Tough') {
                passiveDefense = Math.round(hitPoints * 0.75);
                activeDefense = hitPoints - passiveDefense;
            } else {
                activeDefense = Math.round(hitPoints / 2);
                passiveDefense = hitPoints - activeDefense;
            }

            const prowessDie = parseInt(threatDice.split('d')[1]);
            const battlePhase = calculateBattlePhase(prowessDie);
            const savingThrow = `d${4 * (['Minor', 'Standard', 'Exceptional', 'Legendary'].indexOf(category) + 1)}`;
            
            return { category, threatDice, threatMV, size, nature, creatureType, hitPoints, multiplier, activeDefense, passiveDefense, savingThrow, battlePhase };
        }
        
        function calculateBattlePhase(prowessDie) {
            if (prowessDie >= 12) return 1;
            if (prowessDie >= 10) return 2;
            if (prowessDie >= 8) return 3;
            if (prowessDie >= 6) return 4;
            return 5;
        }

        // --- Character Generator Logic ---
        const charGenData = {
            dieRanks: ['d4', 'd6', 'd8', 'd10', 'd12'],
            abilities: ['Competence', 'Prowess', 'Fortitude'],
            specialties: {
              Competence: ['Adroitness', 'Expertise', 'Perception'],
              Prowess: ['Agility', 'Melee', 'Precision'],
              Fortitude: ['Endurance', 'Strength', 'Willpower']
            },
            focuses: {
              Adroitness: ['Skulduggery', 'Cleverness'],
              Expertise: ['Wizardry', 'Theurgy'],
              Perception: ['Alertness', 'Perspicacity'],
              Agility: ['Speed', 'Reaction'],
              Melee: ['Threat', 'Finesse'],
              Precision: ['Ranged Threat', 'Ranged Finesse'],
              Endurance: ['Vitality', 'Resilience'],
              Strength: ['Ferocity', 'Might'],
              Willpower: ['Courage', 'Resistance']
            },
            races: ['Human', 'Elf', 'Dwarf', 'Gnome', 'Half-Elf', 'Half-Orc', 'Halfling', 'Drakkin'],
            classes: ['Adept', 'Assassin', 'Barbarian', 'Mage', 'Mystic', 'Rogue', 'Theurgist', 'Warrior'],
            levels: [1, 2, 3, 4, 5],
            casterClasses: ['Adept', 'Mage', 'Mystic', 'Theurgist'],
            magicPathsByClass: {
              Adept: ['Thaumaturgy', 'Elementalism', 'Sorcery'],
              Mage: ['Thaumaturgy', 'Elementalism', 'Sorcery'],
              Mystic: ['Mysticism'],
              Theurgist: ['Druidry', 'Hieraticism']
            },
            levelInfo: [
              { level: 1, masteryDie: 'd4', usesPerDay: 2, cp_range: '10 to 100' },
              { level: 2, masteryDie: 'd6', usesPerDay: 4, cp_range: '101 to 199' },
              { level: 3, masteryDie: 'd8', usesPerDay: 6, cp_range: '200 to 299' },
              { level: 4, masteryDie: 'd10', usesPerDay: 8, cp_range: '300 to 399' },
              { level: 5, masteryDie: 'd12', usesPerDay: 10, cp_range: '400 to 500+' }
            ],
            raceMinima: {
                Drakkin: { Competence: 'd6', Prowess: 'd6', Fortitude: 'd6', Endurance: 'd6', Strength: 'd4' },
                Dwarf: { Fortitude: 'd8', Endurance: 'd4', Prowess: 'd6', Melee: 'd6' },
                Elf: { Competence: 'd6', Expertise: 'd6', Wizardry: '+1', Prowess: 'd4', Agility: 'd4', Reaction: '+1' },
                Gnome: { Competence: 'd4', Adroitness: 'd6', Expertise: 'd6', Perception: 'd4', Perspicacity: '+1' },
                'Half-Elf': { Competence: 'd6', Prowess: 'd6', Agility: 'd4', Fortitude: 'd4', Endurance: 'd4', Willpower: 'd4' },
                'Half-Orc': { Fortitude: 'd6', Strength: 'd8', Ferocity: '+1', Endurance: 'd6' },
                Halfling: { Competence: 'd6', Adroitness: 'd6', Cleverness: '+1', Fortitude: 'd6', Willpower: 'd4', Courage: '+1' },
                Human: { Competence: 'd6', Prowess: 'd6', Melee: 'd4', Threat: '+1', Fortitude: 'd4', Willpower: 'd6' }
            },
            classMinima: {
                Adept: { Competence: 'd6', Adroitness: 'd4', Cleverness: '+1', Expertise: 'd6', Wizardry: '+1', Perception: 'd4', Perspicacity: '+1' },
                Assassin: { Competence: 'd4', Adroitness: 'd6', Perception: 'd4', Prowess: 'd4', Agility: 'd4', Endurance: 'd6', Melee: 'd4', Finesse: '+1' },
                Barbarian: { Prowess: 'd6', Melee: 'd8', Fortitude: 'd4', Strength: 'd4', Ferocity: '+1' },
                Mage: { Competence: 'd6', Expertise: 'd8', Wizardry: '+1', Fortitude: 'd4', Willpower: 'd6', Resistance: '+1' },
                Mystic: { Competence: 'd6', Expertise: 'd6', Wizardry: '+1', Prowess: 'd4', Melee: 'd4', Fortitude: 'd4', Endurance: 'd6', Resilience: '+1', Vitality: '+2' },
                Rogue: { Competence: 'd4', Adroitness: 'd4', Skulduggery: '+1', Perception: 'd4', Prowess: 'd6', Agility: 'd8' },
                Theurgist: { Competence: 'd8', Expertise: 'd4', Theurgy: '+1', Fortitude: 'd6', Willpower: 'd4' },
                Warrior: { Prowess: 'd8', Melee: 'd6', Threat: '+1', Fortitude: 'd6' }
            },
            allAdvantages: {
              Human: ['Fortunate', 'Survival'], Elf: ['Night Vision', 'Gift of Magic', 'Magic Resistance (+1)'], Dwarf: ['Night Vision', 'Strong-willed', 'Sense of Direction'], Gnome: ['Eidetic Memory', 'Low-Light Vision', 'Observant'], 'Half-Elf': ['Heightened Senses', 'Low-Light Vision', 'Magic Resistance (+1)'], 'Half-Orc': ['Low-light Vision', 'Intimidation', 'Menacing'], Halfling: ['Low Light Vision', 'Read Emotions', 'Resilient'], Drakkin: ['Natural Armor', 'Breath Weapon', 'Night Vision'],
              Adept: ['Arcanum', 'Gift of Magic', 'Literacy', 'Scholar'], Assassin: ['Expeditious', 'Heightened Senses (hearing)', 'Observant', 'Read Emotions'], Barbarian: ['Animal Affinity', 'Brutishness', 'Menacing', 'Resilient'], Mage: ['Arcanum', 'Gift of Magic', 'Magic Defense', 'Scholar'], Mystic: ['Empathic', 'Gift of Magic', 'Intuitive', 'Magic Resistance (Lesser)', 'Strong-Willed'], Rogue: ['Expeditious', 'Fortunate', 'Streetwise', 'Underworld Contacts'], Theurgist: ['Gift of Magic', 'Magic Defense', 'Religion', 'Strong-Willed'], Warrior: ['Commanding', 'Intimidation', 'Magic Resistance (+1)', 'Tactician']
            },
            classFeats: {
              Adept: ['Guile', 'Lore', 'Ritual Magic', 'Quick-witted'], Assassin: ['Death Strike', 'Lethal Exploit', 'Ranged Ambush', 'Shadow Walk'], Barbarian: ['Berserk', 'Brawl', 'Feat of Strength', 'Grapple'], Mage: ['Arcane Finesse', 'Dweomers', 'Intangible Threat', 'Path Mastery'], Mystic: ['Iron Mind', 'Path Mastery', 'Premonition', 'Psychic Powers'], Rogue: ['Backstab', 'Evasion', 'Roguish Charm', 'Stealth'], Theurgist: ['Divine Healing', 'Path Mastery', 'Spiritual Smite', 'Supernatural Intervention'], Warrior: ['Battle Savvy', 'Maneuvers', 'Stunning Reversal', 'Sunder Foe']
            },
            costToRankUpDie: { 'd4': 6, 'd6': 8, 'd8': 10, 'd10': 12, 'd12': Infinity },
            costToRankUpFocus: 4,
            cumulativeDieCost: { 'd4': 4, 'd6': 10, 'd8': 18, 'd10': 28, 'd12': 40 },
            spellsByPath: {
                AllPaths: { Common: ['Dispel Effect', 'Identify Magic', 'Eldritch Bolt', 'Eldritch Defense'], },
                Elementalism: { Common: ['Air Bubble', 'Ball of Light', 'Boil Water', 'Breeze', 'Charge of the Elements', 'Cleanse Air', 'Crystal Vision', 'Drown', 'Energy Jump', 'Energy Pulse', 'Extinguish Flames', 'Fire Strike', 'Fire Trail', 'Flame Creature', 'Flame Fists', 'Flame Weapon', 'Forge From Stone', 'Freeze', 'Fresh Air', 'Fuel Flames', 'Halo of Energy', 'Heat', 'Illuminating Insight', 'Luminous Wave', 'Mineral Analysis', 'Kinetic Augmentation', 'Rain', 'Resist Elements', 'Rocky Terrain', 'Safe Descent', 'Sense Air Currents', 'Steal Breath', 'Tremor Sense', 'Water Breathing', 'Water Streaming', 'Water Vortex', 'Water Ward', 'Water Whip', 'Zephyr Mind'], Uncommon: ['Arcane Maelstrom', 'Crystal Enhancement', 'Crystalize Earth', 'Disorienting Gale', 'Energy Drain', 'Energy Leech', 'Energy Surge', 'Energy Transference', 'Fire Whip', 'Fissure', 'Healing Waters', 'Heatwave', 'Ice Blade', 'Ignite', 'Rend Walls', 'Stone Shape', 'Stone Shatter', 'Water Elemental', 'Water Illusion', 'Water Prison', 'Water Walk', 'Windwalk'], Esoteric: ['Air Pocket', 'Aquatic Summons', 'Crystal Analysis', 'Crystal Growth', 'Crystalize Object', 'Diamond Strike', 'Earth Kin', 'Energy Conversion', 'Energy Beacon', 'Energy Infusion', 'Energy Leech', 'Fire Armor', 'Fire Elemental', 'Flame Grasp', 'Ice Shield', 'Minor Earthquake', 'Propel', 'Purify Water', 'Quartz Shield', 'Sky Shelter', 'Skywalk', 'Stone Armor', 'Stone Skin', 'Water Breathing', 'Whirlpool', 'Whirlwind Prison'], Occult: ['Aeromancy', 'Choking Vacuum', 'Energy Surge', 'Ethereal Pulse', 'Flame Trap', 'Liquid Armor', 'Stone Golem', 'Stone Weapon', 'Whelm', 'Whirlwind', 'Wind Rush'], Legendary: ['Crystal Fortress', 'Earth Merge', 'Elemental Form', 'Energy Blade', 'Glacial Prison', 'Quicksand', 'Tidal Surge', 'Wind Riding'] },
                Sorcery: { Common: ['Arcane Lock', 'Arcane Mark', 'Minor Illusion', 'Olfactory Illusion', 'Shadow Step', 'Teleport Object', 'Transmute Rock'], Uncommon: ['Audio Illusion', 'Chameleon', 'Dustify', 'Enfeeblement', 'Flux Portal', 'Illusory Disguise', 'Phantom Blade', 'Summon Monster'], Esoteric: ['Apport Object', 'Cone of Silence', 'Full Body Illusion', 'Illusory Quiescence', 'Minion Horde', 'Object Space', 'Phantasms', 'Transdimensional Shift'], Occult: ['Dimensional Travel', 'Havoc', 'Mirrored Opponent', 'Teleport Self', 'Waking Terror', 'Whisper of Woe'], Legendary: ['Apport Creature', 'Assume Inanimate Form', 'Dreamscape', 'Mass Invisibility'] },
                Thaumaturgy: { Common: ['Banish', 'Claw Growth', 'Conjure Weapon', 'Echo', 'Fortify Object', 'Lighten', 'Magic Ride', 'Mend', 'Savorless', 'Sharpen Blade', 'Weaken Creature', 'Weaken Object'], Uncommon: ['Contingent Notification', 'Create Illusion', 'Dimensional Pocket', 'Forced Egress', 'Invisibility', 'Mana Burst', 'Phantom Steed', 'Quickened Reflexes', 'Strengthen Creature', 'Weapon Readiness'], Esoteric: ['Dance of Blades', 'Elemental Transmutation', 'Illusionary Clone', 'Levitation', 'Manipulate Object', 'Spatial Warp', 'Transmute Flesh'], Occult: ['Deafness', 'Discordance', 'Loop Time', 'Matter Fusion', 'Monster Form', 'Temporal Rift'], Legendary: ['Alter Age', 'Blindness', 'Demolish', 'Initiative Warp', 'Petrify', 'Stand Still', 'Time Halt'] },
                Mysticism: { Common: ['Confusion', 'Detect Magic', 'Ethereal Sight', 'Levitation', 'Mindfulness', 'Phase Shift', 'Silence', 'Soothing Balm', 'Soothing Mists'], Uncommon: ['Discern Soul', 'Mind Shield', 'Object Read', 'Mind Blade', 'See Aura', 'See Invisible', 'Sense Power', 'Sixth Sense'], Esoteric: ['Cosmic Shift', 'Fathom', 'Mind Read', 'Mystic Lore', 'Premonition', 'Psychic Beacon', 'Reassemble', 'Shadow Walk'], Occult: ['Continuous Shadow', 'Dreamwalk', 'Ethereal Projection', 'Foreknowledge', 'Manipulate Shadow', 'Release Mind'], Legendary: ['Control Humanoid', 'Form of Night', 'Hypnotic Suggestion', 'Induce Sleep', 'Mind Control', 'Super Intuition'] },
                Hieraticism: { Common: ['Aura of Restoration', 'Blessing of Renewal', 'Entreaty of Mercy', 'Heal', 'Repel Undead', 'Soothe Self', 'Word of Cleansing'], Uncommon: ['Consecrate Ground', 'Healing Aura', 'Banish Undead', 'Blessing of Health', 'Dispel Magic', 'Nullify Poison', 'Recovery of the Unready', 'Soothe Ally', 'Soul Transfer'], Esoteric: ['Doomsday Premonition', 'Mystical Regeneration', 'Rejuvenate', 'Remove Curse', 'Unbind Spirit'], Occult: ['Desolate Curse', 'Entreat Entity', 'Omniscient Eye', 'Soul Transmutation'], Legendary: ['Create Undead', 'Commune with the Dead', 'Regeneration', 'Summon Spirit'] },
                Druidry: { Common: ['Blossom/Wither Plants', 'Branch to Staff', 'Commune with Plants', 'Ears of the Bat', 'Entangling Roots', 'Eyes of the Eagle', 'Nose of the Wolf', 'Plant Growth', 'Rose Whip', 'Summon Animal'], Uncommon: ['Animate Flora', 'Bramble Wall', 'Control Animal', 'Gust', 'Healing Grove', 'Seizing Plants', 'Shape Wood', 'Shapeshift', 'Wild Growth'], Esoteric: ['Plant Automaton', 'Plant Meld', 'Regrowth', 'Speak with Nature', 'Tangle Trap', 'Thorny Shield'], Occult: ['Animal Transformation', 'Might of the Oak', 'Nature\'s Blessing', 'Plant Armor', 'Plant Behemoth'], Legendary: ['Magical Transformation', 'Plant Mastery'] }
            }
        };
        
        function populateCharacterGeneratorDropdowns() {
            const raceSelect = document.getElementById('race');
            const classSelect = document.getElementById('class');
            const levelSelect = document.getElementById('level');
            
            raceSelect.innerHTML = '<option value="">Select Race</option>' + charGenData.races.map(r => `<option value="${r}">${r}</option>`).join('');
            classSelect.innerHTML = '<option value="">Select Class</option>' + charGenData.classes.map(c => `<option value="${c}">${c}</option>`).join('');
            levelSelect.innerHTML = '<option value="">Select Level</option>' + charGenData.levels.map(l => `<option value="${l}">${l}</option>`).join('');

            classSelect.addEventListener('change', () => {
                const selectedClass = classSelect.value;
                const magicPathContainer = document.getElementById('magic-path-container');
                const magicPathSelect = document.getElementById('magic-path');
                
                if (charGenData.magicPathsByClass[selectedClass] && selectedClass !== 'Adept' && selectedClass !== 'Mystic') {
                  magicPathContainer.classList.remove('hidden');
                  magicPathSelect.innerHTML = '<option value="">-- Select Path --</option>' + charGenData.magicPathsByClass[selectedClass].map(p => `<option value="${p}">${p}</option>`).join('');
                } else {
                  magicPathContainer.classList.add('hidden');
                  magicPathSelect.innerHTML = '';
                }
            });
        }

        function generateCharacter() {
            const race = document.getElementById('race').value;
            const characterClass = document.getElementById('class').value;
            const level = parseInt(document.getElementById('level').value);
            const isMagicalItem = document.getElementById('magical-item-checkbox').checked;
            let magicPath = document.getElementById('magic-path').value;

            if (!race || !characterClass || isNaN(level)) { showAlert("Please select a valid race, class, and level."); return; }

            let character = { race, class: characterClass, level, abilities: {}, specialties: {}, focuses: {} };
            
            charGenData.abilities.forEach(a => {
                character.abilities[a] = 'd4';
                character.specialties[a] = {};
                character.focuses[a] = {};
                charGenData.specialties[a].forEach(sp => {
                    character.specialties[a][sp] = 'd4';
                    charGenData.focuses[sp].forEach(fx => { character.focuses[a][fx] = '+0'; });
                });
            });

            const applyMinima = (minima) => {
                Object.entries(minima).forEach(([key, val]) => {
                    if (charGenData.abilities.includes(key)) {
                        if (charGenData.dieRanks.indexOf(val) > charGenData.dieRanks.indexOf(character.abilities[key])) character.abilities[key] = val;
                    } else {
                        const parentAbility = Object.keys(charGenData.specialties).find(a => charGenData.specialties[a].includes(key));
                        const parentSpecialty = Object.keys(charGenData.focuses).find(sp => charGenData.focuses[sp].includes(key));
                        if (parentAbility) {
                            if (charGenData.dieRanks.indexOf(val) > charGenData.dieRanks.indexOf(character.specialties[parentAbility][key])) character.specialties[parentAbility][key] = val;
                        } else if (parentSpecialty) {
                            const focusParentAbility = Object.keys(charGenData.specialties).find(a => charGenData.specialties[a].includes(parentSpecialty));
                            if (parseInt(val.replace('+', '')) > parseInt((character.focuses[focusParentAbility][key] || '+0').replace('+', ''))) character.focuses[focusParentAbility][key] = val;
                        }
                    }
                });
            };

            applyMinima(charGenData.raceMinima[race] || {});
            applyMinima(charGenData.classMinima[characterClass] || {});

            let remainingCPs = 10 + (level - 1) * 100;
            if (isMagicalItem) remainingCPs -= 4;
            
            const upgradeOrder = {
                'Warrior': ['Prowess', 'Melee', 'Strength', 'Fortitude', 'Precision', 'Endurance', 'Threat', 'Might', 'Ranged Threat'],
                'Barbarian': ['Prowess', 'Melee', 'Strength', 'Fortitude', 'Endurance', 'Ferocity', 'Might', 'Vitality'],
                'Rogue': ['Prowess', 'Agility', 'Competence', 'Adroitness', 'Perception', 'Skulduggery', 'Cleverness', 'Speed'],
                'Assassin': ['Prowess', 'Agility', 'Melee', 'Competence', 'Adroitness', 'Finesse', 'Speed', 'Perception'],
                'Mage': ['Competence', 'Expertise', 'Wizardry', 'Fortitude', 'Willpower', 'Resistance', 'Perception'],
                'Mystic': ['Fortitude', 'Willpower', 'Competence', 'Expertise', 'Endurance', 'Prowess', 'Melee', 'Resilience', 'Vitality'],
                'Adept': ['Competence', 'Expertise', 'Adroitness', 'Perception', 'Cleverness', 'Wizardry', 'Perspicacity'],
                'Theurgist': ['Competence', 'Expertise', 'Theurgy', 'Fortitude', 'Willpower', 'Endurance', 'Courage']
            };

            for (const upgradeKey of upgradeOrder[characterClass]) {
                while (true) {
                    let updated = false;
                    if (charGenData.abilities.includes(upgradeKey)) {
                        const currentRank = character.abilities[upgradeKey];
                        const cost = charGenData.costToRankUpDie[currentRank];
                        if (currentRank !== 'd12' && remainingCPs >= cost) {
                            character.abilities[upgradeKey] = charGenData.dieRanks[charGenData.dieRanks.indexOf(currentRank) + 1];
                            remainingCPs -= cost;
                            updated = true;
                        }
                    } else if (Object.values(charGenData.specialties).flat().includes(upgradeKey)) {
                        const parentAbility = Object.keys(charGenData.specialties).find(a => charGenData.specialties[a].includes(upgradeKey));
                        const currentRank = character.specialties[parentAbility][upgradeKey];
                        const cost = charGenData.costToRankUpDie[currentRank];
                        if (currentRank !== 'd12' && remainingCPs >= cost) {
                            character.specialties[parentAbility][upgradeKey] = charGenData.dieRanks[charGenData.dieRanks.indexOf(currentRank) + 1];
                            remainingCPs -= cost;
                            updated = true;
                        }
                    } else {
                        const parentSpecialty = Object.keys(charGenData.focuses).find(sp => charGenData.focuses[sp].includes(upgradeKey));
                        const parentAbility = Object.keys(charGenData.specialties).find(a => charGenData.specialties[a].includes(parentSpecialty));
                        let currentVal = parseInt((character.focuses[parentAbility][upgradeKey] || '+0').replace('+', ''));
                        if (currentVal < 5 && remainingCPs >= charGenData.costToRankUpFocus) {
                            character.focuses[parentAbility][upgradeKey] = `+${currentVal + 1}`;
                            remainingCPs -= charGenData.costToRankUpFocus;
                            updated = true;
                        }
                    }
                    if (!updated) break;
                }
            }
            
            character.cpBreakdown = calculateCPBreakdown(character);
            let actualLevel = 1;
            for (let i = charGenData.levelInfo.length - 1; i >= 0; i--) {
                const levelData = charGenData.levelInfo[i];
                const minCP = parseInt(levelData.cp_range.split(' ')[0]);
                if (character.cpBreakdown.total >= minCP) {
                    actualLevel = levelData.level;
                    break;
                }
            }
            character.level = actualLevel;
            character.masteryDie = charGenData.levelInfo[actualLevel - 1].masteryDie;
            character.defensePools = calculateDefensePools(character);
            character.equipment = getStartingEquipment(race, characterClass);
            const { advantages, duplicateAdvantage } = getAdvantagesWithBonus(race, characterClass);
            character.advantages = advantages;
            if (isMagicalItem) character.advantages.push('Iconic Arcane Inheritance');
            character.flaws = getFlaws(race, characterClass);
            character.classFeats = charGenData.classFeats[characterClass] ? [...charGenData.classFeats[characterClass]] : [];
            
            if (charGenData.casterClasses.includes(characterClass)) {
                const compSteps = charGenData.dieRanks.indexOf(character.abilities.Competence);
                const expSteps = charGenData.dieRanks.indexOf(character.specialties.Competence.Expertise);
                let knownCount = 2 * (compSteps + expSteps);
                if(characterClass === 'Adept') knownCount = Math.floor(knownCount / 2);
                
                character.spellcasting = {
                  masteryPath: 'N/A',
                  pathSpecialization: null,
                  knownSpells: [],
                  knownSpellsCount: knownCount
                };

                const paths = charGenData.magicPathsByClass[characterClass];
                character.spellcasting.masteryPath = characterClass === 'Adept' ? 'Arcanum' : paths.join(', ');
                if (characterClass === 'Mage' || characterClass === 'Theurgist') {
                    character.spellcasting.pathSpecialization = magicPath || paths[0];
                    const featIndex = character.classFeats.indexOf('Path Mastery');
                    if (featIndex !== -1) character.classFeats[featIndex] = `Path Mastery (${character.spellcasting.pathSpecialization})`;
                } else if (characterClass === 'Mystic') {
                    character.spellcasting.pathSpecialization = 'Mysticism';
                }
                character.spellcasting.knownSpells = generateSpellList(character);
            }
            
            window.lastCharacter = character;
            displayCharacter(character);
        }

        function calculateCPBreakdown(character) {
            let abilitiesCP = 0, specialtiesCP = 0, focusesCP = 0;
            charGenData.abilities.forEach(a => {
                abilitiesCP += charGenData.cumulativeDieCost[character.abilities[a]] || 0;
                Object.values(character.specialties[a]).forEach(spDie => { specialtiesCP += charGenData.cumulativeDieCost[spDie] || 0; });
                Object.values(character.focuses[a]).forEach(fxVal => { focusesCP += parseInt((fxVal || '+0').replace('+', '')) * charGenData.costToRankUpFocus; });
            });
            const baseCP = 10;
            const advantageCP = document.getElementById('magical-item-checkbox').checked ? 4 : 0;
            return { base: baseCP, abilitiesCP, specialtiesCP, focusesCP, advantageCP, total: baseCP + abilitiesCP + specialtiesCP + focusesCP + advantageCP };
        }

        function calculateDefensePools(character) {
            const getMV = (val) => val.startsWith('d') ? parseInt(val.substring(1)) : 0;
            const { abilities, specialties } = character;
            return {
                activeDefense: getMV(abilities.Prowess) + getMV(specialties.Prowess.Agility) + getMV(specialties.Prowess.Melee),
                passiveDefense: getMV(abilities.Fortitude) + getMV(specialties.Fortitude.Endurance) + getMV(specialties.Fortitude.Strength),
                spiritPoints: getMV(abilities.Competence) + getMV(specialties.Fortitude.Willpower)
            };
        }

        function getStartingEquipment(race, characterClass) {
            const commonEq = ['Set of ordinary clothes', 'Purse of 5 gold coins', 'Backpack', 'Small dagger', 'Weekâ€™s rations', 'Waterskin', 'Tinderbox', '50\' rope', 'Iron spikes', 'Small hammer', '6\' traveling staff or 10\' pole', 'Hooded lantern and 2 oil flasks or d4+1 torches'];
            const classEq = {
                Adept: ['Book of knowledge (area of expertise)'], Assassin: ['Assassin hood, jacket, cape, robe, or tunic'], Barbarian: ['Garments of woven wool or linen', 'Tunic', 'Overcoat or cloak'], Mage: ['Spellbook', 'Staff or focus item'], Mystic: ['Robes or shawl', 'Cloak', 'Armor up to leather'], Rogue: ['Set of thieves\' tools', 'Light armor (up to leather)', 'One weapon'], Theurgist: ['Prayer book', 'Holy relic or symbol', 'Focus item', 'Armor up to chain'], Warrior: ['One weapon of choice', 'Armor up to chain', 'Small to large shield', 'Steed']
            };
            return [...commonEq, ...(classEq[characterClass] || [])];
        }

        function getAdvantagesWithBonus(race, characterClass) {
            const raceAdv = charGenData.allAdvantages[race] || [];
            const classAdv = charGenData.allAdvantages[characterClass] || [];
            const commonAdvantages = raceAdv.filter(adv => classAdv.includes(adv));
            let allUniqueAdvantages = [...new Set([...raceAdv, ...classAdv])];
            if (commonAdvantages.length > 0) {
                allUniqueAdvantages.push(`Duplicate Advantage Rule Triggered (by ${commonAdvantages.join(', ')}). You gain an extra 2-point advantage or can tier-up an existing one.`);
            }
            return { advantages: allUniqueAdvantages };
        }

        function getFlaws(race) { return ({ Gnome: ['Restriction: small weapons only'], Halfling: ['Restriction: small weapons only'], 'Half-Orc': ['Ugliness'] })[race] || []; }

        function generateSpellList(character) {
            const { level, spellcasting } = character;
            const { knownSpellsCount, pathSpecialization } = spellcasting;
            let knownSpells = new Set();
            const pathSpells = charGenData.spellsByPath[pathSpecialization] || {};
            const allPathSpells = charGenData.spellsByPath['AllPaths'] || {};
            const combinedPool = {
                Common: [...new Set([...(pathSpells.Common || []), ...(allPathSpells.Common || [])])],
                Uncommon: [...new Set([...(pathSpells.Uncommon || []), ...(allPathSpells.Uncommon || [])])]
            };
            for (let i = 0; i < knownSpellsCount; i++) {
                const pool = Math.random() < 0.7 ? combinedPool.Common : combinedPool.Uncommon;
                if (pool.length > 0) knownSpells.add({ name: pool[Math.floor(Math.random() * pool.length)], rarity: Math.random() < 0.7 ? 'Common' : 'Uncommon' });
            }
            return Array.from(knownSpells).sort((a, b) => a.name.localeCompare(b.name));
        }

        function displayCharacter(character) {
            const output = document.getElementById('character-output');
            const levelData = charGenData.levelInfo[character.level - 1];
            const cpRange = levelData.cp_range;
            
            let abilityLines = '';
            charGenData.abilities.forEach(a => {
                let specialtyStrings = charGenData.specialties[a].map(sp => {
                    let focusStrings = charGenData.focuses[sp].map(fx => {
                        const fxVal = character.focuses[a]?.[fx] || '+0';
                        return parseInt(fxVal.replace('+', '')) > 0 ? `${fx} ${fxVal}` : null;
                    }).filter(Boolean).join(', ');
                    return `${sp} <strong>${character.specialties[a][sp]}</strong>` + (focusStrings ? ` (${focusStrings})` : '');
                }).join(', ');
                abilityLines += `<div class="mb-2"><span class="font-semibold">${a} <strong>${character.abilities[a]}</strong></span> &rarr; ${specialtyStrings}.</div>`;
            });

            output.innerHTML = `<div class="card fade-in">
                <h2 style="font-size: 1.5rem; border-bottom: 1px solid #4CAF50; padding-bottom: 0.5rem; margin-bottom: 1rem;">${character.race} ${character.class} - Level ${character.level}</h2>
                <!-- Core stats, abilities, actions, etc. would be formatted and inserted here -->
                <p><strong>SP:</strong> ${character.defensePools.spiritPoints} | <strong>ADP:</strong> ${character.defensePools.activeDefense} | <strong>PDP:</strong> ${character.defensePools.passiveDefense}</p>
                <p><strong>Mastery Die:</strong> ${character.masteryDie}</p>
                <h3 style="color: #4CAF50; margin-top: 1rem;">Abilities</h3>
                ${abilityLines}
                <!-- More sections like Advantages, Feats, Spells would follow -->
            </div>`;
        }

        function exportToMarkdown() { /* ... existing markdown export logic ... */ }
        
        // --- Battle Calculator Logic ---
        let combatants = [];
        let autoRollEnabled = false;
        let defeatedCombatants = [];
        
        function addCombatant() {
            const name = document.getElementById('combatantName').value || `Combatant ${combatants.length + 1}`;
            const prowess = parseInt(document.getElementById('prowess').value);
            const type = document.getElementById('combatantType').value;
            const adp = parseInt(document.getElementById('adp').value) || 0;
            const pdp = parseInt(document.getElementById('pdp').value) || 0;
            const id = Date.now();
            
            combatants.push({ id, name, prowess, type, adp, pdp, maxAdp: adp });
            displayTurnOrder();
        }

        function displayTurnOrder() {
            combatants.sort((a, b) => b.prowess - a.prowess);
            const turnOrderList = document.getElementById('turnOrder');
            turnOrderList.innerHTML = '';
            combatants.forEach((c) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${c.name}</strong> (d${c.prowess})<br>
                                ADP: <input type="number" value="${c.adp}" onchange="updateCombatantStat(${c.id}, 'adp', this.value)"> | 
                                PDP: <input type="number" value="${c.pdp}" onchange="updateCombatantStat(${c.id}, 'pdp', this.value)">
                                <button onclick="defeatCombatant(${c.id})">Defeat</button>`;
                turnOrderList.appendChild(li);
            });
            displayDefeatedList();
        }
        
        function updateCombatantStat(id, stat, value) {
            const combatant = combatants.find(c => c.id === id);
            if (combatant) {
                combatant[stat] = parseInt(value);
            }
        }

        function defeatCombatant(id) {
            const index = combatants.findIndex(c => c.id === id);
            if (index > -1) {
                defeatedCombatants.push(combatants[index]);
                combatants.splice(index, 1);
                displayTurnOrder();
            }
        }

        function displayDefeatedList() {
            const defeatedList = document.getElementById('defeatedList');
            defeatedList.innerHTML = '';
            defeatedCombatants.forEach(c => {
                const li = document.createElement('li');
                li.textContent = `${c.name} (d${c.prowess})`;
                defeatedList.appendChild(li);
            });
        }
        
        function toggleAutoRoll() { autoRollEnabled = document.getElementById('autoRollToggle').checked; }
        function toggleFields() { 
            const type = document.getElementById('combatantType').value;
            document.getElementById('paFields').style.display = (type === 'pa') ? 'block' : 'none';
        }


        // --- Monster HP Calculator ---
        function calculateMonsterHP() {
            const nature = parseFloat(document.getElementById('monsterNature').value);
            const size = parseFloat(document.getElementById('monsterSize').value);
            const minor = parseInt(document.getElementById('threatTier1').value);
            const standard = parseInt(document.getElementById('threatTier2').value);
            const exceptional = parseInt(document.getElementById('threatTier3').value);

            let totalModifier = (size + nature) / 2;
            let totalHitPoints = minor + standard + exceptional;
            let finalHitPoints = Math.ceil(totalHitPoints * totalModifier);
            
            let threat = "a Minor";
            if (exceptional > 0) threat = "an Exceptional";
            else if (standard > 0) threat = "a Standard";

            document.getElementById('monsterHPOutput').textContent = `Final hit points is ${finalHitPoints}.\nThis creature is ${threat} threat (MV ${totalHitPoints}).`;
        }
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            updateSliderValues();
            populateCharacterGeneratorDropdowns();
            toggleFields();
            document.getElementById('generate-btn').addEventListener('click', generateCharacter);
            document.getElementById('export-md-btn').addEventListener('click', exportToMarkdown);
            document.getElementById('copy-md-btn').addEventListener('click', () => {
                const md = exportToMarkdown();
                if (md) navigator.clipboard.writeText(md).then(() => showAlert('Markdown copied!'), () => showAlert('Copy failed.'));
            });
            document.getElementById('custom-alert-close').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.remove('visible');
            });
        });
    </script>
</body>
</ht