<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raven Calder · Poetic Brain</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/dist/output.css" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #messages::-webkit-scrollbar { width: 10px; }
    #messages::-webkit-scrollbar-thumb { background: #374151; border-radius: 6px; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="border-b border-slate-800 bg-slate-900/70 backdrop-blur">
    <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500"></div>
        <div>
          <h1 class="text-sm font-semibold tracking-wide">Raven Calder</h1>
          <p id="status" class="text-xs text-slate-400">Initializing…</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="backToMathBrain" class="rounded-md bg-slate-800 px-3 py-1.5 text-sm font-medium hover:bg-slate-700">Math Brain</button>
        <button id="login-btn" class="hidden rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-medium hover:bg-indigo-500">Log in</button>
        <button id="logout-btn" class="hidden rounded-md bg-slate-800 px-3 py-1.5 text-sm font-medium hover:bg-slate-700">Log out</button>
        <div id="user-pill" class="hidden rounded-full bg-slate-800 px-3 py-1 text-xs text-slate-300"></div>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-3xl px-4 py-6">
    <div id="messages" class="h-[60vh] w-full overflow-y-auto rounded-lg border border-slate-800 bg-slate-900 p-4">
      <!-- Messages render here -->
    </div>

    <form id="composer" class="mt-4 flex items-end gap-2">
      <textarea id="input" rows="2" placeholder="Ask Raven…" class="flex-1 resize-none rounded-lg border border-slate-800 bg-slate-900 px-3 py-2 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-600"></textarea>
      <button id="send-btn" type="submit" class="rounded-lg bg-indigo-600 px-4 py-2 font-medium hover:bg-indigo-500 disabled:opacity-40">Send</button>
    </form>

    <p class="mt-3 text-xs text-slate-500">
      API: <span id="api-label">/.netlify/functions/poetic-brain</span>
    </p>
  </main>

  <!-- Auth0 SDK -->
  <script src="/vendor/auth0-spa-js.production.js"></script>
  
  <script>
    // Auth0 State Management
    const AUTH_STATE = {
      client: null,
      config: null,
      ready: false,
      authenticated: false,
      user: null,
    };

    // Fetch Auth0 config
    async function loadAuthConfig() {
      try {
        const res = await fetch('/.netlify/functions/auth-config', { cache: 'no-store' });
        if (!res.ok) throw new Error(`auth-config ${res.status}`);
        const cfg = await res.json();
        AUTH_STATE.config = cfg;
        return cfg;
      } catch (e) {
        console.warn('Auth0 config missing or invalid:', e);
        AUTH_STATE.config = null;
        return null;
      }
    }

    function isConfigured(cfg) {
      return cfg && typeof cfg.domain === 'string' && cfg.domain &&
             typeof cfg.clientId === 'string' && cfg.clientId;
    }

    // Initialize Auth0
    async function initAuth() {
      const cfg = await loadAuthConfig();
      
      if (!cfg || !isConfigured(cfg)) {
        AUTH_STATE.ready = true;
        updateAuthUI();
        return;
      }

      AUTH_STATE.client = await createAuth0Client({
        domain: cfg.domain,
        clientId: cfg.clientId,
        cacheLocation: 'localstorage',
        useRefreshTokens: true,
        authorizationParams: {
          redirect_uri: window.location.origin + '/chat',
          audience: cfg.audience || undefined,
          scope: cfg.scope || 'openid profile email',
        },
      });

      // Handle Auth0 callback
      if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
        try {
          await AUTH_STATE.client.handleRedirectCallback();
        } catch (e) {
          console.error('Auth0 redirect error:', e);
        } finally {
          window.history.replaceState({}, document.title, '/chat');
        }
      }

      AUTH_STATE.authenticated = await AUTH_STATE.client.isAuthenticated();
      AUTH_STATE.user = AUTH_STATE.authenticated ? await AUTH_STATE.client.getUser() : null;
      AUTH_STATE.ready = true;
      updateAuthUI();
    }

    // Update Auth UI
    function updateAuthUI() {
      const status = document.getElementById('status');
      const loginBtn = document.getElementById('login-btn');
      const logoutBtn = document.getElementById('logout-btn');
      const userPill = document.getElementById('user-pill');

      if (!AUTH_STATE.ready) {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        userPill.classList.add('hidden');
        status.textContent = 'Initializing…';
        return;
      }

      if (!AUTH_STATE.config || !isConfigured(AUTH_STATE.config)) {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        userPill.classList.add('hidden');
        status.textContent = 'Auth disabled (guest mode)';
        return;
      }

      if (AUTH_STATE.authenticated) {
        loginBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        userPill.classList.remove('hidden');
        const label = AUTH_STATE.user?.name || AUTH_STATE.user?.email || 'Signed in';
        userPill.textContent = label;
        status.textContent = 'Connected';
      } else {
        loginBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
        userPill.classList.add('hidden');
        status.textContent = 'Not signed in';
      }
    }

    // Auth methods
    async function login() {
      if (!AUTH_STATE.client) return;
      await AUTH_STATE.client.loginWithRedirect();
    }

    async function logout() {
      if (!AUTH_STATE.client) return;
      await AUTH_STATE.client.logout({ logoutParams: { returnTo: window.location.origin + '/chat' } });
    }

    async function getToken() {
      if (!AUTH_STATE.client) return null;
      try {
        return await AUTH_STATE.client.getTokenSilently();
      } catch {
        return null;
      }
    }

    // Message UI Functions
    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function userBubble(text) {
      return `
        <div class="flex justify-end mb-3">
          <div class="max-w-[80%] rounded-lg bg-indigo-600 px-3 py-2 text-sm">
            ${escapeHtml(text)}
          </div>
        </div>
      `;
    }

    function botBubble(text) {
      return `
        <div class="flex justify-start mb-3">
          <div class="max-w-[80%] rounded-lg bg-slate-800 px-3 py-2 text-sm text-slate-100">
            ${escapeHtml(text)}
          </div>
        </div>
      `;
    }

    function typingBubble() {
      return `
        <div class="flex justify-start mb-3" id="typing">
          <div class="rounded-lg bg-slate-800 px-3 py-2 text-sm text-slate-300">
            <span class="inline-flex gap-1">
              <span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce [animation-delay:-.3s]"></span>
              <span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce [animation-delay:-.15s]"></span>
              <span class="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></span>
            </span>
          </div>
        </div>
      `;
    }

    function scrollToBottom() {
      const messages = document.getElementById('messages');
      messages.scrollTop = messages.scrollHeight;
    }

    function addMessage(html) {
      const messages = document.getElementById('messages');
      messages.insertAdjacentHTML('beforeend', html);
      scrollToBottom();
    }

    // API Communication
    async function postMessage(content) {
      const headers = { 'Content-Type': 'application/json' };
      const token = await getToken();
      
      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const body = JSON.stringify({
        prompt: content, // Use 'prompt' to match your poetic-brain function
      });

      const res = await fetch('/.netlify/functions/poetic-brain', {
        method: 'POST',
        headers,
        body,
      });

      if (!res.ok) {
        const text = await res.text().catch(() => '');
        const code = res.status;
        throw new Error(`API_${code}: ${text || res.statusText}`);
      }

      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const data = await res.json();
        return data.response || data.reply || data.message || JSON.stringify(data);
      }
      return await res.text();
    }

    // Wire up events
    function wireEvents() {
      document.getElementById('backToMathBrain')?.addEventListener('click', () => {
        window.location.href = '/';
      });

      document.getElementById('login-btn')?.addEventListener('click', login);
      document.getElementById('logout-btn')?.addEventListener('click', logout);

      const form = document.getElementById('composer');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('send-btn');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const value = input.value.trim();
        if (!value) return;

        sendBtn.disabled = true;

        addMessage(userBubble(value));
        input.value = '';
        addMessage(typingBubble());

        try {
          const reply = await postMessage(value);
          document.getElementById('typing')?.remove();
          addMessage(botBubble(reply || '…'));
        } catch (err) {
          document.getElementById('typing')?.remove();
          const msg = `Request failed: ${err?.message || 'Unknown error'}`;
          addMessage(botBubble(msg));
        } finally {
          sendBtn.disabled = false;
          input.focus();
        }
      });
    }

    // Main initialization
    function bootstrap() {
      wireEvents();
      initAuth();
    }

    // Start when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bootstrap);
    } else {
      bootstrap();
    }
  </script>
</body>
</html>