WovenWeb Codemap & GuardrailsAuthoritative System Flow â€“ Pure Next.js EditionThis document translates the ARCHITECTURE_OVERVIEW.md into a file-level map. It defines the specific code components and the guardrails that ensure system stability.Every guardrail below prevents a known, critical regression.1. The Orchestrator (Keystone)Route HandlerFile: app/api/astrology-mathbrain/route.tsFunction: The single entry point for all backend processing. It orchestrates the entire "System Spine" as defined in the Architecture Overview.Guardrails:Guardrail 1.A (Schema Owner): This file is the only place the final, client-facing response shape is defined. It is the single source of truth for the response.Guardrail 1.B (Data Integrity): This handler must ensure daily_entries exists before passing the JSON to the VOICE layer. This is a core requirement of the API Contract.Guardrail 1.C (Summary Builder): This handler must correctly derive the root-level mirror_data object from the last entry in the daily_entries array to prevent summary mismatches.2. Astro Brain: Core ModulesTransit Engine (High-Risk Surface)File: src/math-brain/api-client.jsFunction: Manages the date loop, fetches raw geometry, and handles API fallbacks.Guardrails:Guardrail 2.A (Sync Covenant): The main "Transit Loop" and the "Fallback Path" logic must be kept perfectly synchronized. Any change to one (e.g., data shaping, error handling) must be replicated in the other, or data will be inconsistent.Guardrail 2.B (Retry Path): The apiCallWithRetry helper is a critical dependency and lives within this module.MAP Layer (Seismograph)File: src/math-brain/seismograph-engine.jsFunction: Calculates all deterministic metrics (Magnitude, Directional Bias, etc.).Guardrails:Guardrail 3.A (Helper Requirement): The calculateSeismograph function must be explicitly passed its options.helpers. Failure to pass helpers will result in silent zeroing of metrics or crashes.Astro Brain OrchestratorFile: src/math_brain/main.jsFunction: Assembles the final, structured JSON object (the "ACC Spec v2") from all the preceding layers.Guardrails:Guardrail 4.A (ACC Spec): The output of this module must validate against the API_REFERENCE.md before it is returned to the Route Handler.3. The Handoff (The Bridge)VOICE Layer (API Client)File: src/math-brain/voice/Function: This module is not the Poetic Brain. It is the API client that calls the Poetic Brain.Guardrails:Guardrail 5.A (The Contract): This layer must not modify the JSON it receives. It only reads the JSON and uses it to construct the prompt for the external LLM.Guardrail 5.B (The Bridge): The logic here (prompt construction, API call) must align with the NARRATIVE_LAYER_INTEGRATION.md document.4. Pure Next.js Constraints (Global Guardrails)These rules apply to the entire repository:No Netlify Functions: All backend logic must be in app/api/ routes.No Hybrid Server: The npm run dev command must only run the Next.js server on a single port.No Static index.html: Do not create a static public/index.html that can conflict with the Next.js App Router.No Dual-Architecture Drift: All new development must adhere to this "Pure Next.js" standard.