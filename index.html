<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Woven Map Math Brain - Pure Astrological Geometry</title>
    <link href="dist/output.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .animate-fade-in-out { animation: fadeInOut 8s ease-in-out forwards; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
        .bg-gray-750 { background-color: #334155; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Woven Map Math Brain</h1>
            <p class="text-gray-400 mt-2 flex items-center justify-center gap-2">Pure Astrological Geometry Computation
                <button id="math-brain-info-btn" class="ml-2 text-xs text-teal-300 underline hover:text-teal-400 focus:outline-none" type="button">
                    What is Math Brain? (Glossary)
                </button>
            </p>
        </header>

        <!-- Glossary Modal -->
        <div id="math-brain-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
          <div class="bg-gray-900 rounded-lg shadow-xl max-w-lg w-full p-6 relative border border-teal-500">
            <button id="close-math-brain-modal" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            <h2 class="text-xl font-bold text-teal-300 mb-2">Math Brain & Poetic Brain: The Woven Map Framework</h2>
            <p class="text-sm text-gray-200 mb-3">
              <b>Math Brain</b>: computes planetary positions, aspects, house placements. Outputs geometry, no meaning.<br>
              <b>Poetic Brain</b>: translates geometry into felt/narrative language. Diagnostic, not predictive.<br>
              <b>TL;DR</b>: Math Brain finds the coordinates. Poetic Brain speaks the language you can feel.
            </p>
            <h3 class="text-teal-200 font-semibold mt-4 mb-1">Glossary</h3>
            <ul class="text-xs text-gray-300 space-y-1 max-h-48 overflow-y-auto pr-2">
              <li><b>FIELD → MAP → VOICE</b>: FIELD = energetic climate, MAP = geometry, VOICE = felt reflection.</li>
              <li><b>Ping</b>: Recognized resonance between chart and experience.</li>
              <li><b>SST</b>: Falsifiability filter. WB = Within Boundary, ABE = At Boundary Edge, OSR = Outside Symbolic Range.</li>
              <li><b>Echo Loop</b>: Dyadic cycle under 1° orb.</li>
              <li><b>REF</b>: Relational Echo Field, macro-pattern resonance between two charts.</li>
              <li><b>Intimacy Tier</b>: P1 = Platonic, P2 = FWB, P3 = Romantic.</li>
              <li><b>Clear Mirror</b>: Testable, non-mystical phrasing.</li>
              <li><b>29° Crisis Node</b>: Planet at 29°, volatility.</li>
              <li><b>Symbolic Weather Overlay</b>: Current transits as energetic "weather".</li>
              <li><b>Paradox Line</b>: Internal contradiction.</li>
            </ul>
            <div class="mt-4 text-right">
              <button id="close-math-brain-modal-bottom" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-1 px-4 rounded">Close</button>
            </div>
          </div>
        </div>

        <main>
            <!-- Person A & B Cards -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div id="personA-card" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Person A / Natal Chart</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="nameA" placeholder="Name" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="DH Cross">
                            <input type="text" id="birth_cityA" placeholder="Birth City" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="Bryn Mawr">
                            <input type="text" id="birth_stateA" placeholder="Birth State/Prov" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="PA">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="date" id="birth_dateA" placeholder="Birth Date (YYYY-MM-DD)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="1973-07-24">
                            <input type="text" id="birth_timeA" placeholder="Time (24h HH:MM)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="14:30">
                            <select id="offsetA" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                                <option value="America/New_York">Eastern (New York)</option>
                                <option value="America/Chicago">Central (Chicago)</option>
                                <option value="America/Denver">Mountain (Denver)</option>
                                <option value="America/Los_Angeles">Pacific (Los Angeles)</option>
                                <option value="America/Anchorage">Alaska</option>
                                <option value="Pacific/Honolulu">Hawaii</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="birth_countryA" placeholder="Country (2-letter)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="US">
                            <select id="zodiacA" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                                <option value="Tropic">Tropic</option>
                                <option value="Sidereal">Sidereal</option>
                            </select>
                        </div>
                        <div>
                            <label for="astroA" class="block mb-1 text-sm font-medium text-gray-300">Birth Coordinates</label>
                            <input type="text" id="astroA" placeholder="e.g., 40°1'N, 75°18'W or 40.01, -75.31" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="40°1'N, 75°18'W">
                        </div>
                    </div>
                </div>
                <div id="personB-card" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Person B (Optional)</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="nameB" placeholder="Name" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                            <input type="text" id="birth_cityB" placeholder="Birth City" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                            <input type="text" id="birth_stateB" placeholder="Birth State/Prov" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="date" id="birth_dateB" placeholder="Birth Date (YYYY-MM-DD)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                            <input type="text" id="birth_timeB" placeholder="Time (24h HH:MM)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                            <select id="offsetB" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                                <option value="America/New_York">Eastern (New York)</option>
                                <option value="America/Chicago">Central (Chicago)</option>
                                <option value="America/Denver">Mountain (Denver)</option>
                                <option value="America/Los_Angeles">Pacific (Los Angeles)</option>
                                <option value="America/Anchorage">Alaska</option>
                                <option value="Pacific/Honolulu">Hawaii</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="birth_countryB" placeholder="Country (2-letter)" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                            <select id="zodiacB" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                                <option value="Tropic">Tropic</option>
                                <option value="Sidereal">Sidereal</option>
                            </select>
                        </div>
                        <div>
                           <label for="astroB" class="block mb-1 text-sm font-medium text-gray-300">Birth Coordinates</label>
                           <input type="text" id="astroB" placeholder="e.g., 30.16, -85.66" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                        </div>
                        <button id="pasteAstroB" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-2 rounded text-sm">
                          Paste AstroSeek Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Context Mode Section -->
            <div id="context-mode-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 border border-teal-500">
                <h2 class="text-2xl font-semibold text-white mr-3">Context Mode</h2>
                <div id="context-toggle" class="flex items-center mb-4">
                    <label class="flex items-center mr-4">
                        <input type="radio" name="contextMode" value="natal" class="mr-2" checked>
                        <span class="text-gray-300">Natal Chart</span>
                    </label>
                    <label class="flex items-center mr-4">
                        <input type="radio" name="contextMode" value="synastry" class="mr-2">
                        <span class="text-gray-300">Synastry</span>
                    </label>
                    <label class="flex items-center mr-4">
                        <input type="radio" name="contextMode" value="transit" class="mr-2">
                        <span class="text-gray-300">Transit</span>
                    </label>
                    <label class="flex items-center mr-4">
                        <input type="radio" name="contextMode" value="composite" class="mr-2">
                        <span class="text-gray-300">Composite</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="contextMode" value="synastry-transits" class="mr-2">
                        <span class="text-gray-300">Synastry + Transits</span>
                    </label>
                </div>
                
                <!-- Relocation Overlay Section -->
                <div id="relocation-section" class="mt-6 border-t border-gray-700 pt-4">
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="relocationToggle" class="mr-3 h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-600 rounded bg-gray-700">
                        <label for="relocationToggle" class="text-gray-300 font-medium">
                            Enable Relocation Overlay
                            <span class="text-xs text-gray-500 block">Compare transits/chart at alternate location</span>
                        </label>
                    </div>
                    
                    <!-- Relocation Fields (initially hidden) -->
                    <div id="relocationFields" class="hidden space-y-4 bg-gray-750 p-4 rounded-lg border border-gray-600">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="relocationCity" class="block mb-1 text-sm font-medium text-gray-300">Relocation City</label>
                                <input type="text" id="relocationCity" placeholder="e.g., Panama City" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="Panama City">
                            </div>
                            <div>
                                <label for="relocationState" class="block mb-1 text-sm font-medium text-gray-300">State/Province</label>
                                <input type="text" id="relocationState" placeholder="e.g., FL" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="FL">
                            </div>
                        </div>
                        
                        <div>
                            <label for="relocationCoords" class="block mb-1 text-sm font-medium text-gray-300">
                                Relocation Coordinates
                                <span class="text-xs text-gray-500">(Required for overlay calculations)</span>
                            </label>
                            <input type="text" id="relocationCoords" placeholder="e.g., 30°10'N, 85°40'W or 34.0522, -118.2437" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600" value="30°10'N, 85°40'W">
                            <div class="mt-1 text-xs text-gray-500">
                                Format: latitude, longitude (decimal degrees)
                                <br>Examples: "40.7128, -74.0060" (NYC) or "34.0522, -118.2437" (LA)
                            </div>
                            
                            <!-- Validation Error for Relocation Coords -->
                            <div id="relocationCoordsError" class="hidden mt-1 text-xs text-red-400">
                                Please enter valid coordinates in format: latitude, longitude
                            </div>
                        </div>
                        
                        <div class="bg-gray-800 p-3 rounded border border-gray-600">
                            <h4 class="text-sm font-medium text-teal-300 mb-2">How Relocation Overlay Works:</h4>
                            <ul class="text-xs text-gray-400 space-y-1">
                                <li>• Birth chart remains at original location</li>
                                <li>• Transits/progressions calculated for new location</li>
                                <li>• Shows how planetary energy shifts in different places</li>
                                <li>• Useful for travel, relocation, or understanding location-based influences</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Transit Date Range Fields (only visible in transit mode) -->
                <div id="transit-date-range-fields" class="mb-6" style="display:none;">
                  <label for="transitStartDate" class="block text-gray-300 font-medium mb-1">Transit Start Date (YYYY-MM-DD):</label>
                  <input type="date" id="transitStartDate" name="transitStartDate" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 mb-2" required>
                  <label for="transitEndDate" class="block text-gray-300 font-medium mb-1">Transit End Date (YYYY-MM-DD):</label>
                  <input type="date" id="transitEndDate" name="transitEndDate" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 mb-2" required>
                  <label for="transitStep" class="block text-gray-300 font-medium mb-1">Step Size:</label>
                  <select id="transitStep" name="transitStep" class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600">
                    <option value="1d">Daily</option>
                    <option value="7d">Weekly</option>
                    <option value="1m">Monthly</option>
                  </select>
                </div>
                
                <!-- Additional Context Options -->
                <div id="context-options" class="space-y-4">
                    <div class="bg-yellow-900 border border-yellow-700 text-yellow-100 px-4 py-3 rounded mb-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium">Math Brain Protocol Active</h3>
                                <div class="mt-2 text-sm">
                                    This interface computes pure astrological geometry only. Focus area and report style preferences have been moved to the VOICE layer for proper FIELD → MAP → VOICE separation.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relational Context Section (only if Person B is present) -->
            <div id="relational-context-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 border border-teal-500 hidden">
                <h2 class="text-2xl font-semibold mb-4 text-white border-b border-gray-700 pb-2">Relational Context Query Stack</h2>
                <p class="text-gray-400 text-sm mb-4">Based on initial geometry, the Math Brain has detected the following potential dynamics:</p>
                <ul id="context-readout" class="list-disc list-inside space-y-2 mb-4 text-gray-300"></ul>
                <div id="relationship-type-query">
                    <p class="text-lg font-medium text-white mb-2">How would you categorize this connection?</p>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="relationshipType" value="partner" class="form-radio h-4 w-4 text-teal-400"><span class="ml-2 text-gray-300">Partner (romantic/undefined-intimate)</span></label>
                        <label class="flex items-center"><input type="radio" name="relationshipType" value="friend" class="form-radio h-4 w-4 text-teal-400"><span class="ml-2 text-gray-300">Friend or colleague</span></label>
                        <label class="flex items-center"><input type="radio" name="relationshipType" value="family" class="form-radio h-4 w-4 text-teal-400"><span class="ml-2 text-gray-300">Family</span></label>
                    </div>
                    <div id="intimacy-tier-dropdown" class="mt-4 hidden">
                        <p class="text-md font-medium text-white mb-2">What best describes the intimacy tier of this connection?</p>
                        <div class="flex flex-col space-y-2">
                            <label class="flex items-center"><input type="radio" name="intimacyTier" value="P1" class="form-radio h-4 w-4 text-pink-400"><span class="ml-2 text-gray-300">P1 – Platonic partners</span></label>
                            <label class="flex items-center"><input type="radio" name="intimacyTier" value="P2" class="form-radio h-4 w-4 text-pink-400"><span class="ml-2 text-gray-300">P2 – Friends with benefits</span></label>
                            <label class="flex items-center"><input type="radio" name="intimacyTier" value="P3" class="form-radio h-4 w-4 text-pink-400"><span class="ml-2 text-gray-300">P3 – Romantic partners</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generate Button -->
            <div class="text-center mb-8">
                <button id="generateReport" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Compute Astrological Geometry
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center mb-8">
                <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-teal-600 transition ease-in-out duration-150">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Computing Astrological Geometry...
                </div>
            </div>

            <!-- Error Display -->
            <div id="errorDisplay" class="hidden bg-red-900 border border-red-700 text-red-100 px-4 py-3 rounded mb-8">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium">Error computing geometry</h3>
                        <div id="errorMessage" class="mt-2 text-sm"></div>
                    </div>
                </div>
            </div>

            <!-- Report Output -->
            <div id="reportOutput" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Pure Astrological Geometry</h2>
                    <button id="copyReport" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                        Copy Geometry Data
                    </button>
                </div>
                <div id="reportContent" class="text-gray-200 whitespace-pre-wrap font-mono text-sm bg-gray-900 p-4 rounded border border-gray-700 overflow-auto max-h-96">
                </div>
            </div>
        </main>

        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>&copy; 2024 Woven Map Report Generator. Math Brain + Poetic Brain Framework.</p>
        </footer>
    </div>

    <script>
        // --- Utility Functions ---

        function showError(message) {
            errorMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            reportOutput.classList.add('hidden');
        }

        function hideError() {
            errorDisplay.classList.add('hidden');
        }

        function parseCoordinates(coordString) {
            if (!coordString) return { latitude: undefined, longitude: undefined };
            
            coordString = coordString.trim();
            const decimalPattern = /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/;
            const dmsPattern = /(\d+)[°\s]+(\d+)'?\s*([NS]),\s*(\d+)[°\s]+(\d+)'?\s*([EW])/i;

            if (decimalPattern.test(coordString)) {
                const [lat, lon] = coordString.split(',').map(s => parseFloat(s.trim()));
                return { latitude: lat, longitude: lon };
            }

            const dmsMatch = coordString.match(dmsPattern);
            if (dmsMatch) {
                let lat = parseFloat(dmsMatch[1]) + parseFloat(dmsMatch[2]) / 60;
                if (dmsMatch[3].toUpperCase() === 'S') lat = -lat;

                let lon = parseFloat(dmsMatch[4]) + parseFloat(dmsMatch[5]) / 60;
                if (dmsMatch[6].toUpperCase() === 'W') lon = -lon;
                
                return { latitude: parseFloat(lat.toFixed(4)), longitude: parseFloat(lon.toFixed(4)) };
            }
            
            // Return undefined if no pattern matches
            return { latitude: undefined, longitude: undefined };
        }

        // --- Form Logic ---

        function validateForm() {
            hideError();
            const mode = document.querySelector('input[name="contextMode"]:checked').value;

            // Validate Person A
            const nameA = document.getElementById('nameA').value.trim();
            const dateA = document.getElementById('birth_dateA').value.trim();
            const timeA = document.getElementById('birth_timeA').value.trim();
            const astroA = document.getElementById('astroA').value.trim();

            if (!nameA || !dateA || !timeA || !astroA) {
                showError('Please fill in all required fields for Person A');
                return false;
            }
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateA)) {
                showError('Please enter Person A date in YYYY-MM-DD format');
                return false;
            }
            if (!/^\d{2}:\d{2}$/.test(timeA)) {
                showError('Please enter Person A time in HH:MM format (24-hour)');
                return false;
            }
            const coordsA = parseCoordinates(astroA);
            if (coordsA.latitude === undefined || coordsA.longitude === undefined) {
                showError('Please enter Person A coordinates in a valid decimal (e.g., 40.01, -75.31) or DMS format (e.g., 40°1\'N, 75°18\'W)');
                return false;
            }

            // Validate Person B if required by mode
            if (mode === 'synastry' || mode === 'composite' || mode === 'synastry-transits') {
                const nameB = document.getElementById('nameB').value.trim();
                const dateB = document.getElementById('birth_dateB').value.trim();
                const timeB = document.getElementById('birth_timeB').value.trim();
                const astroB = document.getElementById('astroB').value.trim();
                if (!nameB || !dateB || !timeB || !astroB) {
                    showError(`Please fill in all required fields for Person B for ${mode} analysis`);
                    return false;
                }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(dateB)) {
                    showError('Please enter Person B date in YYYY-MM-DD format');
                    return false;
                }
                if (!/^\d{2}:\d{2}$/.test(timeB)) {
                    showError('Please enter Person B time in HH:MM format (24-hour)');
                    return false;
                }
                const coordsB = parseCoordinates(astroB);
                if (coordsB.latitude === undefined || coordsB.longitude === undefined) {
                    showError('Please enter Person B coordinates in a valid decimal or DMS format');
                    return false;
                }
            }

            // Validate transit dates if required by mode
            if (mode === 'transit' || mode === 'synastry-transits') {
                const start = transitStartDate.value;
                const end = transitEndDate.value;
                if (!start || !end) {
                    showError('Please enter both start and end dates for transit analysis');
                    return false;
                }
                if (end < start) {
                    showError('End date must be after or equal to start date');
                    return false;
                }
            }

            // Validate relocation coordinates if enabled
            if (relocationToggle.checked) {
                const relocationCoords = relocationCoordsInput.value.trim();
                if (!relocationCoords) {
                    showError('Please enter relocation coordinates when overlay is enabled');
                    return false;
                }
                const coordsR = parseCoordinates(relocationCoords);
                if (coordsR.latitude === undefined || coordsR.longitude === undefined) {
                    showError('Please enter valid relocation coordinates in decimal or DMS format');
                    return false;
                }
            }

            return true;
        }

        function collectFormData() {
            // Person A
            const dateA = document.getElementById('birth_dateA').value.trim();
            const timeA = document.getElementById('birth_timeA').value.trim();
            const coordsA = parseCoordinates(document.getElementById('astroA').value.trim());
            const [yearA, monthA, dayA] = dateA.split('-').map(Number);
            const [hourA, minuteA] = timeA.split(':').map(Number);

            const personA = {
                name: document.getElementById('nameA').value.trim(),
                city: document.getElementById('birth_cityA').value.trim(),
                nation: document.getElementById('birth_countryA').value.trim(),
                year: yearA, month: monthA, day: dayA, hour: hourA, minute: minuteA,
                latitude: coordsA.latitude, 
                longitude: coordsA.longitude,
                zodiac_type: document.getElementById('zodiacA').value,
                timezone: document.getElementById('offsetA').value
            };

            // Person B
            const dateB_val = document.getElementById('birth_dateB').value;
            const timeB_val = document.getElementById('birth_timeB').value.trim();
            const coordsB_val = document.getElementById('astroB').value.trim();
            let personB = {};

            if (dateB_val && timeB_val && coordsB_val) {
                const coordsB = parseCoordinates(coordsB_val);
                if (coordsB.latitude !== undefined && coordsB.longitude !== undefined) {
                    const [yearB, monthB, dayB] = dateB_val.split('-').map(Number);
                    const [hourB, minuteB] = timeB_val.split(':').map(Number);
                    personB = {
                        name: document.getElementById('nameB').value.trim(),
                        city: document.getElementById('birth_cityB').value.trim(),
                        nation: document.getElementById('birth_countryB').value.trim(),
                        year: yearB, month: monthB, day: dayB, hour: hourB, minute: minuteB,
                        latitude: coordsB.latitude,
                        longitude: coordsB.longitude,
                        zodiac_type: document.getElementById('zodiacB').value,
                        timezone: document.getElementById('offsetB').value
                    };
                }
            }

            const formData = {
                personA,
                personB: Object.keys(personB).length > 0 ? personB : undefined,
                context: {
                    mode: document.querySelector('input[name="contextMode"]:checked').value,
                    relationship_type: document.querySelector('input[name="relationshipType"]:checked')?.value,
                    intimacy_tier: document.querySelector('input[name="intimacyTier"]:checked')?.value
                }
            };

            if (relocationToggle.checked) {
                const relocationCoords = parseCoordinates(document.getElementById('relocationCoords').value.trim());
                formData.relocation = {
                    enabled: true,
                    city: document.getElementById('relocationCity').value.trim(),
                    state: document.getElementById('relocationState').value.trim(),
                    latitude: relocationCoords.latitude,
                    longitude: relocationCoords.longitude
                };
            } else {
                formData.relocation = { enabled: false };
            }

            const mode = formData.context.mode;
            if (mode === 'transit' || mode === 'synastry-transits') {
                formData.transit = {
                    startDate: transitStartDate.value,
                    endDate: transitEndDate.value,
                    step: transitStep.value
                };
            }

            return formData;
        }

        // --- API Call ---

        async function generateReport() {
            if (!validateForm()) {
                return;
            }

            hideError();
            generateBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');
            reportOutput.classList.add('hidden');

            try {
                const formData = collectFormData();
                
                const response = await fetch('/api/astrology-mathbrain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        // Try to parse as JSON to get a more specific error message
                        const errorJson = JSON.parse(errorBody);
                        if (errorJson.error) {
                           errorMessage += ` - ${errorJson.error}`;
                           if(errorJson.missing) {
                             errorMessage += ` (Missing: ${errorJson.missing.join(', ')})`;
                           }
                        } else {
                           errorMessage += ` - ${errorBody}`;
                        }
                    } catch (e) {
                        // If not JSON, just use the text body
                        errorMessage += ` - ${errorBody}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                if (result.error) {
                    throw new Error(result.error);
                }

                let report = '';
                if (result._mathBrainOutput) {
                    report += '=== MATH BRAIN GEOMETRY OUTPUT ===\n';
                    report += `Computation completed: ${result._fieldToMapComputed}\n\n`;
                    const geometryData = { ...result };
                    delete geometryData._mathBrainOutput;
                    delete geometryData._fieldToMapComputed;
                    delete geometryData._voiceLayerContext;
                    report += JSON.stringify(geometryData, null, 2);
                } else {
                    report = JSON.stringify(result, null, 2);
                }

                reportContent.textContent = report;
                reportOutput.classList.remove('hidden');

            } catch (error) {
                console.error('Error generating report:', error);
                showError(`Failed to generate report: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Event Listeners & UI Updates ---

        function setupEventListeners() {
            // Main button
            generateBtn.addEventListener('click', generateReport);

            // Modal
            mathBrainInfoBtn.addEventListener('click', () => mathBrainModal.classList.remove('hidden'));
            closeMathBrainModal.addEventListener('click', () => mathBrainModal.classList.add('hidden'));
            closeMathBrainModalBottom.addEventListener('click', () => mathBrainModal.classList.add('hidden'));
            mathBrainModal.addEventListener('click', (e) => {
                if (e.target === mathBrainModal) mathBrainModal.classList.add('hidden');
            });

            // Copy report
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(reportContent.textContent);
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy Geometry Data'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
            });

            // Context mode switching
            document.querySelectorAll('input[name="contextMode"]').forEach(radio => {
                radio.addEventListener('change', updateFormUI);
            });

            // Relocation toggle
            relocationToggle.addEventListener('change', () => {
                relocationFields.classList.toggle('hidden', !relocationToggle.checked);
            });

            // Relational context visibility
            const personBInputs = ['nameB', 'birth_cityB', 'birth_stateB', 'birth_dateB', 'birth_timeB', 'birth_countryB', 'astroB'];
            personBInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    const anyFilled = personBInputs.some(id => document.getElementById(id).value.trim() !== '');
                    relationalContextSection.classList.toggle('hidden', !anyFilled);
                });
            });
            
            // Intimacy tier visibility
            document.querySelectorAll('input[name="relationshipType"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const isPartner = document.querySelector('input[name="relationshipType"]:checked')?.value === 'partner';
                    intimacyTierDropdown.classList.toggle('hidden', !isPartner);
                });
            });
        }

        function updateFormUI() {
            const mode = document.querySelector('input[name="contextMode"]:checked').value;

            const isTransit = mode === 'transit';
            const isSynastryTransits = mode === 'synastry-transits';
            const isNatal = mode === 'natal';
            
            const showPersonB = !isNatal && !isTransit;
            personBCard.style.opacity = showPersonB ? '1' : '0.5';
            personBCard.style.pointerEvents = showPersonB ? 'auto' : 'none';

            const showTransitFields = isTransit || isSynastryTransits;
            transitDateFields.style.display = showTransitFields ? 'block' : 'none';

            const showRelocation = isNatal || isTransit;
            relocationSection.style.display = showRelocation ? 'block' : 'none';
            if (!showRelocation && relocationToggle.checked) {
                relocationToggle.checked = false;
                relocationFields.classList.add('hidden');
            }
        }

        // Initial UI setup on page load
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const generateBtn = document.getElementById('generateReport');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorDisplay = document.getElementById('errorDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const reportOutput = document.getElementById('reportOutput');
            const reportContent = document.getElementById('reportContent');
            const copyBtn = document.getElementById('copyReport');
            const mathBrainInfoBtn = document.getElementById('math-brain-info-btn');
            const mathBrainModal = document.getElementById('math-brain-modal');
            const closeMathBrainModal = document.getElementById('close-math-brain-modal');
            const closeMathBrainModalBottom = document.getElementById('close-math-brain-modal-bottom');
            const relocationToggle = document.getElementById('relocationToggle');
            const relocationFields = document.getElementById('relocationFields');
            const transitDateFields = document.getElementById('transit-date-range-fields');
            const personBCard = document.getElementById('personB-card');
            const relocationSection = document.getElementById('relocation-section');
            const relationalContextSection = document.getElementById('relational-context-section');
            const intimacyTierDropdown = document.getElementById('intimacy-tier-dropdown');

            setupEventListeners();
            updateFormUI();
            
            // Initial check for relational context section
            const personBInputs = ['nameB', 'birth_cityB', 'birth_stateB', 'birth_dateB', 'birth_timeB', 'birth_countryB', 'astroB'];
            const anyFilled = personBInputs.some(id => document.getElementById(id).value.trim() !== '');
            relationalContextSection.classList.toggle('hidden', !anyFilled);
            
            // Initial check for intimacy tier
            const isPartner = document.querySelector('input[name="relationshipType"]:checked')?.value === 'partner';
            intimacyTierDropdown.classList.toggle('hidden', !isPartner);
        });
    </script>
</body>
</html>