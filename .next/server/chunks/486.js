exports.id=486,exports.ids=[486],exports.modules={13715:a=>{"use strict";function b(a,c=0){let d=Number(a);return Number.isFinite(d)?d:c}function c(a){if(!a)return 0;let c=b(a.orb,10),d=(a.name||a.type||"").toLowerCase(),e=c<=1?10:c<=2?8:c<=3?6:c<=4?4:c<=5?2:1,f=(a.planet1||a.first_planet||"").toLowerCase(),g=(a.planet2||a.second_planet||"").toLowerCase(),h=["uranus","neptune","pluto"],i=["sun","moon","mercury","venus","mars"],j=1;return(i.includes(f)||i.includes(g))&&(j=1.5),(h.includes(f)||h.includes(g))&&(j*=1.3),e*(({conjunction:9,opposition:9,square:8,trine:6,sextile:4,quincunx:7,sesquiquadrate:6,"semi-square":5,"semi-sextile":3,quintile:4,biquintile:4})[d]||3)*j}let d={sun_mars:{conjunction:"Dynamic & Action-Oriented / Impulsive or Burning Out",opposition:"Confident Leadership / Aggressive or Combative",square:"Driven & Ambitious / Frustrated or Impatient",trine:"Natural Authority / Overconfident or Domineering"},sun_saturn:{conjunction:"Disciplined & Structured / Rigid or Self-Critical",opposition:"Responsible & Mature / Restricted or Pessimistic",square:"Hardworking & Persistent / Blocked or Self-Doubting",trine:"Steady Achievement / Overly Conservative"},sun_uranus:{conjunction:"Innovative & Independent / Erratic or Rebellious",opposition:"Original Thinker / Unpredictable or Detached",square:"Creative Breakthrough / Restless or Disruptive",trine:"Visionary Freedom / Scattered or Impractical"},moon_mars:{conjunction:"Emotionally Intense / Reactive or Moody",opposition:"Passionate Feelings / Volatile or Aggressive",square:"Strong Instincts / Irritable or Defensive",trine:"Emotional Courage / Impulsive or Rash"},moon_saturn:{conjunction:"Emotionally Mature / Withdrawn or Depressed",opposition:"Responsible Caregiver / Cold or Rejecting",square:"Inner Strength / Self-Protective or Isolated",trine:"Stable Emotions / Emotionally Controlled"},venus_mars:{conjunction:"Magnetic Attraction / Possessive or Jealous",opposition:"Dynamic Relationships / Conflicted in Love",square:"Passionate Desires / Frustrated or Indulgent",trine:"Creative Harmony / Lazy or Self-Indulgent"},mars_saturn:{conjunction:"Focused Determination / Blocked or Self-Limiting",opposition:"Strategic Action / Frustrated or Rigid",square:"Persistent Effort / Angry or Inhibited",trine:"Disciplined Energy / Overly Cautious"},transit_conjunction:"Intense Focus & New Beginnings / Overwhelming or Obsessive",transit_opposition:"External Challenge & Perspective / Confrontational or Polarized",transit_square:"Dynamic Tension & Growth / Frustrated or Blocked",transit_trine:"Flowing Opportunity / Complacent or Overconfident"};function e(a){let b=function(a){let b=(a.planet1||a.first_planet||"").toLowerCase(),c=(a.planet2||a.second_planet||"").toLowerCase(),e=(a.name||a.type||"").toLowerCase(),[f,g]=[b,c].sort(),h=`${f}_${g}`;return d[h]&&d[h][e]?`${h}.${e}`:a.is_transit||a.transit?`transit_${e}`:null}(a);if(!b)return null;let[c,e]=b.split("."),f=d[c];return f&&"object"==typeof f?f[e]||null:"string"==typeof f?f:null}function f(a,d={}){if(!Array.isArray(a)||0===a.length)return{hooks:[],tier_1_orbs:0,total_intensity:0,coverage:"minimal"};let g=d.maxHooks||4,h=d.minIntensity||10,i=a.map(a=>({aspect:a,intensity:c(a),title:e(a),orb:b(a.orb,10)})).filter(a=>a.title&&a.intensity>=h).sort((a,b)=>b.intensity-a.intensity),j=[],k=new Set;for(let a of i){if(j.length>=g)break;k.has(a.title)||(j.push({title:a.title,intensity:a.intensity,orb:a.orb,planets:[a.aspect.planet1||a.aspect.first_planet,a.aspect.planet2||a.aspect.second_planet].filter(Boolean),aspect_type:a.aspect.name||a.aspect.type,is_tier_1:a.orb<=1}),k.add(a.title))}let l=j.filter(a=>a.is_tier_1).length,m=j.reduce((a,b)=>a+b.intensity,0),n="minimal";return j.length>=3&&l>=1&&(n="adequate"),j.length>=4&&l>=2&&(n="strong"),{hooks:j,tier_1_orbs:l,total_intensity:m,coverage:n,schema:"HookStack-1.0"}}a.exports={composeHookStack:function(a,b={}){let c=function(a){let b=[],c=a.person_a||{};Array.isArray(c.aspects)&&b.push(...c.aspects.map(a=>({...a,source:"natal_a"})));let d=c.chart?.transitsByDate||{},e=Object.keys(d).sort(),f=e[e.length-1];if(f&&Array.isArray(d[f]?.drivers)){let a=d[f].drivers.map(a=>({...a,source:"transit",is_transit:!0}));b.push(...a)}return Array.isArray(a.synastry_aspects)&&b.push(...a.synastry_aspects.map(a=>({...a,source:"synastry"}))),Array.isArray(a.composite?.aspects)&&b.push(...a.composite.aspects.map(a=>({...a,source:"composite"}))),b}(a);return{...f(c,b),timestamp:new Date().toISOString(),source_aspects_count:c.length,provenance:{composer:"hook-stack-composer",version:"1.0.0",tier_1_threshold:1,min_intensity_threshold:b.minIntensity||10}}},buildHookStack:f,calculateAspectIntensity:c,generateHookTitle:e,HOOK_TEMPLATES:d}},19502:a=>{"use strict";let b=new Set(["Saturn","Uranus","Neptune","Pluto"]),c=new Set(["Sun","Moon","Mercury","Venus","Mars","ASC","MC","IC","DSC"]),d=new Set(["ASC","MC","IC","DSC"]),e={magnitudeDivisor:4,hubBonusCap:.6,sameTargetBonusCap:.3,tightBandDeg:1.5,outerTightenStep:.2,uranusTightFlagDeg:3,fastComponentThreshold:1,rollingWindowDays:14,hookStackCap:5,planetaryWeights:{Sun:1.2,Moon:1.5,ASC:1.3,MC:1.3,IC:1.1,DSC:1.1,Mercury:1,Venus:1,Mars:1.1,Jupiter:.9,Saturn:.8,Uranus:.7,Neptune:.6,Pluto:.6,Chiron:.8,Mean_Node:.7,Mean_South_Node:.7}};function f(a,b=2){return Math.round(a*10**b)/10**b}function g(a){if(a)return"string"==typeof a?a:a.name||a.body}function h(a){let b=g(a?.transit)||g(a?.a),c=g(a?.natal)||g(a?.b);return{transit:{body:b||"?"},natal:{body:c||"?"},type:String(a?.type||a?.aspect||"").toLowerCase(),orbDeg:function(a,b=NaN){if("number"==typeof a)return a;if("string"==typeof a){let c=a.match(/(-?\d+)(?:[Â°:\s]+(\d+))?/);if(c)return+c[1]+(c[2]?+c[2]:0)/60;let d=parseFloat(a);return Number.isFinite(d)?d:b}return b}(a?.orb??a?.orbit,6.01)}}function i(a,b,c){switch(a){case"trine":return 1;case"sextile":return .7;case"square":case"opposition":return -1.2;case"conjunction":{let a=new Set([b,c]);if(a.has("Venus")||a.has("Jupiter"))return .6;if(a.has("Saturn")||a.has("Pluto")||a.has("Chiron"))return -.8;return 0}default:return 0}}function j(a){return"Chiron"===a?1.2:b.has(a)?1.5:"Moon"===a?.5:1}function k(a){let b=Math.abs(a);return b<=.5?1.5:b<=1.5?1.3:b<=3?1.2:b<=6?1:.6}function l(a,b=!1,d=!1,e=!1){let f=1;return b?f*=1.3:d?f*=1.2:c.has(a)&&(f*=1.1),e&&(f*=1.1),f}function m(a,b={}){let c=h(a),d=c.transit.body,e=c.natal.body,f=i(c.type,d,e),g=Math.max(j(d),j(e)),n=k(c.orbDeg),o=l(e,!!b.isAngleProx,"Sun"===e||"Moon"===e,!!b.critical);return{...c,S:f*g*n*o}}function n(a,b=e){let c=0,d=0,f=new Map;for(let b of a){let a=b.transit.body;f.set(a,(f.get(a)||0)+1)}for(let[,a]of f)a>=3&&(c+=.2*(a-2));c=Math.min(b.hubBonusCap,c);let g=new Map;for(let b of a){let a=b.natal.body;g.set(a,(g.get(a)||0)+1)}for(let[,a]of g)a>=2&&(d+=.1*(a-1));return c+(d=Math.min(b.sameTargetBonusCap,d))}function o(a,c=null,d=e){let f=0,g=0,h=0,i=0,j=a=>`${a.transit.body}|${a.natal.body}|${a.type}`;if(c?.scored){let b=a=>a.filter(a=>a.orbDeg<=d.tightBandDeg),e=new Set(b(c.scored).map(j)),g=new Set(b(a).map(j));for(let a of g)!e.has(a)&&f++;for(let a of e)!g.has(a)&&f++}if("number"==typeof c?.Y_effective){let b=c.Y_effective,d=a.reduce((a,b)=>a+b.S,0);Math.sign(b)!==Math.sign(d)&&Math.abs(b)>.05&&Math.abs(d)>.05&&(g=1)}if(c?.scored){let e=new Map(c.scored.map(a=>[j(a),a]));for(let c of a){let a=e.get(j(c)),f=(b.has(c.transit.body)||b.has(c.natal.body))&&("square"===c.type||"opposition"===c.type);a&&f&&a.orbDeg-c.orbDeg>=d.outerTightenStep&&h++}}a.some(a=>("Uranus"===a.transit.body||"Uranus"===a.natal.body)&&a.orbDeg<=d.uranusTightFlagDeg)&&(i=1);let k=a.map(a=>{let b=Math.max(d.planetaryWeights[a.transit.body]||.5,d.planetaryWeights[a.natal.body]||.5);return a.S*b}),l=0;if(k.length>=3){let a=k.reduce((a,b)=>a+b,0)/k.length;l=Math.min(2,.5*Math.sqrt(k.reduce((b,c)=>b+Math.pow(c-a,2),0)/k.length))}return f+g+h+i+Math.round(l)}function p(a,b=null,c=e){let d;if(!b||!b.magnitudes||b.magnitudes.length<1)return a;let{magnitudes:f}=b,g=f.length,h=Math.min(1,g/14);if(g>=14){let a=[...f].sort((a,b)=>a-b),b=Math.floor(a.length/2);d=a.length%2==0?(a[b-1]+a[b])/2:a[b]}else if(g>=2){let a=[...f].sort((a,b)=>a-b),b=Math.floor(a.length/2);d=h*(a.length%2==0?(a[b-1]+a[b])/2:a[b])+(1-h)*4}else d=4;return d<1e-6&&(d=4),Math.max(0,Math.min(10,5*a/(1.6*d)))}a.exports={aggregate:function(a=[],b=null,c={}){if(!Array.isArray(a)||0===a.length)return{magnitude:0,valence:b?.Y_effective?f(b.Y_effective,2):0,volatility:0,scored:[]};let g={...e,...c},h=a.map(a=>m(a,{isAngleProx:d.has(a?.natal?.body||a?.b?.name||a?.b||""),critical:!1})),i=h.reduce((a,b)=>a+Math.abs(b.S),0),j=h.reduce((a,b)=>a+b.S,0),k=Math.min(5,i/g.magnitudeDivisor),l=k=Math.min(5,k+n(h,g)),q=1;c.rollingContext&&c.rollingContext.magnitudes&&(q=f(c.rollingContext.magnitudes.length/14,2)),c.rollingContext&&(k=p(k,c.rollingContext,g));let r=j*(.8+.2*k),s=o(h,b,g);return{magnitude:f(k,2),valence:f(r,2),volatility:s,scored:h,rawMagnitude:f(i/g.magnitudeDivisor,2),originalMagnitude:f(l,2),scaleConfidence:q}},_internals:{normalizeAspect:h,baseValence:i,planetTier:j,orbMultiplier:k,sensitivityMultiplier:l,scoreAspect:m,multiplicityBonus:n,volatility:o,normalizeWithRollingWindow:p}}},20578:(a,b,c)=>{"use strict";let{aggregate:d}=c(19502),{_internals:e}=c(19502),{computeSFD:f,computeBalanceValence:g}=c(98622),h="https://astrologer.p.rapidapi.com",i={BIRTH_CHART:`${h}/api/v4/birth-chart`,NATAL_ASPECTS_DATA:`${h}/api/v4/natal-aspects-data`,SYNASTRY_CHART:`${h}/api/v4/synastry-chart`,TRANSIT_CHART:`${h}/api/v4/transit-chart`,TRANSIT_ASPECTS:`${h}/api/v4/transit-aspects-data`,SYNASTRY_ASPECTS:`${h}/api/v4/synastry-aspects-data`,BIRTH_DATA:`${h}/api/v4/birth-data`,NOW:`${h}/api/v4/now`,COMPOSITE_ASPECTS:`${h}/api/v4/composite-aspects-data`},{mapT2NAspects:j}=c(34091),{composeWovenMapReport:k}=c(23270),l={info:(...a)=>console.info("[INFO]",...a),warn:(...a)=>console.warn("[WARN]",...a),error:(...a)=>console.error("[ERROR]",...a),debug:(...a)=>"debug"===process.env.LOG_LEVEL&&console.debug("[DEBUG]",...a)};function m(a){if(!a||"object"!=typeof a)return a;let b=new Set(["wheel","svg","image","images","chart_image","graphical","png","jpg","jpeg","pdf","wheel_url","image_url","chartUrl","rendered_svg","rendered_png"]);if(Array.isArray(a))return a.map(m);let c={};for(let[d,e]of Object.entries(a))b.has(d)||(e&&"object"==typeof e?c[d]=m(e):c[d]=e);return c}let n="0.2.1",o="AstrologerAPI-v4",p="2025-09-05";function q(a){let b=String(a||"").toLowerCase();return["daily","weekly","monthly"].includes(b)?b:"1d"===b?"daily":"7d"===b?"weekly":"1m"===b||"1mo"===b||"monthly"===b?"monthly":"daily"}function r(a){if(!a||"string"!=typeof a)return a;let b=a.trim();return({"US/Eastern":"America/New_York","US/Central":"America/Chicago","US/Mountain":"America/Denver","US/Pacific":"America/Los_Angeles","US/Arizona":"America/Phoenix","US/Alaska":"America/Anchorage","US/Hawaii":"Pacific/Honolulu","US/East-Indiana":"America/Indiana/Indianapolis",EST:"America/New_York",EDT:"America/New_York",CST:"America/Chicago",CDT:"America/Chicago",MST:"America/Denver",MDT:"America/Denver",PST:"America/Los_Angeles",PDT:"America/Los_Angeles",AKST:"America/Anchorage",AKDT:"America/Anchorage",HST:"Pacific/Honolulu"})[b]||b}function s(a){if(!a)return"user_provided";let b=String(a).trim().toLowerCase();return"planetary_only"===b||"planetary-only"===b||"planetary"===b?"planetary_only":"whole_sign"===b||"whole-sign"===b||"wholesign"===b||"whole"===b?"whole_sign":"sensitivity_scan"===b||"sensitivity-scan"===b||"scan"===b?"sensitivity_scan":"user_provided"}function t(a,b){let c=function(a){let b=a?.hour,c=a?.minute,d=null!=b&&null!=c,e=a=>String(a).padStart(2,"0");return{birth_time_known:!!d,time_precision:d?"exact":"unknown",effective_time_used:d?`${e(b)}:${e(c)}`:void 0}}(a);if(c.birth_time_known)return c;let d=s(b);return"planetary_only"===d?{birth_time_known:!1,time_precision:"unknown",effective_time_used:void 0}:"whole_sign"===d?{birth_time_known:!1,time_precision:"noon_fallback",effective_time_used:"12:00"}:"sensitivity_scan"===d?{birth_time_known:!1,time_precision:"range_scan",effective_time_used:void 0}:c}function u(a={}){let b=["year","month","day","hour","minute","latitude","longitude"].filter(b=>void 0===a[b]||null===a[b]||""===a[b]);return{isValid:0===b.length,message:b.length?`Missing: ${b.join(", ")}`:"ok"}}function v(a){if(!a||"string"!=typeof a)return null;let b=a.trim().replace(/Âº/g,"\xb0").replace(/[ââ²]/g,"'").replace(/[ââ³]/g,'"'),c=/^\s*(\d{1,3})(?:\s*Â°\s*(\d{1,2})(?:['"]?\s*([\d.]+))?)?\s*([NS])\s*,\s*(\d{1,3})(?:\s*Â°\s*(\d{1,2})(?:['"]?\s*([\d.]+))?)?\s*([EW])\s*$/i.exec(b);if(c){let b=(a,b,c,d)=>{let e=parseInt(a,10)||0,f=e+(parseInt(b||"0",10)||0)/60+(parseFloat(c||"0")||0)/3600;return/S|W/i.test(d)&&(f*=-1),f},d=b(c[1],c[2],c[3],c[4]),e=b(c[5],c[6],c[7],c[8]);if(isFinite(d)&&isFinite(e)&&90>=Math.abs(d)&&180>=Math.abs(e))return l.info("Parsed DMS coordinates",{input:a,output:{lat:d,lon:e}}),{lat:d,lon:e}}let d=/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/.exec(b);if(d){let a=parseFloat(d[1]),b=parseFloat(d[2]);if(isFinite(a)&&isFinite(b)&&90>=Math.abs(a)&&180>=Math.abs(b))return{lat:a,lon:b}}return null}function w(){let a=process.env.RAPIDAPI_KEY;if(!a)throw Error("RAPIDAPI_KEY environment variable is not configured.");return{"content-type":"application/json","x-rapidapi-key":a,"x-rapidapi-host":"astrologer.p.rapidapi.com"}}function x(a){let b=["year","month","day","hour","minute","name","zodiac_type"].filter(b=>void 0===a[b]||null===a[b]||""===a[b]),c="number"==typeof a.latitude&&"number"==typeof a.longitude&&!!a.timezone,d=!!(a.city&&a.nation),e=c||d,f=b.length?`Missing: ${b.join(", ")}`:"";return{isValid:0===b.length&&e,message:[f,e?"":"coords(lat,lon,timezone) OR city,nation required"].filter(Boolean).join("; ")||"ok"}}function y(a){if(!a||"object"!=typeof a)return{};let b={name:a.name||"Subject",year:a.year,month:a.month,day:a.day,hour:a.hour,minute:a.minute,city:a.city,nation:a.nation,latitude:a.latitude??a.lat,longitude:a.longitude??a.lon??a.lng,timezone:r(a.timezone||a.tz_str),zodiac_type:a.zodiac_type||a.zodiac||"Tropic"};if(a.date){let[c,d,e]=a.date.split("-").map(Number);b.year=b.year||e,b.month=b.month||c,b.day=b.day||d}if(a.time){let[c,d]=a.time.split(":").map(Number);b.hour=b.hour||c,b.minute=b.minute||d}if(a.birth_date&&(!b.year||!b.month||!b.day))try{let[c,d,e]=String(a.birth_date).split("-").map(Number);c&&d&&e&&(b.year=c,b.month=d,b.day=e)}catch(a){}if(a.birth_time&&(!b.hour||!b.minute))try{let[c,d]=String(a.birth_time).split(":").map(Number);void 0!==c&&void 0!==d&&(b.hour=c,b.minute=d)}catch(a){}if(b.city||(b.city=a.birth_city||a.city_name||a.town||b.city),b.nation||(b.nation=a.birth_country||a.country||a.country_code||b.nation),b.timezone||(b.timezone=r(a.offset||a.tz||a.tzid||a.time_zone||b.timezone)),a.coordinates){let[c,d]=a.coordinates.split(",").map(a=>parseFloat(a.trim()));b.latitude=b.latitude||c,b.longitude=b.longitude||d}if(!b.latitude||!b.longitude){let c=null;for(let b of["astro","coords","coordinate","coord","location"])if(a[b]&&"string"==typeof a[b]){c=a[b];break}if(c)try{let a=v(c);a&&void 0!==a.lat&&void 0!==a.lon?(b.latitude=b.latitude??a.lat,b.longitude=b.longitude??a.lon,l.info("Coordinate parsing successful",{input:c,output:{lat:a.lat,lon:a.lon}})):l.warn("Coordinate parsing failed",{input:c})}catch(a){l.error("Coordinate parsing error",{error:a.message,input:c})}}if("string"==typeof b.latitude||"string"==typeof b.longitude)try{let a=`${b.latitude},${b.longitude}`,c=v(a);c&&void 0!==c.lat&&void 0!==c.lon&&(b.latitude=c.lat,b.longitude=c.lon,l.info("Individual coordinate parsing successful",{input:a,output:{lat:c.lat,lon:c.lon}}))}catch(a){l.error("Individual coordinate parsing error",{error:a.message,lat:b.latitude,lon:b.longitude})}return b}function z(a={},b={}){if(!a)return{};let c=("number"==typeof a.latitude||"number"==typeof a.lat)&&("number"==typeof a.longitude||"number"==typeof a.lon||"number"==typeof a.lng)&&(a.timezone||a.tz_str),d=!!(a.city&&a.nation),e=r(a.timezone||a.tz_str),f={name:a.name,year:a.year,month:a.month,day:a.day,hour:a.hour,minute:a.minute,zodiac_type:a.zodiac_type||"Tropic"},g=c&&!b.force_city_mode&&!b.suppress_coords;g&&(f.lat=a.latitude??a.lat,f.lng=a.longitude??a.lon??a.lng,f.tz_str=e),d&&(b.require_city||!g)&&(f.city=a.state?`${a.city}, ${a.state}`:a.city,f.nation=a.nation,(!g||b.force_city_mode)&&process.env.GEONAMES_USERNAME&&!b?.suppress_geonames&&(f.geonames_username=process.env.GEONAMES_USERNAME));let h=a.houses_system_identifier||b.houses_system_identifier;return h&&(f.houses_system_identifier=h),f}async function A(a,b,c,d={},e="Natal call"){if(process.env.GEONAMES_USERNAME&&b.city&&b.nation){let f={subject:z(b,{...d,require_city:!0,force_city_mode:!0,suppress_coords:!0,suppress_geonames:!1})};try{return await M(a,{method:"POST",headers:c,body:JSON.stringify(f)},`${e} (city+geonames)`)}catch(a){}}let f={subject:z(b,{...d,require_city:!1,force_city_mode:!1,suppress_geonames:!0})};try{return await M(a,{method:"POST",headers:c,body:JSON.stringify(f)},e)}catch(h){let f=!!(b.city&&b.nation);if(!(h&&"CLIENT_ERROR"===h.code&&h.status>=400&&h.status<500)||!f)throw h;let g={subject:z(b,{...d,require_city:!0,force_city_mode:!0,suppress_coords:!0,suppress_geonames:!0})};return await M(a,{method:"POST",headers:c,body:JSON.stringify(g)},`${e} (city-only)`)}}let B={major:new Set(["conjunction","opposition","square","trine","sextile"]),minor:new Set(["quincunx","sesquiquadrate","semi-square","semi-sextile"]),harmonic:new Set(["quintile","biquintile"])},C={conjunction:8,opposition:8,square:7,trine:7,sextile:5,quincunx:3,sesquiquadrate:3,"semi-square":2,"semi-sextile":2,quintile:2,biquintile:2},D={luminary:12,personal:8,social:7,outer:6,angle:8,point:5,other:6},E=new Set(["Saturn","Jupiter","Chiron","Mean_Node","Mean_South_Node","True_Node","True_South_Node"]),F=new Set(["Sun","Moon","Mercury","Venus","Mars"]),G=new Set(["Jupiter","Saturn","Uranus","Neptune","Pluto"]);function H(a,b,c){let d=a;return("Moon"===b||"Moon"===c)&&(d+=1),(G.has(b)&&F.has(c)||G.has(c)&&F.has(b))&&(d-=1),d<1&&(d=1),d}function I(a){switch(a){case"Sun":case"Moon":return"luminary";case"Mercury":case"Venus":case"Mars":return"personal";case"Jupiter":case"Saturn":return"social";case"Uranus":case"Neptune":case"Pluto":return"outer";case"Ascendant":case"Medium_Coeli":case"Descendant":case"Imum_Coeli":return"angle";case"Chiron":case"Mean_Node":case"True_Node":case"Mean_South_Node":case"True_South_Node":case"Mean_Lilith":return"point";default:return"other"}}function J(a){return({Medium_Coeli:"MC",Imum_Coeli:"IC",Mean_Node:"North Node",Mean_South_Node:"South Node",True_Node:"North Node (True)",True_South_Node:"South Node (True)",Mean_Lilith:"Lilith"})[a]||a}function K(a){let b="major"===a._class?1:"minor"===a._class?.55:"harmonic"===a._class?.45:.4,c=C[a._aspect]||6,d=Math.min(c,Math.max(D[I(a.p1_name)]||6,D[I(a.p2_name)]||6));return d=H(d,a.p1_name,a.p2_name),+(b*(null!=a._orb?Math.max(0,1-a._orb/d):0)*(a.p1_isLuminary||a.p2_isLuminary||a.p1_isAngle||a.p2_isAngle?1.15:1)).toFixed(4)}let L=["year","month","day","hour","minute","name","zodiac_type"];async function M(a,b,c,d=2){for(let e=1;e<=d;e++)try{l.debug(`API call attempt ${e}/${d} for ${c}`);let f=await fetch(a,b);if(!f.ok){if(f.status>=400&&f.status<500&&429!==f.status){let b=f.status,d="";try{d=await f.text()}catch{d="Unable to read response body"}let e=d;try{let a=JSON.parse(d);a.message&&(e=a.message)}catch(a){}if(401===b||403===b){let a=e&&/not subscribed|unauthorized|invalid api key|api key is invalid/i.test(e)?"Verify RAPIDAPI_KEY, subscription plan, and that the key matches this API.":"Authentication / subscription issue likely.";l.error("RapidAPI auth/subscription error",{status:b,operation:c,parsedMessage:e,hint:a});let f=Error(`RapidAPI access denied (${b}): ${e}. ${a}`);throw f.code="RAPIDAPI_SUBSCRIPTION",f.status=b,f.raw=d.slice(0,1200),f}l.error("Client error (non-retryable)",{status:b,operation:c,url:a,body:d.slice(0,1200)});let g=Error(`Client error ${b} for ${c}`);throw g.code="CLIENT_ERROR",g.status=b,g.raw=d.slice(0,1200),g}throw l.warn(`API call failed with status ${f.status}. Retrying...`),Error(`Server error: ${f.status}`)}return f.json()}catch(f){if(e===d||f.message.includes("Non-retryable")){if(l.error(`Failed after ${e} attempts: ${f.message}`,{url:a,operation:c,code:f.code,status:f.status}),"RAPIDAPI_SUBSCRIPTION"===f.code||"CLIENT_ERROR"===f.code)throw f;let b=Error("Service temporarily unavailable. Please try again later.");throw b.code="UPSTREAM_TEMPORARY",b}let b=100*Math.pow(2,e)+100*Math.random();await new Promise(a=>setTimeout(a,b))}}async function N(a,b,d,e={}){if(!b||!b.startDate||!b.endDate)return{};let{buildWindowSamples:f}=c(63626),g={},h={},j={},k=a?.timezone||"UTC",m=q(b.step||"daily"),n=f({start:b.startDate,end:b.endDate,step:m},k),o=[];async function p(a){if(!a||"number"==typeof a.latitude&&"number"==typeof a.longitude&&a.timezone)return a;if(a.city&&a.nation)try{let b=await O({city:a.city,state:a.state,nation:a.nation});if(b&&"number"==typeof b.lat&&"number"==typeof b.lon)return{...a,latitude:b.lat,longitude:b.lon,timezone:r(b.tz||a.timezone||"UTC")}}catch(a){l.warn("ensureCoords geoResolve failed",a.message)}return{...a,latitude:a.latitude??51.48,longitude:a.longitude??0,timezone:r(a.timezone||"UTC")}}let s=("number"==typeof a.latitude||"number"==typeof a.lat)&&("number"==typeof a.longitude||"number"==typeof a.lon||"number"==typeof a.lng)&&!!(a.timezone||a.tz_str);for(let b of n){let c=new Date(b),f=b.slice(0,10),k=await async function(){let b={year:c.getUTCFullYear(),month:c.getUTCMonth()+1,day:c.getUTCDate(),hour:c.getUTCHours(),minute:c.getUTCMinutes(),zodiac_type:"Tropic"};if(s){let c=await p(a);return{...b,latitude:c.latitude,longitude:c.longitude,timezone:"UTC"}}let d=a.state?`${a.city}, ${a.state}`:a.city,e={...b,city:d,nation:a.nation};return process.env.GEONAMES_USERNAME&&(e.geonames_username=process.env.GEONAMES_USERNAME),e}(),m={first_subject:z(a,e),transit_subject:z(k,e),...e};l.debug(`Transit API call for ${f}:`,{active_points:m.active_points||"default",pass_keys:Object.keys(e)}),l.debug(`Full transit API payload for ${f}:`,JSON.stringify(m,null,2)),o.push((async()=>{let b=null,n="transit-aspects-data",o=k.city?"city":"coords",q=0;try{b=await M(i.TRANSIT_ASPECTS,{method:"POST",headers:d,body:JSON.stringify(m)},`Transits for ${a.name} on ${f}`),q++,l.debug(`Transit API response for ${f} (${n}):`,{hasAspects:!!(b&&b.aspects),aspectCount:b&&b.aspects?b.aspects.length:0,responseKeys:b?Object.keys(b):"null response",sample:b&&b.aspects&&b.aspects.length>0?b.aspects[0]:"no aspects"})}catch(a){l.warn(`Primary transit endpoint failed for ${f}:`,a.message)}if((!b||!b.aspects||0===b.aspects.length)&&q<3)try{n="transit-chart",l.info(`Fallback: Trying transit-chart endpoint for ${f}`),b=await M(i.TRANSIT_CHART,{method:"POST",headers:d,body:JSON.stringify(m)},`Transit chart fallback for ${a.name} on ${f}`),q++,b&&!b.aspects&&b.data&&(b.aspects=b.data.aspects||b.aspects),l.debug(`Transit chart fallback response for ${f}:`,{hasAspects:!!(b&&b.aspects),aspectCount:b&&b.aspects?b.aspects.length:0,responseKeys:b?Object.keys(b):"null response"})}catch(a){l.warn(`Transit chart fallback failed for ${f}:`,a.message)}if((!b||!b.aspects||0===b.aspects.length)&&q<3)try{n="formation-switch",l.info(`Formation switch: Trying alternate transit subject for ${f}`);let g=await async function(){let b={year:c.getUTCFullYear(),month:c.getUTCMonth()+1,day:c.getUTCDate(),hour:c.getUTCHours(),minute:c.getUTCMinutes(),zodiac_type:"Tropic"};if(!s&&a.city&&a.nation){let c=await p(a);return{...b,latitude:c.latitude,longitude:c.longitude,timezone:"UTC"}}let d=a.state?`${a.city}, ${a.state}`:a.city||"London",e={...b,city:d,nation:a.nation||"UK"};return process.env.GEONAMES_USERNAME&&(e.geonames_username=process.env.GEONAMES_USERNAME),e}(),h={first_subject:z(a,e),transit_subject:z(g,e),...e};b=await M(i.TRANSIT_ASPECTS,{method:"POST",headers:d,body:JSON.stringify(h)},`Formation switch for ${a.name} on ${f}`),q++,l.debug(`Formation switch response for ${f}:`,{hasAspects:!!(b&&b.aspects),aspectCount:b&&b.aspects?b.aspects.length:0,alternateFormation:g.city?"city-mode":"coords-mode"})}catch(a){l.warn(`Formation switch failed for ${f}:`,a.message)}if(b&&b.aspects&&b.aspects.length>0){g[f]=b.aspects,j[f]={endpoint:n,formation:o,attempts:q,aspect_count:b.aspects.length};let a={},c=b.data?.first_subject||b.data?.firstSubject,d=b.data?.transit||b.data?.transit_subject,e=b=>{if(b&&"object"==typeof b)for(let[c,d]of Object.entries(b))d&&"object"==typeof d&&"retrograde"in d&&(a[d.name||d.body||c]=!!d.retrograde)};e(c),e(d),Object.keys(a).length&&(h[f]=a),l.info(`â Success for ${f}: ${b.aspects.length} aspects via ${n} (attempts: ${q})`)}else l.warn(`â No aspects found for ${f} after ${q} attempts (endpoints: ${n})`),b&&l.debug(`Full raw API response for ${f} (no aspects):`,JSON.stringify(b,null,2)),j[f]={endpoint:n,formation:o,attempts:q,aspect_count:0}})().catch(a=>l.error(`Failed to get transits for ${f}`,a)))}return await Promise.all(o),l.debug(`getTransits completed for ${a.name}:`,{requestedDates:n.length,datesWithData:Object.keys(g).length,totalAspects:Object.values(g).reduce((a,b)=>a+b.length,0),availableDates:Object.keys(g)}),{transitsByDate:g,retroFlagsByDate:h,provenanceByDate:j}}async function O({city:a,state:b,nation:c}){let d=process.env.GEONAMES_USERNAME||"",e=encodeURIComponent(b?`${a}, ${b}`:a),f=encodeURIComponent(c||""),g=`http://api.geonames.org/searchJSON?q=${e}&country=${f}&maxRows=1&username=${encodeURIComponent(d)}`,h=await fetch(g),i=await h.json(),j=i&&Array.isArray(i.geonames)&&i.geonames[0];if(!j)return null;let k=parseFloat(j.lat),l=parseFloat(j.lng),m=null;try{let a=`http://api.geonames.org/timezoneJSON?lat=${k}&lng=${l}&username=${encodeURIComponent(d)}`,b=await fetch(a),c=await b.json();m=c&&(c.timezoneId||c.timezone||null)}catch{}return{lat:k,lon:l,tz:m}}function P(a,b={}){if(!a||0===Object.keys(a).length)return{daily:{},summary:{}};let c=Object.keys(a).sort(),h=null,i=null,j={},k=[],m=[];for(let n=0;n<c.length;n++){let o=c[n],p=a[o]||[],q=function(a){if(!Array.isArray(a))return{raw:[],filtered:[],hooks:[],rejections:[],counts:{raw:0,filtered:0,hooks:0}};let b=[],c=[];for(let d of a){let a=(d.aspect||"").toLowerCase(),e="number"==typeof d.orbit?d.orbit:"number"==typeof d.orb?d.orb:null,f=d.p1_name,g=d.p2_name,h=f===g,i=B.major.has(a)?"major":B.minor.has(a)?"minor":B.harmonic.has(a)?"harmonic":"other",j=I(f),k=I(g),l=Math.min(C[a]||6,Math.max(D[j]||6,D[k]||6));l=H(l,f,g);let m="";h&&(["conjunction","opposition"].includes(a)&&(E.has(f)||["Sun","Moon"].includes(f))||(m="OUT_OF_CAP")),!m&&null!=e&&e>l&&(m="OUT_OF_CAP");let n={...d,_aspect:a,_orb:e,_class:i,_sameBody:h,p1_display:J(f),p2_display:J(g),p1_isLuminary:["Sun","Moon"].includes(f),p2_isLuminary:["Sun","Moon"].includes(g),p1_isAngle:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(f),p2_isAngle:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(g),p1_class:j,p2_class:k,effective_cap:l};m?c.push({aspect:`${f} ${a} ${g}`,reason:m,orb:e}):(n._weight=K(n),b.push(n))}let d=[];for(let a of b).15>(a._weight||0)?c.push({aspect:`${a.p1_name} ${a._aspect} ${a.p2_name}`,reason:"WEAK_WEIGHT",orb:a._orb}):d.push(a);let e=new Set,f=new Map,g=[];for(let a of d){let b=[a.p1_name,a.p2_name].sort().join("|")+"|"+a._aspect;if(e.has(b)){c.push({aspect:`${a.p1_name} ${a._aspect} ${a.p2_name}`,reason:"DUPLICATE_PAIR",orb:a._orb});continue}e.add(b);let d=[];(a.p1_isLuminary||a.p1_isAngle)&&d.push(a.p1_name),(a.p2_isLuminary||a.p2_isAngle)&&d.push(a.p2_name);let h=!1;for(let a of d){let b=(f.get(a)||0)+1;f.set(a,b),b>3&&(h=!0)}if(h){c.push({aspect:`${a.p1_name} ${a._aspect} ${a.p2_name}`,reason:"PRIMARY_DUP",orb:a._orb});continue}g.push(a)}let h=g.filter(a=>{let b=null!=a._orb?a._orb:6.01,c=a.p1_isLuminary||a.p2_isLuminary,d=a.p1_isAngle||a.p2_isAngle,e=["Mean_Node","Mean_South_Node","Chiron"].includes(a.p1_name)||["Mean_Node","Mean_South_Node","Chiron"].includes(a.p2_name);return!!(b<=.5)||!!c&&!!(b<=3)||!!d&&!!(b<=2.5)||!!e&&!!(b<=2)||"major"===a._class&&!!(b<=1.5)}),i=(h.length?h:g.slice(0,8)).slice().sort((a,b)=>{let c=a._orb??6.01,d=b._orb??6.01,e=c<=.5;if(e!==d<=.5)return e?-1:1;let f=a.p1_isLuminary||a.p2_isLuminary;return f!==(b.p1_isLuminary||b.p2_isLuminary)?f?-1:1:c!==d?c-d:(b._weight||0)-(a._weight||0)}).slice(0,12);return{raw:a,filtered:g,hooks:i,rejections:c,counts:{raw:a.length,filtered:g.length,hooks:i.length,rejected:c.length}}}(p),r=b[o]||{},s=q.filtered.map(a=>{let b=r[a.p1_name]??r[a.p1_display]??!1,c=r[a.p2_name]??r[a.p2_display]??!1;return{...a,p1_retrograde:b,p2_retrograde:c,retrograde_involved:b||c}}),t=function(a,b=null){if(!Array.isArray(a)||0===a.length)return{exact:[],tight:[],moderate:[],wide:[],markdown:"No aspects for this date."};let c=new Map;if(b&&Array.isArray(b))for(let a of b){let b=`${a.p1_name}|${a._aspect}|${a.p2_name}`;c.set(b,a._orb)}let d=a.map(a=>{let b=a._orb||0,d=`${a.p1_name}|${a._aspect}|${a.p2_name}`,f=c.get(d),g="â";null!=f&&"number"==typeof f&&(b<f?g="â":b>f&&(g="â"));let h={transit:{body:a.p1_name},natal:{body:a.p2_name},type:a._aspect,orbDeg:b},i=e.scoreAspect(h,{isAngleProx:a.p2_isAngle,critical:!1});return{transit:a.p1_display||a.p1_name,aspect:a._aspect,natal:a.p2_display||a.p2_name,orb:Number(b.toFixed(1)),phase:g,score:Number(i.S.toFixed(2)),_orbValue:b}});d.sort((a,b)=>a._orbValue-b._orbValue);let f=d.filter(a=>a._orbValue<=.5),g=d.filter(a=>a._orbValue>.5&&a._orbValue<=2),h=d.filter(a=>a._orbValue>2&&a._orbValue<=6),i=d.filter(a=>a._orbValue>6);function j(a,b){if(0===a.length)return"";let c=`
**${b}**

`;for(let b of(c+="| Transit | Aspect | Natal | Orb (\xb0) | Phase | Score |\n|---------|--------|-------|---------|--------|-------|\n",a))c+=`| ${b.transit} | ${b.aspect} | ${b.natal} | ${b.orb} | ${b.phase} | ${b.score>=0?"+":""}${b.score} |
`;return c}let k="";return f.length>0&&(k+=j(f,"â­ Exact Aspects (â¤0.5\xb0)")),g.length>0&&(k+=j(g,"\uD83D\uDD25 Tight Aspects (0.5\xb0 - 2\xb0)")),h.length>0&&(k+=j(h,"\uD83D\uDCCA Moderate Aspects (2\xb0 - 6\xb0)")),i.length>0&&(k+=j(i,"\uD83C\uDF2Bï¸ Wide Aspects (>6\xb0)")),""===k&&(k="No aspects for this date."),{exact:f,tight:g,moderate:h,wide:i,markdown:k}}(q.filtered,i),u=d(q.filtered.map(a=>({transit:{body:a.p1_name,retrograde:a.p1_retrograde},natal:{body:a.p2_name,retrograde:a.p2_retrograde,isAngleProx:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(a.p2_name),isLuminary:["Sun","Moon"].includes(a.p2_name),degCrit:!1},type:a._aspect,orbDeg:"number"==typeof a._orb?a._orb:6.01})),h,{rollingContext:k.length>=1?{magnitudes:[...k]}:null}),v="prior",w=k.length;w>=14?v="rolling":w>=2&&(v="blended");let x=Math.min(1,w/14),y=u.originalMagnitude||u.rawMagnitude||u.magnitude;k.push(y),k.length>14&&k.shift(),m.push(u.valence),m.length>7&&m.shift();let z=s.filter(a=>a.retrograde_involved),A=0;if(q.hooks.length>=2){let a=q.hooks.map(a=>a._weight||0),b=a.reduce((a,b)=>a+b,0)/a.length;A=Math.min(10,10*Math.sqrt(a.reduce((a,c)=>a+Math.pow(c-b,2),0)/a.length))}let F=(q.hooks||[]).map(a=>({a:a.p1_name,b:a.p2_name,type:a._aspect||a.aspect||a.type,orb:null!=a._orb?a._orb:"number"==typeof a.orb?a.orb:"number"==typeof a.orbit?a.orbit:null,applying:"boolean"==typeof a.applying?a.applying:void 0,weight:"number"==typeof a._weight?a._weight:K(a),planet1:a.p1_name,planet2:a.p2_name,name:a._aspect||a.aspect||a.type,first_planet:a.p1_name,second_planet:a.p2_name,is_transit:!0})),G={seismograph:{magnitude:u.magnitude,valence:u.valence,volatility:A,rawMagnitude:u.rawMagnitude,originalMagnitude:u.originalMagnitude,scaling_strategy:v,scaling_confidence:+x.toFixed(2)},aspects:p,filtered_aspects:s,hooks:q.hooks,drivers:F,rejections:q.rejections,counts:q.counts,transit_table:t,retrograde_aspects:z,valence_trend:m.length>1?function(a){if(a.length<2)return 0;let b=a.slice(-3);if(b.length<2)return 0;let c=0;for(let a=1;a<b.length;a++)c+=b[a]-b[a-1];return+(c/(b.length-1)).toFixed(2)}(m):0};try{let a=g(q.filtered),{SFD:b,Splus:c,Sminus:d}=f(q.filtered);G.balance={magnitude:u.magnitude,valence:a,version:"v1.1"},G.sfd={sfd:b,sPlus:c,sMinus:d,version:"v1.2"}}catch(a){l.warn("Balance/SFD computation failed for day",o,a.message)}j[o]=G,h={scored:u.scored,Y_effective:u.valence},i=q.filtered}let n=c.length,o=Object.values(j).reduce((a,b)=>a+b.seismograph.magnitude,0)/n,p=Object.values(j).reduce((a,b)=>a+b.seismograph.valence,0)/n,q=Object.values(j).reduce((a,b)=>a+b.seismograph.volatility,0)/n;return{daily:j,summary:{magnitude:+o.toFixed(2),valence:+p.toFixed(2),volatility:+q.toFixed(2)}}}async function Q(a,b,c={},d){try{l.debug("Computing composite for subjects:",{personA:a?.name||"Unknown A",personB:b?.name||"Unknown B"});let e={first_subject:z(a,c),second_subject:z(b,c),...c},f=await M(i.COMPOSITE_ASPECTS,{method:"POST",headers:d,body:JSON.stringify(e)},"Composite aspects"),g=m(f.data||{}),h=Array.isArray(f.aspects)?f.aspects:g.aspects||[];return l.debug("Composite calculation successful, aspects found:",h.length),{aspects:h,raw:g}}catch(a){throw l.error("Composite calculation failed:",a),Error(`Composite calculation failed: ${a.message}`)}}function R(a,b,c){let d=0,e=0,f=0;if(Array.isArray(a))for(let b of a){let a=(b.aspect||b.type||"").toLowerCase(),c=parseFloat(b.orb||6);f++,["trine","sextile","conjunction"].includes(a)&&(d+=Math.max(0,6-c)/6),["square","opposition"].includes(a)&&(e+=Math.max(0,6-c)/6)}let g=f>0?Math.round((d-e)*100)/100:0,h="\uD83C\uDF17";g>1?h="\uD83C\uDF1E":g<-1&&(h="\uD83C\uDF11");let i=Math.min(5,Math.max(0,(d+e)*2));return{relational_sfd:g,relational_magnitude:Math.round(100*i)/100,relational_valence:h,support_score:Math.round(100*d)/100,friction_score:Math.round(100*e)/100,aspect_count:f,climate_description:`Relational field showing ${h} dynamic with ${i.toFixed(1)} intensity`}}function S(a,b,c,d,e){l.debug("Generating comprehensive relational mirror structure");let f=function(a,b,c){if(!Array.isArray(a)||0===a.length)return[];let d=[],e=new Set;for(let f of a.filter(a=>["opposition","square","conjunction"].includes((a.aspect||a.type||"").toLowerCase()))){let a=f.p1_name||f.a||f.first_point||"",g=f.p2_name||f.b||f.second_point||"",h=f.aspect||f.type||"",i=f.orb||f.orbit||0,j=[a,g].sort().join("-");!e.has(j)&&(e.add(j),6>=parseFloat(i)&&d.push({polarity_a:`${b.name||"Person A"}'s ${a}`,polarity_b:`${c.name||"Person B"}'s ${g}`,aspect_type:h,orb_degrees:parseFloat(i),field_description:`${a} ${h} ${g}`,map_pattern:`Cross-chart ${h} creating relational tension`,voice_summary:`Polarity between ${a} and ${g} energies in the relationship`}))}return d.slice(0,3)}(c,a,b),g=function(a,b,c){let d=[];if(!Array.isArray(a))return d;let e={};for(let b of a){let a=b.p1_name||b.a||"",c=b.p2_name||b.b||"",d=b.aspect||b.type||"",f=[a,c].sort().join("-");e[f]||(e[f]=[]),e[f].push({type:d,orb:b.orb||0})}for(let[a,b]of Object.entries(e))if(b.length>1){let[c,e]=a.split("-");d.push({pattern_type:"REF_CYCLE",planets_involved:[c,e],occurrences:b.length,aspects:b,description:`Recurring ${c}-${e} feedback loop`,intensity:b.reduce((a,b)=>a+(6-parseFloat(b.orb||6)),0)})}return d.slice(0,5)}(c,a.aspects,b.aspects),h=function(a,b,c){let d={person_a_tags:[],person_b_tags:[],shared_resonance:[]};return a.aspects&&Array.isArray(a.aspects)&&(d.person_a_tags=a.aspects.filter(a=>3>=parseFloat(a.orb||6)).slice(0,3).map(a=>({vector:`${a.p1_name||a.a}-${a.p2_name||a.b}`,tag:"WB",aspect_type:a.aspect||a.type,orb:a.orb}))),b.aspects&&Array.isArray(b.aspects)&&(d.person_b_tags=b.aspects.filter(a=>3>=parseFloat(a.orb||6)).slice(0,3).map(a=>({vector:`${a.p1_name||a.a}-${a.p2_name||a.b}`,tag:"WB",aspect_type:a.aspect||a.type,orb:a.orb}))),Array.isArray(c)&&(d.shared_resonance=c.filter(a=>4>=parseFloat(a.orb||6)).slice(0,3).map(a=>({vector:`${a.p1_name||a.a}â${a.p2_name||a.b}`,tag:"WB",aspect_type:a.aspect||a.type,orb:a.orb,description:"Cross-chart resonance"}))),d}(a,b,c),i=R(c,d.aspects,e),j=function(a,b){let c=[],d=[];for(let e of(Array.isArray(a)&&d.push(...a.filter(a=>{let b=parseFloat(a.orb||0);return b>4&&b<=8})),Array.isArray(b)&&d.push(...b.filter(a=>{let b=parseFloat(a.orb||0);return b>4&&b<=8})),d.slice(0,3))){let a=e.p1_name||e.a||"",b=e.p2_name||e.b||"",d=e.aspect||e.type||"",f=parseFloat(e.orb||0),g="LATENT",h="structural presence but contained/waiting";["Saturn","Pluto","Neptune"].includes(a)||["Saturn","Pluto","Neptune"].includes(b)?(g="DORMANT",h="waiting for specific activation timing"):f>6&&(g="SUPPRESSED",h="boundaries fortified/compensated by other placements"),c.push({status:g,vector_name:`${a}-${b} ${d}`,orb_degrees:f,structural_presence:!0,behavioral_activity:"contained",description:h})}return c}(c,d.aspects),k={relationship_climate:`${i.climate_description}`,polarity_summary:f.length>0?`${f.length} primary polarity tensions identified`:"No major polarity tensions detected",echo_pattern_summary:g.length>0?`${g.length} recurring feedback loops active`:"No significant echo patterns detected",shared_field_description:`Relational field with ${c?.length||0} cross-chart connections`};return{relational_mirror:{polarity_cards:f,echo_loops:g,sst_tags:h,relational_balance_meter:i,mirror_voice:k,vector_integrity_tags:j,relocation_notes:{relocation_applied:!1,house_system:"Placidus",angles_relocated:!1,baseline_remains_natal:!0,disclosure:"No relocation applied; all angles and houses remain natal"},scaffolding_complete:!0,mirror_type:"true_relational_mirror"}}}async function T(a,b,c,d,e={},f){if(!a)return{transitsByDate:{}};let g={},h=new Date(b),j=new Date(c);j.setDate(j.getDate()+1);let k=[];for(let b=new Date(h);b<j;b.setDate(b.getDate()+1)){let c=b.toISOString().split("T")[0],d={year:b.getUTCFullYear(),month:b.getUTCMonth()+1,day:b.getUTCDate(),hour:12,minute:0,city:"Greenwich",nation:"GB",latitude:51.48,longitude:0,timezone:"UTC",zodiac_type:"Tropic"},h={first_subject:z(a,e),transit_subject:z(d,e),...e};l.debug(`Composite transit API call for ${c}:`,{pass_keys:Object.keys(e),composite_subject:a?.name||"Unknown composite"}),l.debug(`Full composite transit API payload for ${c}:`,JSON.stringify(h,null,2)),k.push(M(i.TRANSIT_ASPECTS,{method:"POST",headers:f,body:JSON.stringify(h)},`Composite transits for ${c}`).then(a=>{l.debug(`Composite transit API response for ${c}:`,{hasAspects:!!(a&&a.aspects),aspectCount:a&&a.aspects?a.aspects.length:0,responseKeys:a?Object.keys(a):"null response"}),a.aspects&&a.aspects.length>0?(g[c]=a.aspects,l.debug(`Stored ${a.aspects.length} composite aspects for ${c}`)):(l.debug(`No composite aspects found for ${c} - response structure:`,a),l.debug(`Full raw composite API response for ${c} (no aspects):`,JSON.stringify(a,null,2)))}).catch(a=>{l.warn(`Failed to get composite transits for ${c}:`,a.message)}))}try{return await Promise.all(k),{transitsByDate:g}}catch(a){return l.error("Composite transits calculation failed:",a),{transitsByDate:{},_note:"Composite transits not available in current plan"}}}function U(){let a=new Date,b=a.toISOString().slice(0,10).replace(/-/g,""),c=a.toTimeString().slice(0,8).replace(/:/g,""),d=Math.random().toString(36).substr(2,4).toUpperCase();return`ERR-${b}-${c}-${d}`}b.resolveCity=async function(a){let b=a.queryStringParameters||{},c=b.city||"",d=b.state||"",e=b.nation||"";try{let a=await O({city:c,state:d,nation:e});return{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify({input:{city:c,state:d,nation:e},resolved:a})}}catch(a){return{statusCode:500,headers:{"content-type":"application/json"},body:JSON.stringify({error:a.message})}}},b.handler=async function(a){try{var b;let d,e,f;if("POST"!==a.httpMethod)return{statusCode:405,body:JSON.stringify({error:"Only POST requests are allowed.",code:"METHOD_NOT_ALLOWED",errorId:U()})};try{d=JSON.parse(a.body||"{}")}catch(a){return{statusCode:400,body:JSON.stringify({error:"Invalid JSON in request body.",code:"INVALID_JSON",errorId:U()})}}process.env.RAPIDAPI_KEY&&process.env.MB_MOCK;let g=y(d.personA||d.person_a||d.first_subject||d.subject),h=y(d.personB||d.person_b||d.second_subject),r=(b=d.context?.mode||d.mode||d.contextMode?.relational||d.contextMode?.solo||"")?b.toString().trim().replace(/[-\s]+/g,"_").replace(/__+/g,"_").toUpperCase():"",v=s(d.time_policy||d.timePolicy||d.birth_time_policy),B="NATAL_ASPECTS"===r||a.path?.includes("natal-aspects-data"),D="BIRTH_DATA"===r||a.path?.includes("birth-data"),E="SYNASTRY"===r||"SYNASTRY_TRANSITS"===r,F="SYNASTRY_ASPECTS"===r||a.path?.includes("synastry-aspects-data"),G="COMPOSITE"===r||"COMPOSITE_ASPECTS"===r||"COMPOSITE_TRANSITS"===r||!0===d.wantComposite,H="SKY_TRANSITS"===r||"WEATHER"===r||d.context?.type==="weather",I="BALANCE_METER"===r||d.context?.mode==="balance_meter",J=!!d.includeTransitTag,K=["PARTNER","FRIEND","FAMILY"],O=["P1","P2","P3","P4","P5a","P5b"],V=["Acquaintance","Mentor","Other","Custom"],W=["Parent","Offspring","Sibling","Cousin","Extended","Guardian","Mentor","Other","Custom"],X={...g},Y=h&&Object.keys(h).length?{...h}:null,Z=a=>a&&(null==a.hour||null==a.minute)&&("planetary_only"===v||"whole_sign"===v||"sensitivity_scan"===v)?{...a,hour:12,minute:0}:a;Object.assign(g,Z(g)),Object.assign(h,Z(h));let $=B||D?u(g):x(g);if(!$.isValid)return{statusCode:400,body:JSON.stringify({error:`Primary subject validation failed: ${$.message}`,code:"VALIDATION_ERROR_A",errorId:U()})};let _=E||F||G;l.debug("Balance Meter decision variables (Part 1):",{wantBalanceMeter:I,modeToken:r,contextMode:d.context?.mode,relationshipMode:_,wantSynastry:E,wantSynastryAspectsOnly:F,wantComposite:G});let aa={errors:{reason:"Not requested"}},ab=function(a,b){if(!b)return{valid:!0,value:null,reason:"Not in relationship mode"};let c=a||d.relationship||d.relationship_context||d.relationshipContext||d.relationalContext||{},e=[],f={};if(f.type=function(a){if(!a)return"";let b=a.toString().trim().toUpperCase();return b.startsWith("FRIEND")||"COLLEAGUE"===b||b.includes("COLLEAGUE")?"FRIEND":b.startsWith("FAMILY")?"FAMILY":b.startsWith("PARTNER")?"PARTNER":b}(c.type||c.relationship_type||c.category),K.includes(f.type)||e.push("relationship.type required (PARTNER|FRIEND|FAMILY)"),"PARTNER"===f.type&&(f.intimacy_tier=(c.intimacy_tier||c.tier||"").toString(),O.includes(f.intimacy_tier)||e.push(`intimacy_tier required for PARTNER (one of ${O.join(",")})`)),"FAMILY"===f.type){let a=(c.role||c.family_role||c.relationship_role||"").toString();f.role=a?a.charAt(0).toUpperCase()+a.slice(1).toLowerCase():"",W.includes(f.role)||e.push(`role required for FAMILY (one of ${W.join(",")})`)}else if("FRIEND"===f.type){let a=(c.role||c.friend_role||c.relationship_role||"").toString();f.role=a?a.charAt(0).toUpperCase()+a.slice(1).toLowerCase():"",f.role&&!V.includes(f.role)&&e.push(`friend role invalid (optional, one of ${V.join(",")})`)}if(void 0!==c.ex_estranged||c.ex||c.estranged||void 0!==c.is_ex_relationship){let a=!!(c.ex_estranged||c.ex||c.estranged||c.is_ex_relationship);"FRIEND"===f.type?e.push("ex_estranged flag not allowed for FRIEND"):f.ex_estranged=a}return(c.notes&&(f.notes=(c.notes||"").toString().slice(0,500)),e.length)?{valid:!1,errors:e,value:f}:{valid:!0,value:f}}(d.relationship_context||d.relationshipContext,_);if(_&&!ab.valid)return{statusCode:400,body:JSON.stringify({error:"Relationship context invalid",code:"REL_CONTEXT_INVALID",errorId:U(),issues:ab.errors||[]})};if(_&&(h.zodiac_type||(h.zodiac_type="Tropic"),!(aa=function(a){let b={};return L.forEach(c=>{(void 0===a[c]||null===a[c]||""===a[c])&&(b[c]="Missing or empty")}),{isValid:0===Object.keys(b).length,errors:b}}(h)).isValid))return{statusCode:400,body:JSON.stringify({error:"Secondary subject validation failed",code:"VALIDATION_ERROR_B",mode:r,errorId:U(),fieldErrors:aa.errors})};let ac=d.window||d.transit_window||null,ad=ac&&(ac.start||ac.startDate)||d.start||d.startDate||d.transitStartDate||d.transit_start_date||d.transitParams?.startDate||d.transit?.startDate,ae=ac&&(ac.end||ac.endDate)||d.end||d.endDate||d.transitEndDate||d.transit_end_date||d.transitParams?.endDate||d.transit?.endDate,af=q(ac&&(ac.step||ac.interval)||d.step||d.interval||d.transitStep||d.transit_step||d.transitParams?.step||d.transit?.step),ag=!!(ad&&ae);l.debug("Balance Meter decision variables (Part 2):",{haveRange:ag,start:ad,end:ae});try{e=w()}catch(a){return{statusCode:500,body:JSON.stringify({error:a.message,code:"CONFIG_ERROR",errorId:U()})}}let ah=a=>a&&"number"==typeof a.latitude&&"number"==typeof a.longitude&&!!a.timezone,ai=d.transit_subject||g,aj=d.transit_subject_B||d.second_transit_subject||h,ak=d.relocation_mode||d.translocation?.method||"None";if(/^midpoint$/i.test(ak))return{statusCode:400,body:JSON.stringify({code:"RELOCATION_UNSUPPORTED",error:"Midpoint relocation is not supported for this protocol. Use A_local or B_local.",errorId:U()})};let al=!!(h&&Object.keys(h).length),am=d.personA?.A_local||d.subjectA?.A_local||null;if(("None"===ak||"Natal"===ak)&&I&&(al?ak="A_local":am&&(ak="A_local")),I){if(!ag)return{statusCode:400,body:JSON.stringify({code:"WINDOW_REQUIRED",error:"Balance Meter requires a time window (start, end, step)",errorId:U()})};let a=!!(am?.city&&am?.nation)||!!(g?.city&&g?.nation),b=!!(h&&(d.personB?.B_local?.city&&d.personB?.B_local?.nation||h.city&&h.nation));if(!ah(ai)&&!a)return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"Balance Meter requires location (coords or city/nation) for A",errorId:U()})};if(h&&Object.keys(h).length&&!ah(aj||{})&&!b)return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"Balance Meter dyad requires location (coords or city/nation) for Person B",errorId:U()})}}else if(("MIRROR"===r||d.context?.mode==="mirror")&&J&&!ah(ai))return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"Mirror with Climate Tag requires location",errorId:U()})};let an=h&&Object.keys(h).length?h:null,ao={...ai},ap=aj?{...aj}:an?{...an}:null;if("Midpoint"===ak&&ap){if("number"!=typeof ao.latitude||"number"!=typeof ao.longitude||"number"!=typeof ap.latitude||"number"!=typeof ap.longitude)return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"Midpoint relocation requires coords for both persons",errorId:U()})};let a=function(a,b,c,d){let e=a=>a*Math.PI/180,f=a=>180*a/Math.PI,g=e(a),h=e(b),i=e(c),j=e(d),k=Math.cos(g)*Math.cos(h),l=Math.cos(g)*Math.sin(h),m=Math.sin(g),n=Math.cos(i)*Math.cos(j),o=Math.cos(i)*Math.sin(j),p=Math.sin(i),q=(k+n)/2,r=(l+o)/2,s=Math.atan2((m+p)/2,Math.sqrt(q*q+r*r)),t=Math.atan2(r,q);return{latitude:f(s),longitude:f(t)}}(ao.latitude,ao.longitude,ap.latitude,ap.longitude);try{let b=c(91750)(a.latitude,a.longitude);ao={...ao,latitude:a.latitude,longitude:a.longitude,timezone:b},ap=ap?{...ap,latitude:a.latitude,longitude:a.longitude,timezone:b}:ap}catch{return{statusCode:422,body:JSON.stringify({code:"HOUSES_UNSTABLE",error:"Midpoint timezone lookup failed; try custom location",errorId:U()})}}}else if("A_local"===ak){let a=am||d.custom_location||null;if(a)if("number"==typeof a.lat&&"number"==typeof a.lon)try{let b=a.tz||c(91750)(a.lat,a.lon);ao={...ao,latitude:a.lat,longitude:a.lon,timezone:b},ap&&(ap={...ap,latitude:a.lat,longitude:a.lon,timezone:b})}catch{return{statusCode:400,body:JSON.stringify({code:"TZ_LOOKUP_FAIL",error:"Could not resolve A_local timezone",errorId:U()})}}else a.city&&a.nation&&(ao={...ao,city:a.city,nation:a.nation},ap&&(ap={...ap,city:a.city,nation:a.nation}))}else if("B_local"===ak){if(an&&ap&&ah(ap));else if(an)return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"B_local requires coords for Person B",errorId:U()})}}else if("Custom"===ak&&d.custom_location){let a=d.custom_location;if("number"!=typeof a.latitude||"number"!=typeof a.longitude)return{statusCode:400,body:JSON.stringify({code:"LOCATION_REQUIRED",error:"Custom relocation requires coords",errorId:U()})};try{let b=a.timezone||c(91750)(a.latitude,a.longitude);ao={...ao,latitude:a.latitude,longitude:a.longitude,timezone:b},ap&&(ap={...ap,latitude:a.latitude,longitude:a.longitude,timezone:b})}catch{return{statusCode:400,body:JSON.stringify({code:"TZ_LOOKUP_FAIL",error:"Could not resolve custom timezone",errorId:U()})}}}try{if(ah(ao)){let a=c(91750)(ao.latitude,ao.longitude);if(ao.timezone&&ao.timezone!==a)return{statusCode:400,body:JSON.stringify({code:"TZ_MISMATCH",error:"Provided timezone does not match coordinates",suggested_timezone:a,errorId:U()})};ao.timezone||(ao.timezone=a)}if(ap&&ah(ap)){let a=c(91750)(ap.latitude,ap.longitude);if(ap.timezone&&ap.timezone!==a)return{statusCode:400,body:JSON.stringify({code:"TZ_MISMATCH",error:"Provided timezone for Person B does not match coordinates",suggested_timezone:a,errorId:U()})};ap.timezone||(ap.timezone=a)}}catch{}let aq=a=>Math.abs(Number(a))>=66;if(ah(ao)&&aq(ao.latitude))return{statusCode:422,body:JSON.stringify({code:"HOUSES_UNSTABLE",error:"House math may be unstable at this latitude; consider whole-sign or different location",errorId:U()})};if(ap&&ah(ap)&&aq(ap.latitude))return{statusCode:422,body:JSON.stringify({code:"HOUSES_UNSTABLE",error:"House math may be unstable for Person B at this latitude; consider whole-sign or different location",errorId:U()})};let ar={schema:"WM-Chart-1.2",provenance:{math_brain_version:n,ephemeris_source:o,build_ts:new Date().toISOString(),timezone:g.timezone||"UTC",calibration_boundary:p,engine_versions:{seismograph:"v1.0",balance:"v1.1",sfd:"v1.2"},time_meta_a:t(X,v),house_system:void 0,orbs_profile:void 0,timezone_db_version:void 0,relocation_mode:ak||"none"},context:{mode:r||"UNKNOWN"},mirror_ready:!0,contract:"clear-mirror/1.2",person_a:{details:X,meta:t(X,v)}};_&&h&&Object.keys(h).length&&(ar.person_b={details:Y||h,meta:t(Y||h,v)},ar.provenance.time_meta_b=t(Y||h,v)),_&&ab.valid&&ab.value&&(ar.relationship=ab.value);try{let a=d.translocation||d.context?.translocation||null;a&&(ar.context.translocation={applies:!!a.applies,method:a.method||(a.applies?"custom":"Natal"),house_system:a.house_system||"Placidus",tz:a.tz||g.timezone||"UTC"})}catch{}let as={};["active_points","active_aspects","houses_system_identifier","sidereal_mode","perspective_type"].forEach(a=>{void 0!==d[a]&&(as[a]=d[a])}),["voice","voice_mode","exclude_person_b","excludePersonB","reflect_mode","ui","display"].forEach(a=>{a in as&&delete as[a]}),as.active_points||(as.active_points=["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","Mean_Node","True_Node","Mean_South_Node","True_South_Node","Chiron","Mean_Lilith","Ascendant","Medium_Coeli","Descendant","Imum_Coeli"],l.debug("Setting default active_points (includes True nodes & full angle set)")),("planetary_only"===v||"sensitivity_scan"===v)&&(as.active_points=as.active_points.filter(a=>!["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(a)),l.debug("Time policy excludes angular points for transits")),"whole_sign"!==v||as.houses_system_identifier||(as.houses_system_identifier="Whole_Sign",l.debug("Time policy set houses_system_identifier=Whole_Sign"));try{ar.provenance.house_system=as.houses_system_identifier||ar.provenance.house_system||"Placidus",ar.provenance.orbs_profile=d.orbs_profile||ar.provenance.orbs_profile||"wm-spec-2025-09",ar.provenance.timezone_db_version=ar.provenance.timezone_db_version||"IANA (system)",ar.provenance.relocation_mode=ak||ar.provenance.relocation_mode||"none"}catch{}as.active_aspects||(as.active_aspects=[{name:"conjunction",orb:8},{name:"opposition",orb:8},{name:"trine",orb:7},{name:"square",orb:7},{name:"sextile",orb:5},{name:"quincunx",orb:3},{name:"sesquiquadrate",orb:3},{name:"semi-square",orb:2},{name:"semi-sextile",orb:2},{name:"quintile",orb:2},{name:"biquintile",orb:2}],l.debug("Setting default active_aspects to Raven caps list"));let at={semisquare:"semi-square",semi_square:"semi-square","semi square":"semi-square",semisextile:"semi-sextile",semi_sextile:"semi-sextile","semi sextile":"semi-sextile",inconjunct:"quincunx","sesqui-square":"sesquiquadrate",sesquisquare:"sesquiquadrate"};if(Array.isArray(as.active_aspects)&&(as.active_aspects=as.active_aspects.map(a=>{if(!a)return null;if("string"==typeof a)return{name:a,orb:3};if("object"==typeof a){let b=(a.name||a.type||"").toString().toLowerCase();return{name:at[b]||b,orb:null!=a.orb?a.orb:3}}return null}).filter(Boolean).reduce((a,b)=>{let c=a.find(a=>a.name===b.name);return c?b.orb>c.orb&&(c.orb=b.orb):a.push(b),a},[]),as.active_aspects=as.active_aspects.map(a=>{let b=C[a.name]||a.orb,c=Math.min(a.orb,b);return a.orb>c&&l.debug(`Clamping orb for ${a.name} from ${a.orb} -> ${c}`),{name:a.name,orb:c}})),l.debug("Normalized + clamped active_aspects list:",as.active_aspects),I)ar.person_a=ar.person_a||{},ar.person_a.details=g;else if(D)f=await A(i.BIRTH_DATA,g,e,as,"Birth data (A)"),ar.person_a.birth_data=m(f.data||{});else if(B){f=await A(i.NATAL_ASPECTS_DATA,g,e,as,"Natal aspects data (A)");let a=m(f.data||{});ar.person_a.chart=a,ar.person_a.aspects=Array.isArray(f.aspects)?f.aspects:a.aspects||[]}else{f=await A(i.BIRTH_CHART,g,e,as,"Birth chart (A)");let a=m(f.data||{});ar.person_a.chart=a,ar.person_a.aspects=Array.isArray(f.aspects)?f.aspects:a.aspects||[]}try{let a=a=>(a?.hour==null||a?.minute==null)&&("planetary_only"===v||"sensitivity_scan"===v);a(X)&&(ar.person_a.houses_suppressed=!0),ar.person_b&&a(Y||h)&&(ar.person_b.houses_suppressed=!0),ar.person_a.meta=Object.assign({},ar.person_a.meta,t(X,v)),ar.person_b&&(ar.person_b.meta=Object.assign({},ar.person_b.meta||{},t(Y||h,v)))}catch{}let au="NATAL_ONLY"===r;if(H&&ag){l.debug("Processing sky transits mode:",{start:ad,end:ae,step:af});try{let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N({name:"Sky Patterns",birth_date:ad,birth_time:"12:00",birth_location:"Greenwich, UK",timezone:"GMT"},{startDate:ad,endDate:ae,step:af},e,as),d=P(a,b);ar.sky_transits={transitsByDate:d.daily,provenanceByDate:c,derived:{seismograph_summary:d.summary,mode:"sky_patterns_only"}},l.debug("Sky transits completed with seismograph analysis")}catch(a){l.warn("Sky transits computation failed:",a.message),ar.sky_transits={error:"Failed to compute sky patterns"}}}else if(ag&&!au){let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N(g,{startDate:ad,endDate:ae,step:af},e,as);ar.person_a.chart={...ar.person_a.chart,transitsByDate:a};let d=Object.values(a).flatMap(a=>a);l.debug(`Transit aspects found: ${d.length} total including outer planets`),ar.person_a.derived=ar.person_a.derived||{},ar.person_a.derived.t2n_aspects=j(d),ar.person_a.transit_data=Object.values(a);let f=P(a,b);ar.person_a.derived.seismograph_summary=f.summary,ar.person_a.chart.transitsByDate=f.daily,ar.person_a.chart.provenanceByDate=c}if(("DUAL_NATAL"===r||"DUAL_NATAL_TRANSITS"===r||!_&&r&&r.startsWith("NATAL")&&h&&Object.keys(h).length)&&h){let a=u(h);if(a.isValid){if(!ar.person_b||!ar.person_b.chart)try{let a=await A(i.BIRTH_CHART,h,e,as,"Birth chart (B dual)"),b=m(a.data||{});ar.person_b={details:h,chart:b,aspects:Array.isArray(a.aspects)?a.aspects:b.aspects||[]}}catch(a){l.warn("Dual Person B natal fetch failed",a.message),ar.person_b={details:h,error:"Failed to compute Person B chart"}}if(ag&&!au&&"DUAL_NATAL_TRANSITS"===r)try{let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N(h,{startDate:ad,endDate:ae,step:af},e,as),d=Object.values(a).flatMap(a=>a),f=P(a,b);ar.person_b.chart={...ar.person_b.chart||{},transitsByDate:f.daily,provenanceByDate:c},ar.person_b.derived=ar.person_b.derived||{},ar.person_b.derived.seismograph_summary=f.summary,ar.person_b.derived.t2n_aspects=j(d),ar.person_b.transit_data=Object.values(a)}catch(a){l.warn("Dual Person B transits fetch failed",a.message),ar.person_b.transits_error="Failed to compute Person B transits"}}else ar.person_b={details:h,validation_error:a.message}}if(ag&&!au&&!_&&h&&Object.keys(h).length&&r&&r.startsWith("NATAL")&&r.includes("TRANSITS")&&"DUAL_NATAL_TRANSITS"!==r){let a=u(h);if(a.isValid){if(!ar.person_b||!ar.person_b.chart)try{let a=await A(i.BIRTH_CHART,h,e,as,"Birth chart (B implicit dual)"),b=m(a.data||{});ar.person_b={details:h,chart:b,aspects:Array.isArray(a.aspects)?a.aspects:b.aspects||[]}}catch(a){l.warn("Implicit dual Person B natal fetch failed",a.message),ar.person_b={...ar.person_b||{},details:h,error:"Failed to compute Person B chart"}}if(!(ar.person_b&&ar.person_b.chart&&ar.person_b.chart.transitsByDate))try{let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N(h,{startDate:ad,endDate:ae,step:af},e,as),d=Object.values(a).flatMap(a=>a),f=P(a,b);ar.person_b.chart={...ar.person_b.chart||{},transitsByDate:f.daily,provenanceByDate:c},ar.person_b.derived=ar.person_b.derived||{},ar.person_b.derived.seismograph_summary=f.summary,ar.person_b.derived.t2n_aspects=j(d),ar.person_b.transit_data=Object.values(a),ar.person_b.implicit_dual_transits=!0}catch(a){l.warn("Implicit dual Person B transits fetch failed",a.message),ar.person_b.transits_error="Failed to compute Person B transits"}}else ar.person_b={...ar.person_b||{},details:h,validation_error:a.message}}let av=u(h),aw=x(h);if(F&&av.isValid){let a=await M(i.SYNASTRY_ASPECTS,{method:"POST",headers:e,body:JSON.stringify({first_subject:z(g,{...as,require_city:!0}),second_subject:z(h,{...as,require_city:!0})})},"Synastry aspects data"),b=m(a.data||{});ar.person_b={...ar.person_b||{},details:h},ar.synastry_aspects=Array.isArray(a.aspects)?a.aspects:b.aspects||[],ar.synastry_data=b;let c=S(ar.person_a||{details:g,aspects:[]},{details:h,aspects:[]},ar.synastry_aspects,{aspects:[],raw:{}},{});ar.synastry_relational_mirror=c.relational_mirror,l.debug("Added relational mirror to synastry-aspects-only mode");try{let a=await A(i.BIRTH_CHART,h,e,as,"Birth chart (B for synastry-aspects)"),b=m(a.data||{});ar.person_b.chart=b}catch(a){l.warn("Could not augment synastry-aspects with Person B natal chart",a.message)}}else if(E&&aw.isValid){let a=await M(i.SYNASTRY_CHART,{method:"POST",headers:e,body:JSON.stringify({first_subject:z(g,{...as,require_city:!0}),second_subject:z(h,{...as,require_city:!0})})},"Synastry chart"),b=m(a.data||{});ar.person_b={details:h,chart:b.second_subject||{}},ar.synastry_aspects=Array.isArray(a.aspects)?a.aspects:b.aspects||[];let c=S(ar.person_a||{details:g,aspects:[]},ar.person_b,ar.synastry_aspects,{aspects:[],raw:{}},{});if(ar.synastry_relational_mirror=c.relational_mirror,l.debug("Added relational mirror to full synastry mode"),"SYNASTRY_TRANSITS"===r&&ag&&!au){l.debug("Computing Person B transits for synastry mode:",{start:ad,end:ae,step:af});let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N(h,{startDate:ad,endDate:ae,step:af},e,as);ar.person_b.chart={...ar.person_b.chart,transitsByDate:a};let d=P(a,b);ar.person_b.chart.transitsByDate=d.daily,ar.person_b.chart.provenanceByDate=c,ar.person_b.derived={seismograph_summary:d.summary,t2n_aspects:j(Object.values(a).flatMap(a=>a))},l.debug("Person B transits completed for synastry mode")}}let ax=h?u(h):{isValid:!1};if(G&&ax.isValid){let a=await Q(g,h,as,e);if(ar.person_b&&ar.person_b.chart)ar.person_b={...ar.person_b||{},details:h};else try{l.debug("Fetching Person B natal chart for composite scaffolding");let a=await A(i.BIRTH_CHART,h,e,as,"Birth chart (B for composite scaffolding)"),b=m(a.data||{});ar.person_b={...ar.person_b||{},details:h,chart:b,aspects:Array.isArray(a.aspects)?a.aspects:b.aspects||[]},l.debug("Person B natal chart added to composite scaffolding")}catch(a){l.warn("Could not fetch Person B natal chart for composite scaffolding",a.message),ar.person_b={...ar.person_b||{},details:h}}try{l.debug("Computing synastry aspects for composite scaffolding");let b=await M(i.SYNASTRY_ASPECTS,{method:"POST",headers:e,body:JSON.stringify({first_subject:z(g,as),second_subject:z(h,as)})},"Synastry aspects for composite scaffolding"),c=m(b.data||{}),d=Array.isArray(b.aspects)?b.aspects:c.aspects||[],f=S(ar.person_a||{details:g,aspects:[]},ar.person_b||{details:h,aspects:[]},d,a,{});ar.composite={aspects:a.aspects,data:a.raw,synastry_aspects:d,synastry_data:c,...f},l.debug(`Added ${d.length} synastry aspects and complete relational mirror to composite scaffolding`)}catch(c){l.warn("Could not compute synastry aspects for composite scaffolding",c.message);let b=S(ar.person_a||{details:g,aspects:[]},ar.person_b||{details:h,aspects:[]},[],a,{});ar.composite={aspects:a.aspects,data:a.raw,...b}}if(ag&&!au&&"COMPOSITE_TRANSITS"===r){l.debug("Computing composite transits for date range:",{start:ad,end:ae,step:af});let b=await T(a.raw,ad,ae,af,as,e);ar.composite.transitsByDate=b.transitsByDate,b._note&&(ar.composite.note=b._note);let c=P(b.transitsByDate,{});if(ar.composite.transitsByDate=c.daily,ar.composite.derived={seismograph_summary:c.summary},ar.composite.relational_mirror){let a=R(ar.composite.synastry_aspects||[],ar.composite.aspects||[],c.daily);ar.composite.relational_mirror.relational_balance_meter=a,l.debug("Updated relational Balance Meter with composite transit data")}"COMPOSITE_TRANSITS"!==r&&(ar.composite.auto_transits_included=!0,ar.composite.request_mode=r),l.debug("Composite transits completed with seismograph analysis")}ag&&!au&&"COMPOSITE_TRANSITS"!==r&&(ar.composite.transitsByDate={},ar.composite.note="Composite transits temporarily disabled due to API compatibility issues",l.debug("Composite transits disabled - returning empty transit data"))}if(l.debug("Checking Balance Meter conditions:",{wantBalanceMeter:I,haveRange:ag,relationshipMode:_,shouldRunBalanceMeter:I&&ag&&!_}),I&&ag&&!_){if(l.debug("Processing Balance Meter mode for standalone report"),!ar.person_a?.chart?.transitsByDate)try{let{transitsByDate:a,retroFlagsByDate:b,provenanceByDate:c}=await N(g,{startDate:ad,endDate:ae,step:af},e,as),d=P(a,b);ar.person_a=ar.person_a||{},ar.person_a.derived=ar.person_a.derived||{},ar.person_a.derived.seismograph_summary=d.summary,ar.person_a.chart={...ar.person_a.chart||{},transitsByDate:d.daily,provenanceByDate:c}}catch(a){l.warn("Balance Meter fallback transit compute failed:",a.message)}if(ar.person_a?.chart?.transitsByDate){let a={period:{start:ad,end:ae,step:af},schema_version:"1.2",channel_summary:ar.person_a.derived?.seismograph_summary||null,daily_entries:ar.person_a.chart.transitsByDate,person:{name:g.name||"Subject",birth_date:g.birth_date,birth_time:g.birth_time,birth_location:g.birth_location}};ar.balance_meter=a,ar.mode="balance_meter",l.debug("Balance Meter standalone report generated successfully")}else l.warn("Balance Meter requested but no transits available to compute report")}if(_){let a=[];if((E||F)&&!ar.person_b&&a.push("person_b"),G&&!ar.composite&&a.push("composite"),a.length)throw Object.assign(Error("PIPELINE_DROPPED_B"),{code:"PIPELINE_DROPPED_B",missing:a})}try{if("A_local"===ak){let a=am||d.custom_location||null;if(a&&"number"==typeof a.lat&&"number"==typeof a.lon){let b=a.tz||ao?.timezone||null;ar.provenance.relocation_coords={lat:a.lat,lon:a.lon,tz:b}}}else if("Midpoint"===ak)"number"==typeof ao?.latitude&&"number"==typeof ao?.longitude&&ao?.timezone&&(ar.provenance.relocation_coords={lat:ao.latitude,lon:ao.longitude,tz:ao.timezone});else if("Custom"===ak){let a=d.custom_location;a&&"number"==typeof a.latitude&&"number"==typeof a.longitude&&(ar.provenance.relocation_coords={lat:a.latitude,lon:a.longitude,tz:ao?.timezone||a.timezone||null})}}catch{}try{let a=ar.provenance.house_system,b={P:"Placidus",W:"Whole Sign",R:"Regiomontanus",K:"Koch",C:"Campanus",E:"Equal"};"string"==typeof a&&1===a.length&&b[a]&&(ar.provenance.house_system_name=b[a])}catch{}try{let a=ad&&ae?{start:ad,end:ae,step:af}:null;ar.woven_map=k({result:ar,mode:r,period:a})}catch(a){l.warn("Woven Map composer failed:",a.message)}let ay=function a(b){if(!b||"object"!=typeof b)return b;if(Array.isArray(b))return b.map(a);let c={};for(let[d,e]of Object.entries(b))"field"!==d&&"voice"!==d&&"map"!==d&&(c[d]=a(e));return c}(ar);return{statusCode:200,body:JSON.stringify(ay)}}catch(a){return l.error("Handler error:",a),{statusCode:500,body:JSON.stringify({error:a?.message||"Internal server error",code:a?.code||"INTERNAL_ERROR",errorId:U(),stack:a?.stack||null,details:a})}}},b.resolveCity=async function(a){try{let b=a.queryStringParameters||{},c=b.city,d=b.state,e=b.nation||"US";if(!c)return{statusCode:400,body:JSON.stringify({error:"city parameter required"})};let f=d?`${c}, ${d}`:c,g={name:"Test Resolution",year:2025,month:1,day:1,hour:12,minute:0,city:f,nation:e,zodiac_type:"Tropic"};process.env.GEONAMES_USERNAME&&(g.geonames_username=process.env.GEONAMES_USERNAME);let h=w(),j={name:g.name,year:g.year,month:g.month,day:g.day,hour:g.hour,minute:g.minute,city:g.city,nation:g.nation,zodiac_type:g.zodiac_type,...g.geonames_username&&{geonames_username:g.geonames_username}},k=await M(i.BIRTH_DATA,{method:"POST",headers:h,body:JSON.stringify(j)},`City resolution test for ${f}, ${e}`),m={success:!0,query:{city:c,state:d,nation:e,formatted:f},resolved:{latitude:k.lat||k.latitude,longitude:k.lng||k.longitude,timezone:k.tz_str||k.timezone,city_resolved:k.city,nation_resolved:k.nation},geonames_used:!!g.geonames_username,raw_response:k};return l.info(`City resolution: ${f}, ${e} -> ${m.resolved.latitude}, ${m.resolved.longitude}`),{statusCode:200,headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}}catch(a){return l.error("City resolution error:",a),{statusCode:500,body:JSON.stringify({success:!1,error:a.message||"City resolution failed",details:a})}}};let V=global.__RC_COLD_START_TS||Date.now();global.__RC_COLD_START_TS=V;let W=global.__RC_HEALTH_INVOCATIONS||0;async function X(a){let b=new AbortController,c=setTimeout(()=>b.abort(),3500);try{let d=await fetch(`${i.NOW}`,{method:"GET",headers:a,signal:b.signal}),e=d.ok,f=d.status;return clearTimeout(c),{ok:e,status:f}}catch(a){return clearTimeout(c),{ok:!1,error:"AbortError"===a.name?"timeout":a.message}}}global.__RC_HEALTH_INVOCATIONS=W,b.health=async function(a){W++;let b=a&&a.queryStringParameters||{},c=!!process.env.RAPIDAPI_KEY,d=null;if(("ping"in b||"now"in b)&&c)try{d=await X(w())}catch(a){d={ok:!1,error:a.message}}return{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify({success:!0,service:"astrology-mathbrain",version:n,ephemeris_source:o,calibration_boundary:p,timestamp:new Date().toISOString(),environment:"production",rapidapi:{configured:c,ping:d},cold_start_ms:Date.now()-V,invocations:W,uptime_s:process.uptime(),memory:(()=>{try{let a=process.memoryUsage();return{rss:a.rss,heapUsed:a.heapUsed,heapTotal:a.heapTotal}}catch{return null}})()})}}},23270:(a,b,c)=>{"use strict";let{composeHookStack:d}=c(13715);function e(a,b=null){let c=Number(a);return Number.isFinite(c)?c:b}function f(a,b,c){return Math.max(b,Math.min(c,a))}a.exports={composeWovenMapReport:function({result:a,mode:b,period:c}){let g=a.person_a||{},h=a.person_b||null,i=function(a,b){let c=(a||"").toUpperCase();return c.includes("SYNASTRY")||c.includes("COMPOSITE")||b?"relational":"solo"}(b,!!h),j=g.derived?.seismograph_summary||null,k=function(a){if(!a)return null;let b=e(a.magnitude,0)||0,c=e(a.valence,0)||0,d=e(a.volatility,0)||0,g=f(b/5,0,1),h=f(d/5,0,1),i=(f(c,-2,2)+2)/4,j=a=>Math.round(100*f(a,0,1));return{fertile_field:j(.7*i+(1-h)*.3),harmonic_resonance:j(.6*i+(1-h)*.4),expansion_lift:j(.6*g+.4*i),combustion_clarity:j(.5*g+.5*h),liberation_release:j(.7*h+(1-i)*.3),integration:j((1-h)*.6+.4*i)}}(j),l=function(a){if(!a||"object"!=typeof a)return[];let b=[];for(let[c,d]of Object.entries(a)){let a={date:c,magnitude:e(d?.magnitude),valence:e(d?.valence),volatility:e(d?.volatility),drivers:Array.isArray(d?.drivers)?d.drivers:void 0};b.push(a)}return b.sort((a,b)=>(a.date||"").localeCompare(b.date||"")),b}(g.chart?.transitsByDate),m=d(a,{maxHooks:4,minIntensity:8});return{schema:"WM-WovenMap-1.0",type:i,context:{mode:b,period:c||null,translocation:a?.context?.translocation||null,person_a:{name:g?.details?.name||"Subject",birth_date:g?.details?.birth_date||null,birth_time:g?.details?.birth_time||null,coordinates:g?.details?.latitude!=null&&g?.details?.longitude!=null?{lat:g.details.latitude,lon:g.details.longitude}:null,timezone:g?.details?.timezone||null},person_b:h?{name:h?.details?.name||"Subject B",birth_date:h?.details?.birth_date||null,birth_time:h?.details?.birth_time||null,coordinates:h?.details?.latitude!=null&&h?.details?.longitude!=null?{lat:h.details.latitude,lon:h.details.longitude}:null,timezone:h?.details?.timezone||null}:null},balance_meter:j?{magnitude:j.magnitude,valence:j.valence,volatility:j.volatility}:null,hook_stack:m,integration_factors:k,time_series:l,natal_summary:function(a){if(!a)return null;let b=a.chart||{},c=a.birth_data||{},d=b.planets||c.planets||null;return{placements:d,angles:b.angles||c.angles||null,major_aspects:Array.isArray(a.aspects)?a.aspects:b.aspects||[]}}(g),vector_integrity:{latent:[],suppressed:[],method:"stub-0"},polarity_cards:function(a){let b=a?.chart?.transitsByDate||{},c=[];for(let[a,d]of Object.entries(b))Array.isArray(d?.drivers)&&d.drivers.length&&c.push({date:a,drivers:d.drivers.slice(0,3)});let d=c.slice(0,7);return[{id:"card_1",field_tone:null,map_geometry:d,voice_slot:null},{id:"card_2",field_tone:null,map_geometry:d,voice_slot:null},{id:"card_3",field_tone:null,map_geometry:d,voice_slot:null}]}(g),mirror_voice:null,raw_geometry:function(a){let b=a.person_a||{},c=a.person_b||null,d={solo:{natal_placements:b.chart?.planets||b.birth_data?.planets||null,angles:b.chart?.angles||b.birth_data?.angles||null,natal_aspects:Array.isArray(b.aspects)?b.aspects:b.chart?.aspects||[],transit_logs:b.chart?.transitsByDate||null}};return c&&(d.relational={person_b_natal_placements:c.chart?.planets||c.birth_data?.planets||null,person_b_angles:c.chart?.angles||c.birth_data?.angles||null,person_b_natal_aspects:Array.isArray(c.aspects)?c.aspects:c.chart?.aspects||[],b_transit_logs:c.chart?.transitsByDate||null}),d}(a),provenance:a.provenance||null}}}},34091:a=>{"use strict";a.exports={mapT2NAspects:function(a){return Array.isArray(a)?a.map(a=>({p1:a.p1_name,p2:a.p2_name,aspect:a.aspect,orb:a.orbit,retrograde:!!(a.p2_retrograde||a.retrograde),isOuter:["Saturn","Uranus","Neptune","Pluto"].includes(a.p2_name),isPersonal:["Sun","Moon","Mercury","Venus","Mars","ASC","MC"].includes(a.p1_name),hard:["square","opposition","conjunction"].includes(a.aspect)})):[]}}},63626:(a,b,c)=>{"use strict";let{DateTime:d}=c(45875);a.exports={localNoonToUTC:function(a,b){let c;if(!b||"string"!=typeof b)throw Error("localNoonToUTC requires an IANA timezone string");if(/^\d{4}-\d{2}-\d{2}$/.test(a))c=d.fromISO(a,{zone:b}).set({hour:12,minute:0,second:0,millisecond:0});else{let e=/[Zz]|[+\-]\d{2}:\d{2}$/.test(a);if(!(c=d.fromISO(a,{zone:e?void 0:b})).isValid)throw Error("Invalid ISO date/time: "+a)}return c.toUTC().toISO()},buildWindowSamples:function(a,b){if(!a||!a.start||!a.end||!a.step)throw Error("Invalid window object");let{start:c,end:e,step:f}=a,g=d.fromISO(c,{zone:b}),h=d.fromISO(e,{zone:b});if(!g.isValid||!h.isValid)throw Error("Invalid window dates for timezone "+b);let i=d.fromISO(c,{zone:b}).set({hour:12,minute:0,second:0,millisecond:0}),j=[],k="weekly"===f?{days:7}:{days:1};for(;i<=h.set({hour:23,minute:59,second:59});)j.push(i.toUTC().toISO()),i=i.plus(k);return j}}},78335:()=>{},96487:()=>{},98622:a=>{"use strict";function b(a,c=2){return Math.round(a*10**c)/10**c}function c(a){let b=String(a||"").toLowerCase().trim();return({opposition:"opposition",opp:"opposition",square:"square",sq:"square",trine:"trine",tri:"trine",sextile:"sextile",sex:"sextile",conjunction:"conjunction",conj:"conjunction",quintile:"quintile",biquintile:"biquintile",quincunx:"quincunx",inconjunct:"quincunx","semi-square":"semi-square",sesquisquare:"sesquiquadrate",sesquiquadrate:"sesquiquadrate","semi-sextile":"semi-sextile"})[b]||b}function d(a){return a?String(("string"==typeof a?a:a.name||a.body||"")||"").trim():""}function e(a){switch(a){case"Sun":case"Moon":return"luminary";case"Mercury":case"Venus":case"Mars":return"personal";case"Jupiter":case"Saturn":return"social";case"Uranus":case"Neptune":case"Pluto":return"outer";case"Ascendant":case"Medium_Coeli":case"Descendant":case"Imum_Coeli":return"angle";case"Chiron":case"Mean_Node":case"True_Node":case"Mean_South_Node":case"True_South_Node":case"Mean_Lilith":return"point";default:return"other"}}function f(a){return"Jupiter"===a||"Venus"===a}function g(a,b,c,d){let f=e(c),g=e(d),h="quintile"===a||"biquintile"===a||"quincunx"===a||"sesquiquadrate"===a||"semi-square"===a||"semi-sextile"===a,i=a=>"luminary"===a||"angle"===a?6:"point"===a?3:4,j=Math.max(i(f),i(g)),k=h?1:j,l=Math.abs(Number(b||0));return!(l>=0)||l>=k?0:+(1-l/k)}function h(a,b){let c=new Set([e(a),e(b)]),d=1;return c.has("angle")&&(d*=1.2),c.has("luminary")&&(d*=1.1),c.has("personal")&&(d*=1.05),d}function i(a,b){switch(b){case"support":if("Jupiter"===a||"Venus"===a)return 1.4;if("Moon"===a||"Saturn"===a)return 1.2;return 1;case"counter":if("Mars"===a||"Saturn"===a||"Pluto"===a||"Chiron"===a)return 1.2;if("Neptune"===a)return 1.1;return 1;default:return 1}}function j(a,b,c){switch(a){case"trine":return 1.5;case"sextile":return 1;case"conjunction":if(f(b)||f(c))return 1.2;return 0;default:return 0}}function k(a,b,c){if("trine"!==a&&"sextile"!==a)return!1;let d=new Set([b,c]);return d.has("Moon")&&d.has("Saturn")}function l(a){return"quintile"===a||"biquintile"===a}function m(a,b,c){let d=new Set([b,c]);return("square"===a||"opposition"===a)&&(d.has("Jupiter")||d.has("Venus"))?-1.3:"conjunction"===a&&(d.has("Saturn")||d.has("Pluto")||d.has("Chiron"))&&(d.has("Jupiter")||d.has("Venus"))?-.8:0}a.exports={computeSFD:function(a){if(!Array.isArray(a))return{SFD:0,Splus:0,Sminus:0};let e=0,f=0,n=new Set;for(let b of a){let a=c(b.aspect||b.type||b._aspect),f=d(b.p1_name||b.a||b.transit),m=d(b.p2_name||b.b||b.natal),o=null!=b.orb?b.orb:null!=b.orbit?b.orbit:b._orb,p=j(a,f,m);if(k(a,f,m)&&(p=Math.max(p,1.2)),l(a)&&1>=Math.abs(o)&&(p=Math.max(p,.5)),p>0){let b=i(f,"support"),c=i(m,"support");e+=Math.max(p*b*c*g(a,o,f,m)*h(f,m),0),n.add(f),n.add(m)}}let o=(a,b)=>n.has(a)||n.has(b);for(let b of a){let a=c(b.aspect||b.type||b._aspect),e=d(b.p1_name||b.a||b.transit),j=d(b.p2_name||b.b||b.natal),k=null!=b.orb?b.orb:null!=b.orbit?b.orbit:b._orb,l=0;l=Math.min(0,m(a,e,j));let p="square"===a||"opposition"===a,q=new Set([...n]);p&&("Saturn"===e||"Mars"===e||"Neptune"===e||"Saturn"===j||"Mars"===j||"Neptune"===j)&&(q.has(e)||q.has(j))&&(l=Math.min(l,-1.1));let r=new Set(["Moon","Mercury"]);if(p&&("Saturn"===e||"Neptune"===e||"Saturn"===j||"Neptune"===j)&&(r.has(e)||r.has(j))&&(q.has("Moon")||q.has("Mercury"))&&(l=Math.min(l,-1.1)),p&&("Mars"===e||"Mars"===j)&&("Venus"===e||"Jupiter"===e||"Venus"===j||"Jupiter"===j)&&(l=Math.min(l,-1.2)),p&&("Saturn"===e||"Saturn"===j)&&("Venus"===e||"Venus"===j)&&(l=Math.min(l,-1.1)),l<0){let b=i(e,"counter"),c=i(j,"counter"),d=Math.abs(l)*b*c*g(a,k,e,j)*h(e,j);o(e,j)||(d*=.7),f+=Math.max(d,0)}}let p=+(5*Math.tanh(e/4)).toFixed(2),q=+(5*Math.tanh(f/4)).toFixed(2);return{SFD:b(Math.max(-5,Math.min(5,p-q)),2),Splus:p,Sminus:q}},computeBalanceValence:function(a){if(!Array.isArray(a))return 0;let e=0;for(let b of a){let a,f=c(b.aspect||b.type||b._aspect),n=d(b.p1_name||b.a||b.transit),o=d(b.p2_name||b.b||b.natal),p=null!=b.orb?b.orb:null!=b.orbit?b.orbit:b._orb,q=g(f,p,n,o),r=h(n,o);a=0+j(f,n,o),k(f,n,o)&&(a=Math.max(a,1.2)),l(f)&&1>=Math.abs(p)&&(a=Math.max(a,.5));let s=m(f,n,o),t=i(n,a>0?"support":"counter"),u=i(o,a>0?"support":"counter");e+=((a>0?a:0)+(s<0?s:0))*t*u*q*r}return b(5*Math.tanh(e/4),2)}}}};