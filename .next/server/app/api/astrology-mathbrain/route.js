"use strict";(()=>{var e={};e.id=935,e.ids=[935],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2866:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var r={};a.r(r),a.d(r,{GET:()=>u,OPTIONS:()=>p,POST:()=>c});var s=a(9303),n=a(8716),i=a(670),o=a(7070);let l=a(7772);async function u(e){let t=new URL(e.url),a={};e.headers.forEach((e,t)=>{a[t]=e});let r={httpMethod:"GET",queryStringParameters:Object.fromEntries(t.searchParams),headers:a,body:null,path:t.pathname,pathParameters:null,requestContext:{},resource:"",stageVariables:null,isBase64Encoded:!1},s={callbackWaitsForEmptyEventLoop:!1,functionName:"astrology-mathbrain",functionVersion:"$LATEST",invokedFunctionArn:"",memoryLimitInMB:"1024",awsRequestId:crypto.randomUUID(),logGroupName:"",logStreamName:"",getRemainingTimeInMillis:()=>3e4};try{let e=await l.handler(r,s);return new o.NextResponse(e.body,{status:e.statusCode,headers:new Headers(e.headers||{})})}catch(e){return console.error("Astrology MathBrain API error:",e),o.NextResponse.json({success:!1,error:"Internal server error",code:"ASTROLOGY_API_ERROR"},{status:500})}}async function c(e){try{let t=await e.text(),a=new URL(e.url),r={};e.headers.forEach((e,t)=>{r[t]=e});let s={httpMethod:"POST",queryStringParameters:Object.fromEntries(a.searchParams),headers:r,body:t,path:a.pathname,pathParameters:null,requestContext:{},resource:"",stageVariables:null,isBase64Encoded:!1},n={callbackWaitsForEmptyEventLoop:!1,functionName:"astrology-mathbrain",functionVersion:"$LATEST",invokedFunctionArn:"",memoryLimitInMB:"1024",awsRequestId:crypto.randomUUID(),logGroupName:"",logStreamName:"",getRemainingTimeInMillis:()=>3e4},i=await l.handler(s,n);return new o.NextResponse(i.body,{status:i.statusCode,headers:new Headers(i.headers||{})})}catch(e){return console.error("Astrology MathBrain API error:",e),o.NextResponse.json({success:!1,error:"Internal server error",code:"ASTROLOGY_API_ERROR"},{status:500})}}async function p(e){return new o.NextResponse("",{status:200,headers:new Headers({"Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type","Access-Control-Allow-Methods":"GET, POST, OPTIONS"})})}let d=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/astrology-mathbrain/route",pathname:"/api/astrology-mathbrain",filename:"route",bundlePath:"app/api/astrology-mathbrain/route"},resolvedPagePath:"/Users/dancross/Documents/GitHub/WovenWebApp/app/api/astrology-mathbrain/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:_,serverHooks:h}=d,y="/api/astrology-mathbrain/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}},7772:(e,t,a)=>{let{aggregate:r}=a(9693),{_internals:s}=a(9693),{computeSFD:n,computeBalanceValence:i}=a(276),o="https://astrologer.p.rapidapi.com",l={BIRTH_CHART:`${o}/api/v4/birth-chart`,NATAL_ASPECTS_DATA:`${o}/api/v4/natal-aspects-data`,SYNASTRY_CHART:`${o}/api/v4/synastry-chart`,TRANSIT_CHART:`${o}/api/v4/transit-chart`,TRANSIT_ASPECTS:`${o}/api/v4/transit-aspects-data`,SYNASTRY_ASPECTS:`${o}/api/v4/synastry-aspects-data`,BIRTH_DATA:`${o}/api/v4/birth-data`,NOW:`${o}/api/v4/now`,COMPOSITE_ASPECTS:`${o}/api/v4/composite-aspects-data`},{mapT2NAspects:u}=a(5084),c={info:(...e)=>console.info("[INFO]",...e),warn:(...e)=>console.warn("[WARN]",...e),error:(...e)=>console.error("[ERROR]",...e),debug:(...e)=>"debug"===process.env.LOG_LEVEL&&console.debug("[DEBUG]",...e)};function p(e){if(!e||"object"!=typeof e)return e;let t=new Set(["wheel","svg","image","images","chart_image","graphical","png","jpg","jpeg","pdf","wheel_url","image_url","chartUrl","rendered_svg","rendered_png"]);if(Array.isArray(e))return e.map(p);let a={};for(let[r,s]of Object.entries(e))t.has(r)||(s&&"object"==typeof s?a[r]=p(s):a[r]=s);return a}let d="0.2.1",m="AstrologerAPI-v4",_="2025-09-05";function h(e={}){let t=["year","month","day","hour","minute","latitude","longitude"].filter(t=>void 0===e[t]||null===e[t]||""===e[t]);return{isValid:0===t.length,message:t.length?`Missing: ${t.join(", ")}`:"ok"}}function y(e){if(!e||"string"!=typeof e)return null;let t=e.trim().replace(/º/g,"\xb0").replace(/[’′]/g,"'").replace(/[”″]/g,'"'),a=/^\s*(\d{1,3})(?:\s*°\s*(\d{1,2})(?:['"]?\s*([\d.]+))?)?\s*([NS])\s*,\s*(\d{1,3})(?:\s*°\s*(\d{1,2})(?:['"]?\s*([\d.]+))?)?\s*([EW])\s*$/i.exec(t);if(a){let t=(e,t,a,r)=>{let s=(parseInt(e,10)||0)+(parseInt(t||"0",10)||0)/60+(parseFloat(a||"0")||0)/3600;return/S|W/i.test(r)&&(s*=-1),s},r=t(a[1],a[2],a[3],a[4]),s=t(a[5],a[6],a[7],a[8]);if(isFinite(r)&&isFinite(s)&&90>=Math.abs(r)&&180>=Math.abs(s))return c.info("Parsed DMS coordinates",{input:e,output:{lat:r,lon:s}}),{lat:r,lon:s}}let r=/^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/.exec(t);if(r){let e=parseFloat(r[1]),t=parseFloat(r[2]);if(isFinite(e)&&isFinite(t)&&90>=Math.abs(e)&&180>=Math.abs(t))return{lat:e,lon:t}}return null}function f(){let e=process.env.RAPIDAPI_KEY;if(!e)throw Error("RAPIDAPI_KEY environment variable is not configured.");return{"content-type":"application/json","x-rapidapi-key":e,"x-rapidapi-host":"astrologer.p.rapidapi.com"}}function g(e){let t=["year","month","day","hour","minute","name","city","nation","latitude","longitude","zodiac_type","timezone"].filter(t=>void 0===e[t]||null===e[t]||""===e[t]);return{isValid:0===t.length,message:t.length?`Missing: ${t.join(", ")}`:"ok"}}function b(e){if(!e||"object"!=typeof e)return{};let t={name:e.name||"Subject",year:e.year,month:e.month,day:e.day,hour:e.hour,minute:e.minute,city:e.city,nation:e.nation,latitude:e.latitude??e.lat,longitude:e.longitude??e.lon??e.lng,timezone:e.timezone,zodiac_type:e.zodiac_type||e.zodiac||"Tropic"};if(e.date){let[a,r,s]=e.date.split("-").map(Number);t.year=t.year||s,t.month=t.month||a,t.day=t.day||r}if(e.time){let[a,r]=e.time.split(":").map(Number);t.hour=t.hour||a,t.minute=t.minute||r}if(e.birth_date&&(!t.year||!t.month||!t.day))try{let[a,r,s]=String(e.birth_date).split("-").map(Number);a&&r&&s&&(t.year=a,t.month=r,t.day=s)}catch(e){}if(e.birth_time&&(!t.hour||!t.minute))try{let[a,r]=String(e.birth_time).split(":").map(Number);void 0!==a&&void 0!==r&&(t.hour=a,t.minute=r)}catch(e){}if(t.city||(t.city=e.birth_city||e.city_name||e.town||t.city),t.nation||(t.nation=e.birth_country||e.country||e.country_code||t.nation),t.timezone||(t.timezone=e.offset||e.tz||e.tzid||e.time_zone||t.timezone),e.coordinates){let[a,r]=e.coordinates.split(",").map(e=>parseFloat(e.trim()));t.latitude=t.latitude||a,t.longitude=t.longitude||r}if(!t.latitude||!t.longitude){let a=null;for(let t of["astro","coords","coordinate","coord","location"])if(e[t]&&"string"==typeof e[t]){a=e[t];break}if(a)try{let e=y(a);e&&void 0!==e.lat&&void 0!==e.lon?(t.latitude=t.latitude??e.lat,t.longitude=t.longitude??e.lon,c.info("Coordinate parsing successful",{input:a,output:{lat:e.lat,lon:e.lon}})):c.warn("Coordinate parsing failed",{input:a})}catch(e){c.error("Coordinate parsing error",{error:e.message,input:a})}}if("string"==typeof t.latitude||"string"==typeof t.longitude)try{let e=`${t.latitude},${t.longitude}`,a=y(e);a&&void 0!==a.lat&&void 0!==a.lon&&(t.latitude=a.lat,t.longitude=a.lon,c.info("Individual coordinate parsing successful",{input:e,output:{lat:a.lat,lon:a.lon}}))}catch(e){c.error("Individual coordinate parsing error",{error:e.message,lat:t.latitude,lon:t.longitude})}return t}let S={major:new Set(["conjunction","opposition","square","trine","sextile"]),minor:new Set(["quincunx","sesquiquadrate","semi-square","semi-sextile"]),harmonic:new Set(["quintile","biquintile"])},A={conjunction:10,opposition:10,square:8,trine:8,sextile:6,quincunx:3,sesquiquadrate:3,"semi-square":2,"semi-sextile":2,quintile:2,biquintile:2},M={luminary:12,personal:8,social:7,outer:6,angle:8,point:5,other:6},T=new Set(["Saturn","Jupiter","Chiron","Mean_Node","Mean_South_Node","True_Node","True_South_Node"]);function N(e){switch(e){case"Sun":case"Moon":return"luminary";case"Mercury":case"Venus":case"Mars":return"personal";case"Jupiter":case"Saturn":return"social";case"Uranus":case"Neptune":case"Pluto":return"outer";case"Ascendant":case"Medium_Coeli":case"Descendant":case"Imum_Coeli":return"angle";case"Chiron":case"Mean_Node":case"True_Node":case"Mean_South_Node":case"True_South_Node":case"Mean_Lilith":return"point";default:return"other"}}function v(e){return({Medium_Coeli:"MC",Imum_Coeli:"IC",Mean_Node:"North Node",Mean_South_Node:"South Node",True_Node:"North Node (True)",True_South_Node:"South Node (True)",Mean_Lilith:"Lilith"})[e]||e}let C=["year","month","day","hour","minute","name","city","nation","latitude","longitude","timezone","zodiac_type"];async function w(e,t,a,r=2){for(let s=1;s<=r;s++)try{c.debug(`API call attempt ${s}/${r} for ${a}`);let n=await fetch(e,t);if(!n.ok){if(n.status>=400&&n.status<500&&429!==n.status){let t=n.status,r="";try{r=await n.text()}catch{r="Unable to read response body"}let s=r;try{let e=JSON.parse(r);e.message&&(s=e.message)}catch(e){}if(401===t||403===t){let e=s&&/not subscribed|unauthorized|invalid api key|api key is invalid/i.test(s)?"Verify RAPIDAPI_KEY, subscription plan, and that the key matches this API.":"Authentication / subscription issue likely.";c.error("RapidAPI auth/subscription error",{status:t,operation:a,parsedMessage:s,hint:e});let n=Error(`RapidAPI access denied (${t}): ${s}. ${e}`);throw n.code="RAPIDAPI_SUBSCRIPTION",n.status=t,n.raw=r.slice(0,1200),n}c.error("Client error (non-retryable)",{status:t,operation:a,url:e,body:r.slice(0,1200)});let i=Error(`Client error ${t} for ${a}`);throw i.code="CLIENT_ERROR",i.status=t,i.raw=r.slice(0,1200),i}throw c.warn(`API call failed with status ${n.status}. Retrying...`),Error(`Server error: ${n.status}`)}return n.json()}catch(n){if(s===r||n.message.includes("Non-retryable")){if(c.error(`Failed after ${s} attempts: ${n.message}`,{url:e,operation:a,code:n.code,status:n.status}),"RAPIDAPI_SUBSCRIPTION"===n.code||"CLIENT_ERROR"===n.code)throw n;let t=Error("Service temporarily unavailable. Please try again later.");throw t.code="UPSTREAM_TEMPORARY",t}let t=100*Math.pow(2,s)+100*Math.random();await new Promise(e=>setTimeout(e,t))}}async function P(e,t,a,r={}){if(!t||!t.startDate||!t.endDate)return{};let s={},n={},i=new Date(t.startDate),o=new Date(t.endDate);o.setDate(o.getDate()+1);let u=[];for(let t=new Date(i);t<o;t.setDate(t.getDate()+1)){let i=t.toISOString().split("T")[0],o={first_subject:e,transit_subject:{year:t.getUTCFullYear(),month:t.getUTCMonth()+1,day:t.getUTCDate(),hour:12,minute:0,city:"Greenwich",nation:"GB",latitude:51.48,longitude:0,timezone:"UTC",zodiac_type:"Tropic"},...r};c.debug(`Transit API call for ${i}:`,{active_points:o.active_points||"default",pass_keys:Object.keys(r)}),c.debug(`Full transit API payload for ${i}:`,JSON.stringify(o,null,2)),u.push(w(l.TRANSIT_ASPECTS,{method:"POST",headers:a,body:JSON.stringify(o)},`Transits for ${e.name} on ${i}`).then(e=>{if(c.debug(`Transit API response for ${i}:`,{hasAspects:!!(e&&e.aspects),aspectCount:e&&e.aspects?e.aspects.length:0,responseKeys:e?Object.keys(e):"null response",sample:e&&e.aspects&&e.aspects.length>0?e.aspects[0]:"no aspects"}),e.aspects&&e.aspects.length>0){s[i]=e.aspects;let t={},a=e.data?.first_subject||e.data?.firstSubject,r=e.data?.transit||e.data?.transit_subject,o=e=>{if(e&&"object"==typeof e)for(let[a,r]of Object.entries(e))r&&"object"==typeof r&&"retrograde"in r&&(t[r.name||r.body||a]=!!r.retrograde)};o(a),o(r),Object.keys(t).length&&(n[i]=t),c.debug(`Stored ${e.aspects.length} aspects for ${i}`)}else c.debug(`No aspects found for ${i} - response structure:`,e),c.debug(`Full raw API response for ${i} (no aspects):`,JSON.stringify(e,null,2))}).catch(e=>c.error(`Failed to get transits for ${i}`,e)))}return await Promise.all(u),c.debug(`getTransits completed for ${e.name}:`,{requestedDates:Math.ceil((o-i)/864e5),datesWithData:Object.keys(s).length,totalAspects:Object.values(s).reduce((e,t)=>e+t.length,0),availableDates:Object.keys(s)}),{transitsByDate:s,retroFlagsByDate:n}}function D(e,t={}){if(!e||0===Object.keys(e).length)return{daily:{},summary:{}};let a=Object.keys(e).sort(),o=null,l=null,u={},p=[],d=[];for(let m=0;m<a.length;m++){let _=a[m],h=e[_]||[],y=function(e){if(!Array.isArray(e))return{raw:[],filtered:[],hooks:[],rejections:[],counts:{raw:0,filtered:0,hooks:0}};let t=[],a=[];for(let r of e){let e=(r.aspect||"").toLowerCase(),s="number"==typeof r.orbit?r.orbit:"number"==typeof r.orb?r.orb:null,n=r.p1_name,i=r.p2_name,o=n===i,l=S.major.has(e)?"major":S.minor.has(e)?"minor":S.harmonic.has(e)?"harmonic":"other",u=N(n),c=N(i),p=Math.min(A[e]||6,Math.max(M[u]||6,M[c]||6)),d="";o&&(["conjunction","opposition"].includes(e)&&(T.has(n)||["Sun","Moon"].includes(n))||(d="OUT_OF_CAP")),!d&&null!=s&&s>p&&(d="OUT_OF_CAP");let m={...r,_aspect:e,_orb:s,_class:l,_sameBody:o,p1_display:v(n),p2_display:v(i),p1_isLuminary:["Sun","Moon"].includes(n),p2_isLuminary:["Sun","Moon"].includes(i),p1_isAngle:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(n),p2_isAngle:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(i),p1_class:u,p2_class:c,effective_cap:p};d?a.push({aspect:`${n} ${e} ${i}`,reason:d,orb:s}):(m._weight=function(e){let t="major"===e._class?1:"minor"===e._class?.55:"harmonic"===e._class?.45:.4,a=A[e._aspect]||6,r=M[N(e.p1_name)]||6,s=M[N(e.p2_name)]||6;return+(t*(null!=e._orb?Math.max(0,1-e._orb/Math.min(a,Math.max(r,s))):0)*(e.p1_isLuminary||e.p2_isLuminary||e.p1_isAngle||e.p2_isAngle?1.15:1)).toFixed(4)}(m),t.push(m))}let r=[];for(let e of t).15>(e._weight||0)?a.push({aspect:`${e.p1_name} ${e._aspect} ${e.p2_name}`,reason:"WEAK_WEIGHT",orb:e._orb}):r.push(e);let s=new Set,n=new Map,i=[];for(let e of r){let t=[e.p1_name,e.p2_name].sort().join("|")+"|"+e._aspect;if(s.has(t)){a.push({aspect:`${e.p1_name} ${e._aspect} ${e.p2_name}`,reason:"DUPLICATE_PAIR",orb:e._orb});continue}s.add(t);let r=[];(e.p1_isLuminary||e.p1_isAngle)&&r.push(e.p1_name),(e.p2_isLuminary||e.p2_isAngle)&&r.push(e.p2_name);let o=!1;for(let e of r){let t=(n.get(e)||0)+1;n.set(e,t),t>3&&(o=!0)}if(o){a.push({aspect:`${e.p1_name} ${e._aspect} ${e.p2_name}`,reason:"PRIMARY_DUP",orb:e._orb});continue}i.push(e)}let o=i.filter(e=>{let t=null!=e._orb?e._orb:6.01,a=e.p1_isLuminary||e.p2_isLuminary,r=e.p1_isAngle||e.p2_isAngle,s=["Mean_Node","Mean_South_Node","Chiron"].includes(e.p1_name)||["Mean_Node","Mean_South_Node","Chiron"].includes(e.p2_name);return t<=.5||!!a&&t<=3||!!r&&t<=2.5||!!s&&t<=2||"major"===e._class&&t<=1.5}),l=(o.length?o:i.slice(0,8)).slice().sort((e,t)=>{let a=e._orb??6.01,r=t._orb??6.01,s=a<=.5;if(s!==r<=.5)return s?-1:1;let n=e.p1_isLuminary||e.p2_isLuminary;return n!==(t.p1_isLuminary||t.p2_isLuminary)?n?-1:1:a!==r?a-r:(t._weight||0)-(e._weight||0)}).slice(0,12);return{raw:e,filtered:i,hooks:l,rejections:a,counts:{raw:e.length,filtered:i.length,hooks:l.length,rejected:a.length}}}(h),f=t[_]||{},g=y.filtered.map(e=>{let t=f[e.p1_name]??f[e.p1_display]??!1,a=f[e.p2_name]??f[e.p2_display]??!1;return{...e,p1_retrograde:t,p2_retrograde:a,retrograde_involved:t||a}}),b=function(e,t=null){if(!Array.isArray(e)||0===e.length)return{exact:[],tight:[],moderate:[],wide:[],markdown:"No aspects for this date."};let a=new Map;if(t&&Array.isArray(t))for(let e of t){let t=`${e.p1_name}|${e._aspect}|${e.p2_name}`;a.set(t,e._orb)}let r=e.map(e=>{let t=e._orb||0,r=`${e.p1_name}|${e._aspect}|${e.p2_name}`,n=a.get(r),i="—";null!=n&&"number"==typeof n&&(t<n?i="↑":t>n&&(i="↓"));let o={transit:{body:e.p1_name},natal:{body:e.p2_name},type:e._aspect,orbDeg:t},l=s.scoreAspect(o,{isAngleProx:e.p2_isAngle,critical:!1});return{transit:e.p1_display||e.p1_name,aspect:e._aspect,natal:e.p2_display||e.p2_name,orb:Number(t.toFixed(1)),phase:i,score:Number(l.S.toFixed(2)),_orbValue:t}});r.sort((e,t)=>e._orbValue-t._orbValue);let n=r.filter(e=>e._orbValue<=.5),i=r.filter(e=>e._orbValue>.5&&e._orbValue<=2),o=r.filter(e=>e._orbValue>2&&e._orbValue<=6),l=r.filter(e=>e._orbValue>6);function u(e,t){if(0===e.length)return"";let a=`
**${t}**

`;for(let t of(a+="| Transit | Aspect | Natal | Orb (\xb0) | Phase | Score |\n|---------|--------|-------|---------|--------|-------|\n",e))a+=`| ${t.transit} | ${t.aspect} | ${t.natal} | ${t.orb} | ${t.phase} | ${t.score>=0?"+":""}${t.score} |
`;return a}let c="";return n.length>0&&(c+=u(n,"⭐ Exact Aspects (≤0.5\xb0)")),i.length>0&&(c+=u(i,"\uD83D\uDD25 Tight Aspects (0.5\xb0 - 2\xb0)")),o.length>0&&(c+=u(o,"\uD83D\uDCCA Moderate Aspects (2\xb0 - 6\xb0)")),l.length>0&&(c+=u(l,"\uD83C\uDF2B️ Wide Aspects (>6\xb0)")),""===c&&(c="No aspects for this date."),{exact:n,tight:i,moderate:o,wide:l,markdown:c}}(y.filtered,l),C=r(y.filtered.map(e=>({transit:{body:e.p1_name,retrograde:e.p1_retrograde},natal:{body:e.p2_name,retrograde:e.p2_retrograde,isAngleProx:["Ascendant","Medium_Coeli","Descendant","Imum_Coeli"].includes(e.p2_name),isLuminary:["Sun","Moon"].includes(e.p2_name),degCrit:!1},type:e._aspect,orbDeg:"number"==typeof e._orb?e._orb:6.01})),o,{rollingContext:p.length>=1?{magnitudes:[...p]}:null}),w="prior",P=p.length;P>=14?w="rolling":P>=2&&(w="blended");let D=Math.min(1,P/14),O=C.originalMagnitude||C.rawMagnitude||C.magnitude;p.push(O),p.length>14&&p.shift(),d.push(C.valence),d.length>7&&d.shift();let R=g.filter(e=>e.retrograde_involved),I=0;if(y.hooks.length>=2){let e=y.hooks.map(e=>e._weight||0),t=e.reduce((e,t)=>e+t,0)/e.length;I=Math.min(10,10*Math.sqrt(e.reduce((e,a)=>e+Math.pow(a-t,2),0)/e.length))}let x={seismograph:{magnitude:C.magnitude,valence:C.valence,volatility:I,rawMagnitude:C.rawMagnitude,originalMagnitude:C.originalMagnitude,scaling_strategy:w,scaling_confidence:+D.toFixed(2)},aspects:h,filtered_aspects:g,hooks:y.hooks,rejections:y.rejections,counts:y.counts,transit_table:b,retrograde_aspects:R,valence_trend:d.length>1?function(e){if(e.length<2)return 0;let t=e.slice(-3);if(t.length<2)return 0;let a=0;for(let e=1;e<t.length;e++)a+=t[e]-t[e-1];return+(a/(t.length-1)).toFixed(2)}(d):0};try{let e=i(y.filtered),{SFD:t,Splus:a,Sminus:r}=n(y.filtered);x.balance={magnitude:C.magnitude,valence:e,version:"v1.1"},x.sfd={sfd:t,sPlus:a,sMinus:r,version:"v1.2"}}catch(e){c.warn("Balance/SFD computation failed for day",_,e.message)}u[_]=x,o={scored:C.scored,Y_effective:C.valence},l=y.filtered}let m=a.length,_=Object.values(u).reduce((e,t)=>e+t.seismograph.magnitude,0)/m,h=Object.values(u).reduce((e,t)=>e+t.seismograph.valence,0)/m,y=Object.values(u).reduce((e,t)=>e+t.seismograph.volatility,0)/m;return{daily:u,summary:{magnitude:+_.toFixed(2),valence:+h.toFixed(2),volatility:+y.toFixed(2)}}}async function O(e,t,a={},r){try{c.debug("Computing composite for subjects:",{personA:e?.name||"Unknown A",personB:t?.name||"Unknown B"});let s={first_subject:e,second_subject:t,...a},n=await w(l.COMPOSITE_ASPECTS,{method:"POST",headers:r,body:JSON.stringify(s)},"Composite aspects"),i=p(n.data||{}),o=Array.isArray(n.aspects)?n.aspects:i.aspects||[];return c.debug("Composite calculation successful, aspects found:",o.length),{aspects:o,raw:i}}catch(e){throw c.error("Composite calculation failed:",e),Error(`Composite calculation failed: ${e.message}`)}}function R(e,t,a,r,s){c.debug("Generating comprehensive relational mirror structure");let n=function(e,t,a){if(!Array.isArray(e)||0===e.length)return[];let r=[],s=new Set;for(let n of e.filter(e=>["opposition","square","conjunction"].includes((e.aspect||e.type||"").toLowerCase()))){let e=n.p1_name||n.a||n.first_point||"",i=n.p2_name||n.b||n.second_point||"",o=n.aspect||n.type||"",l=n.orb||n.orbit||0,u=[e,i].sort().join("-");!s.has(u)&&(s.add(u),6>=parseFloat(l)&&r.push({polarity_a:`${t.name||"Person A"}'s ${e}`,polarity_b:`${a.name||"Person B"}'s ${i}`,aspect_type:o,orb_degrees:parseFloat(l),field_description:`${e} ${o} ${i}`,map_pattern:`Cross-chart ${o} creating relational tension`,voice_summary:`Polarity between ${e} and ${i} energies in the relationship`}))}return r.slice(0,3)}(a,e,t),i=function(e,t,a){let r=[];if(!Array.isArray(e))return r;let s={};for(let t of e){let e=t.p1_name||t.a||"",a=t.p2_name||t.b||"",r=t.aspect||t.type||"",n=[e,a].sort().join("-");s[n]||(s[n]=[]),s[n].push({type:r,orb:t.orb||0})}for(let[e,t]of Object.entries(s))if(t.length>1){let[a,s]=e.split("-");r.push({pattern_type:"REF_CYCLE",planets_involved:[a,s],occurrences:t.length,aspects:t,description:`Recurring ${a}-${s} feedback loop`,intensity:t.reduce((e,t)=>e+(6-parseFloat(t.orb||6)),0)})}return r.slice(0,5)}(a,e.aspects,t.aspects),o=function(e,t,a){let r={person_a_tags:[],person_b_tags:[],shared_resonance:[]};if(e.aspects&&Array.isArray(e.aspects)){let t=e.aspects.filter(e=>3>=parseFloat(e.orb||6)).slice(0,3);r.person_a_tags=t.map(e=>({vector:`${e.p1_name||e.a}-${e.p2_name||e.b}`,tag:"WB",aspect_type:e.aspect||e.type,orb:e.orb}))}if(t.aspects&&Array.isArray(t.aspects)){let e=t.aspects.filter(e=>3>=parseFloat(e.orb||6)).slice(0,3);r.person_b_tags=e.map(e=>({vector:`${e.p1_name||e.a}-${e.p2_name||e.b}`,tag:"WB",aspect_type:e.aspect||e.type,orb:e.orb}))}if(Array.isArray(a)){let e=a.filter(e=>4>=parseFloat(e.orb||6)).slice(0,3);r.shared_resonance=e.map(e=>({vector:`${e.p1_name||e.a}↔${e.p2_name||e.b}`,tag:"WB",aspect_type:e.aspect||e.type,orb:e.orb,description:"Cross-chart resonance"}))}return r}(e,t,a),l=function(e,t,a){let r=0,s=0,n=0;if(Array.isArray(e))for(let t of e){let e=(t.aspect||t.type||"").toLowerCase(),a=parseFloat(t.orb||6);n++,["trine","sextile","conjunction"].includes(e)&&(r+=Math.max(0,6-a)/6),["square","opposition"].includes(e)&&(s+=Math.max(0,6-a)/6)}let i=n>0?Math.round((r-s)*100)/100:0,o="\uD83C\uDF17";i>1?o="\uD83C\uDF1E":i<-1&&(o="\uD83C\uDF11");let l=Math.min(5,Math.max(0,(r+s)*2));return{relational_sfd:i,relational_magnitude:Math.round(100*l)/100,relational_valence:o,support_score:Math.round(100*r)/100,friction_score:Math.round(100*s)/100,aspect_count:n,climate_description:`Relational field showing ${o} dynamic with ${l.toFixed(1)} intensity`}}(a,r.aspects,0),u=function(e,t){let a=[],r=[];for(let s of(Array.isArray(e)&&r.push(...e.filter(e=>{let t=parseFloat(e.orb||0);return t>4&&t<=8})),Array.isArray(t)&&r.push(...t.filter(e=>{let t=parseFloat(e.orb||0);return t>4&&t<=8})),r.slice(0,3))){let e=s.p1_name||s.a||"",t=s.p2_name||s.b||"",r=s.aspect||s.type||"",n=parseFloat(s.orb||0),i="LATENT",o="structural presence but contained/waiting";["Saturn","Pluto","Neptune"].includes(e)||["Saturn","Pluto","Neptune"].includes(t)?(i="DORMANT",o="waiting for specific activation timing"):n>6&&(i="SUPPRESSED",o="boundaries fortified/compensated by other placements"),a.push({status:i,vector_name:`${e}-${t} ${r}`,orb_degrees:n,structural_presence:!0,behavioral_activity:"contained",description:o})}return a}(a,r.aspects),p={relationship_climate:`${l.climate_description}`,polarity_summary:n.length>0?`${n.length} primary polarity tensions identified`:"No major polarity tensions detected",echo_pattern_summary:i.length>0?`${i.length} recurring feedback loops active`:"No significant echo patterns detected",shared_field_description:`Relational field with ${a?.length||0} cross-chart connections`};return{relational_mirror:{polarity_cards:n,echo_loops:i,sst_tags:o,relational_balance_meter:l,mirror_voice:p,vector_integrity_tags:u,relocation_notes:{relocation_applied:!1,house_system:"Placidus",angles_relocated:!1,baseline_remains_natal:!0,disclosure:"No relocation applied; all angles and houses remain natal"},scaffolding_complete:!0,mirror_type:"true_relational_mirror"}}}function I(){let e=new Date,t=e.toISOString().slice(0,10).replace(/-/g,""),a=e.toTimeString().slice(0,8).replace(/:/g,""),r=Math.random().toString(36).substr(2,4).toUpperCase();return`ERR-${t}-${a}-${r}`}t.handler=async function(e){try{var t;let a,r,s;if("POST"!==e.httpMethod)return{statusCode:405,body:JSON.stringify({error:"Only POST requests are allowed.",code:"METHOD_NOT_ALLOWED",errorId:I()})};try{a=JSON.parse(e.body||"{}")}catch(e){return{statusCode:400,body:JSON.stringify({error:"Invalid JSON in request body.",code:"INVALID_JSON",errorId:I()})}}let n=b(a.personA||a.person_a||a.first_subject||a.subject),i=b(a.personB||a.person_b||a.second_subject),o=(t=a.context?.mode||a.mode||a.contextMode?.relational||a.contextMode?.solo||"")?t.toString().trim().replace(/[-\s]+/g,"_").replace(/__+/g,"_").toUpperCase():"",y="NATAL_ASPECTS"===o||e.path?.includes("natal-aspects-data"),S="BIRTH_DATA"===o||e.path?.includes("birth-data"),A="SYNASTRY"===o||"SYNASTRY_TRANSITS"===o,M="SYNASTRY_ASPECTS"===o||e.path?.includes("synastry-aspects-data"),T="COMPOSITE"===o||"COMPOSITE_ASPECTS"===o||"COMPOSITE_TRANSITS"===o||!0===a.wantComposite,N="SKY_TRANSITS"===o||"WEATHER"===o||a.context?.type==="weather",v="BALANCE_METER"===o||a.context?.mode==="balance_meter",x=["PARTNER","FRIEND","FAMILY"],E=["P1","P2","P3","P4","P5a","P5b"],j=["Acquaintance","Mentor","Other","Custom"],$=["Parent","Offspring","Sibling","Cousin","Extended","Guardian","Mentor","Other","Custom"],q=y||S?h(n):g(n);if(!q.isValid)return{statusCode:400,body:JSON.stringify({error:`Primary subject validation failed: ${q.message}`,code:"VALIDATION_ERROR_A",errorId:I()})};let B=A||M||T;c.debug("Balance Meter decision variables (Part 1):",{wantBalanceMeter:v,modeToken:o,contextMode:a.context?.mode,relationshipMode:B,wantSynastry:A,wantSynastryAspectsOnly:M,wantComposite:T});let L={errors:{reason:"Not requested"}},F=function(e,t){if(!t)return{valid:!0,value:null,reason:"Not in relationship mode"};let r=e||a.relationship||a.relationship_context||a.relationshipContext||a.relationalContext||{},s=[],n={};if(n.type=function(e){if(!e)return"";let t=e.toString().trim().toUpperCase();return t.startsWith("FRIEND")||"COLLEAGUE"===t||t.includes("COLLEAGUE")?"FRIEND":t.startsWith("FAMILY")?"FAMILY":t.startsWith("PARTNER")?"PARTNER":t}(r.type||r.relationship_type||r.category),x.includes(n.type)||s.push("relationship.type required (PARTNER|FRIEND|FAMILY)"),"PARTNER"!==n.type||(n.intimacy_tier=(r.intimacy_tier||r.tier||"").toString(),E.includes(n.intimacy_tier)||s.push(`intimacy_tier required for PARTNER (one of ${E.join(",")})`)),"FAMILY"===n.type){let e=(r.role||r.family_role||r.relationship_role||"").toString(),t=e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():"";n.role=t,$.includes(n.role)||s.push(`role required for FAMILY (one of ${$.join(",")})`)}else if("FRIEND"===n.type){let e=(r.role||r.friend_role||r.relationship_role||"").toString(),t=e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():"";n.role=t,n.role&&!j.includes(n.role)&&s.push(`friend role invalid (optional, one of ${j.join(",")})`)}if(void 0!==r.ex_estranged||r.ex||r.estranged||void 0!==r.is_ex_relationship){let e=!!(r.ex_estranged||r.ex||r.estranged||r.is_ex_relationship);"FRIEND"===n.type?s.push("ex_estranged flag not allowed for FRIEND"):n.ex_estranged=e}return(r.notes&&(n.notes=(r.notes||"").toString().slice(0,500)),s.length)?{valid:!1,errors:s,value:n}:{valid:!0,value:n}}(a.relationship_context||a.relationshipContext,B);if(B&&!F.valid)return{statusCode:400,body:JSON.stringify({error:"Relationship context invalid",code:"REL_CONTEXT_INVALID",errorId:I(),issues:F.errors||[]})};if(B&&(i.zodiac_type||(i.zodiac_type="Tropic"),!(L=function(e){let t={};return C.forEach(a=>{(void 0===e[a]||null===e[a]||""===e[a])&&(t[a]="Missing or empty")}),{isValid:0===Object.keys(t).length,errors:t}}(i)).isValid))return{statusCode:400,body:JSON.stringify({error:"Secondary subject validation failed",code:"VALIDATION_ERROR_B",mode:o,errorId:I(),fieldErrors:L.errors})};let k=a.transitStartDate||a.transit_start_date||a.transitParams?.startDate||a.transit?.startDate,U=a.transitEndDate||a.transit_end_date||a.transitParams?.endDate||a.transit?.endDate,V=function(e){let t=String(e||"").toLowerCase();return["daily","weekly","monthly"].includes(t)?t:"1d"===t?"daily":"7d"===t?"weekly":"1m"===t||"1mo"===t||"monthly"===t?"monthly":"daily"}(a.transitStep||a.transit_step||a.transitParams?.step||a.transit?.step),Y=!!(k&&U);c.debug("Balance Meter decision variables (Part 2):",{haveRange:Y,start:k,end:U});try{r=f()}catch(e){return{statusCode:500,body:JSON.stringify({error:e.message,code:"CONFIG_ERROR",errorId:I()})}}let J={schema:"WM-Chart-1.2",provenance:{math_brain_version:d,ephemeris_source:m,build_ts:new Date().toISOString(),timezone:n.timezone||"UTC",calibration_boundary:_,engine_versions:{seismograph:"v1.0",balance:"v1.1",sfd:"v1.2"}},context:{mode:o||"UNKNOWN"},mirror_ready:!0,contract:"clear-mirror/1.2",person_a:{details:n}};B&&i&&Object.keys(i).length&&(J.person_b={details:i}),B&&F.valid&&F.value&&(J.relationship=F.value);let H={};["active_points","active_aspects","houses_system_identifier","sidereal_mode","perspective_type"].forEach(e=>{void 0!==a[e]&&(H[e]=a[e])}),["voice","voice_mode","exclude_person_b","excludePersonB","reflect_mode","ui","display"].forEach(e=>{e in H&&delete H[e]}),H.active_points||(H.active_points=["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto","Mean_Node","True_Node","Mean_South_Node","True_South_Node","Chiron","Mean_Lilith","Ascendant","Medium_Coeli","Descendant","Imum_Coeli"],c.debug("Setting default active_points (includes True nodes & full angle set)")),H.active_aspects||(H.active_aspects=[{name:"conjunction",orb:10},{name:"opposition",orb:10},{name:"trine",orb:8},{name:"square",orb:8},{name:"sextile",orb:6},{name:"semi-sextile",orb:2},{name:"semi-square",orb:2},{name:"quincunx",orb:3},{name:"sesquiquadrate",orb:3},{name:"quintile",orb:2},{name:"biquintile",orb:2}],c.debug("Setting default active_aspects to accepted canonical list"));let W={semisquare:"semi-square",semi_square:"semi-square","semi square":"semi-square",semisextile:"semi-sextile",semi_sextile:"semi-sextile","semi sextile":"semi-sextile",inconjunct:"quincunx","sesqui-square":"sesquiquadrate",sesquisquare:"sesquiquadrate"};if(Array.isArray(H.active_aspects)&&(H.active_aspects=H.active_aspects.map(e=>{if(!e)return null;if("string"==typeof e)return{name:e,orb:3};if("object"==typeof e){let t=(e.name||e.type||"").toString().toLowerCase();return{name:W[t]||t,orb:null!=e.orb?e.orb:3}}return null}).filter(Boolean).reduce((e,t)=>{let a=e.find(e=>e.name===t.name);return a?t.orb>a.orb&&(a.orb=t.orb):e.push(t),e},[])),c.debug("Normalized active_aspects list:",H.active_aspects),S)s=await w(l.BIRTH_DATA,{method:"POST",headers:r,body:JSON.stringify({subject:n})},"Birth data (A)"),J.person_a.birth_data=p(s.data||{});else if(y){s=await w(l.NATAL_ASPECTS_DATA,{method:"POST",headers:r,body:JSON.stringify({subject:n})},"Natal aspects data (A)");let e=p(s.data||{});J.person_a.chart=e,J.person_a.aspects=Array.isArray(s.aspects)?s.aspects:e.aspects||[]}else{s=await w(l.BIRTH_CHART,{method:"POST",headers:r,body:JSON.stringify({subject:n})},"Birth chart (A)");let e=p(s.data||{});J.person_a.chart=e,J.person_a.aspects=Array.isArray(s.aspects)?s.aspects:e.aspects||[]}let z="NATAL_ONLY"===o;if(N&&Y){c.debug("Processing sky transits mode:",{start:k,end:U,step:V});try{let{transitsByDate:e,retroFlagsByDate:t}=await P({name:"Sky Patterns",birth_date:k,birth_time:"12:00",birth_location:"Greenwich, UK",timezone:"GMT"},{startDate:k,endDate:U,step:V},r,H),a=D(e,t);J.sky_transits={transitsByDate:a.daily,derived:{seismograph_summary:a.summary,mode:"sky_patterns_only"}},c.debug("Sky transits completed with seismograph analysis")}catch(e){c.warn("Sky transits computation failed:",e.message),J.sky_transits={error:"Failed to compute sky patterns"}}}else if(Y&&!z){let{transitsByDate:e,retroFlagsByDate:t}=await P(n,{startDate:k,endDate:U,step:V},r,H);J.person_a.chart={...J.person_a.chart,transitsByDate:e};let a=Object.values(e).flatMap(e=>e);c.debug(`Transit aspects found: ${a.length} total including outer planets`),J.person_a.derived=J.person_a.derived||{},J.person_a.derived.t2n_aspects=u(a),J.person_a.transit_data=Object.values(e);let s=D(e,t);J.person_a.derived.seismograph_summary=s.summary,J.person_a.chart.transitsByDate=s.daily}if(("DUAL_NATAL"===o||"DUAL_NATAL_TRANSITS"===o||!B&&o&&o.startsWith("NATAL")&&i&&Object.keys(i).length)&&i){let e=h(i);if(e.isValid){if(!J.person_b||!J.person_b.chart)try{let e=await w(l.BIRTH_CHART,{method:"POST",headers:r,body:JSON.stringify({subject:i})},"Birth chart (B dual)"),t=p(e.data||{});J.person_b={details:i,chart:t,aspects:Array.isArray(e.aspects)?e.aspects:t.aspects||[]}}catch(e){c.warn("Dual Person B natal fetch failed",e.message),J.person_b={details:i,error:"Failed to compute Person B chart"}}if(Y&&!z&&"DUAL_NATAL_TRANSITS"===o)try{let{transitsByDate:e,retroFlagsByDate:t}=await P(i,{startDate:k,endDate:U,step:V},r,H),a=Object.values(e).flatMap(e=>e),s=D(e,t);J.person_b.chart={...J.person_b.chart||{},transitsByDate:s.daily},J.person_b.derived=J.person_b.derived||{},J.person_b.derived.seismograph_summary=s.summary,J.person_b.derived.t2n_aspects=u(a),J.person_b.transit_data=Object.values(e)}catch(e){c.warn("Dual Person B transits fetch failed",e.message),J.person_b.transits_error="Failed to compute Person B transits"}}else J.person_b={details:i,validation_error:e.message}}if(Y&&!z&&!B&&i&&Object.keys(i).length&&o&&o.startsWith("NATAL")&&o.includes("TRANSITS")&&"DUAL_NATAL_TRANSITS"!==o){let e=h(i);if(e.isValid){if(!J.person_b||!J.person_b.chart)try{let e=await w(l.BIRTH_CHART,{method:"POST",headers:r,body:JSON.stringify({subject:i})},"Birth chart (B implicit dual)"),t=p(e.data||{});J.person_b={details:i,chart:t,aspects:Array.isArray(e.aspects)?e.aspects:t.aspects||[]}}catch(e){c.warn("Implicit dual Person B natal fetch failed",e.message),J.person_b={...J.person_b||{},details:i,error:"Failed to compute Person B chart"}}if(!(J.person_b&&J.person_b.chart&&J.person_b.chart.transitsByDate))try{let{transitsByDate:e,retroFlagsByDate:t}=await P(i,{startDate:k,endDate:U,step:V},r,H),a=Object.values(e).flatMap(e=>e),s=D(e,t);J.person_b.chart={...J.person_b.chart||{},transitsByDate:s.daily},J.person_b.derived=J.person_b.derived||{},J.person_b.derived.seismograph_summary=s.summary,J.person_b.derived.t2n_aspects=u(a),J.person_b.transit_data=Object.values(e),J.person_b.implicit_dual_transits=!0}catch(e){c.warn("Implicit dual Person B transits fetch failed",e.message),J.person_b.transits_error="Failed to compute Person B transits"}}else J.person_b={...J.person_b||{},details:i,validation_error:e.message}}let G=h(i),K=g(i);if(M&&G.isValid){let e=await w(l.SYNASTRY_ASPECTS,{method:"POST",headers:r,body:JSON.stringify({first_subject:n,second_subject:i})},"Synastry aspects data"),t=p(e.data||{});J.person_b={...J.person_b||{},details:i},J.synastry_aspects=Array.isArray(e.aspects)?e.aspects:t.aspects||[],J.synastry_data=t;let a=R(J.person_a||{details:n,aspects:[]},{details:i,aspects:[]},J.synastry_aspects,{aspects:[],raw:{}},{});J.synastry_relational_mirror=a.relational_mirror,c.debug("Added relational mirror to synastry-aspects-only mode");try{let e=await w(l.BIRTH_CHART,{method:"POST",headers:r,body:JSON.stringify({subject:i})},"Birth chart (B for synastry-aspects)"),t=p(e.data||{});J.person_b.chart=t}catch(e){c.warn("Could not augment synastry-aspects with Person B natal chart",e.message)}}else if(A&&K.isValid){let e=await w(l.SYNASTRY_CHART,{method:"POST",headers:r,body:JSON.stringify({first_subject:n,second_subject:i})},"Synastry chart"),t=p(e.data||{});J.person_b={details:i,chart:t.second_subject||{}},J.synastry_aspects=Array.isArray(e.aspects)?e.aspects:t.aspects||[];let a=R(J.person_a||{details:n,aspects:[]},J.person_b,J.synastry_aspects,{aspects:[],raw:{}},{});if(J.synastry_relational_mirror=a.relational_mirror,c.debug("Added relational mirror to full synastry mode"),"SYNASTRY_TRANSITS"===o&&Y&&!z){c.debug("Computing Person B transits for synastry mode:",{start:k,end:U,step:V});let{transitsByDate:e,retroFlagsByDate:t}=await P(i,{startDate:k,endDate:U,step:V},r,H);J.person_b.chart={...J.person_b.chart,transitsByDate:e};let a=D(e,t);J.person_b.chart.transitsByDate=a.daily,J.person_b.derived={seismograph_summary:a.summary,t2n_aspects:u(Object.values(e).flatMap(e=>e))},c.debug("Person B transits completed for synastry mode")}}let X=i?h(i):{isValid:!1};if(T&&X.isValid){let e=await O(n,i,H,r);if(J.person_b&&J.person_b.chart)J.person_b={...J.person_b||{},details:i};else try{c.debug("Fetching Person B natal chart for composite scaffolding");let e=await w(l.BIRTH_CHART,{method:"POST",headers:r,body:JSON.stringify({subject:i})},"Birth chart (B for composite scaffolding)"),t=p(e.data||{});J.person_b={...J.person_b||{},details:i,chart:t,aspects:Array.isArray(e.aspects)?e.aspects:t.aspects||[]},c.debug("Person B natal chart added to composite scaffolding")}catch(e){c.warn("Could not fetch Person B natal chart for composite scaffolding",e.message),J.person_b={...J.person_b||{},details:i}}try{c.debug("Computing synastry aspects for composite scaffolding");let t=await w(l.SYNASTRY_ASPECTS,{method:"POST",headers:r,body:JSON.stringify({first_subject:n,second_subject:i})},"Synastry aspects for composite scaffolding"),a=p(t.data||{}),s=Array.isArray(t.aspects)?t.aspects:a.aspects||[],o=R(J.person_a||{details:n,aspects:[]},J.person_b||{details:i,aspects:[]},s,e,{});J.composite={aspects:e.aspects,data:e.raw,synastry_aspects:s,synastry_data:a,...o},c.debug(`Added ${s.length} synastry aspects and complete relational mirror to composite scaffolding`)}catch(a){c.warn("Could not compute synastry aspects for composite scaffolding",a.message);let t=R(J.person_a||{details:n,aspects:[]},J.person_b||{details:i,aspects:[]},[],e,{});J.composite={aspects:e.aspects,data:e.raw,...t}}Y&&!z&&(J.composite.transitsByDate={},J.composite.note="Composite transits temporarily disabled due to API compatibility issues",c.debug("Composite transits disabled - returning empty transit data"))}if(c.debug("Checking Balance Meter conditions:",{wantBalanceMeter:v,haveRange:Y,relationshipMode:B,shouldRunBalanceMeter:v&&Y&&!B}),v&&Y&&!B){if(c.debug("Processing Balance Meter mode for standalone report"),!J.person_a?.chart?.transitsByDate)try{let{transitsByDate:e,retroFlagsByDate:t}=await P(n,{startDate:k,endDate:U,step:V},r,H),a=D(e,t);J.person_a=J.person_a||{},J.person_a.derived=J.person_a.derived||{},J.person_a.derived.seismograph_summary=a.summary,J.person_a.chart={...J.person_a.chart||{},transitsByDate:a.daily}}catch(e){c.warn("Balance Meter fallback transit compute failed:",e.message)}if(J.person_a?.chart?.transitsByDate){let e={period:{start:k,end:U,step:V},schema_version:"1.2",channel_summary:J.person_a.derived?.seismograph_summary||null,daily_entries:J.person_a.chart.transitsByDate,person:{name:n.name||"Subject",birth_date:n.birth_date,birth_time:n.birth_time,birth_location:n.birth_location}};J.balance_meter=e,J.mode="balance_meter",c.debug("Balance Meter standalone report generated successfully")}else c.warn("Balance Meter requested but no transits available to compute report")}if(B){let e=[];if((A||M)&&!J.person_b&&e.push("person_b"),T&&!J.composite&&e.push("composite"),e.length)throw Object.assign(Error("PIPELINE_DROPPED_B"),{code:"PIPELINE_DROPPED_B",missing:e})}let Q=function e(t){if(!t||"object"!=typeof t)return t;if(Array.isArray(t))return t.map(e);let a={};for(let[r,s]of Object.entries(t))"field"!==r&&"voice"!==r&&"map"!==r&&(a[r]=e(s));return a}(J);return{statusCode:200,body:JSON.stringify(Q)}}catch(e){return c.error("Handler error:",e),{statusCode:500,body:JSON.stringify({error:e?.message||"Internal server error",code:e?.code||"INTERNAL_ERROR",errorId:I(),stack:e?.stack||null,details:e})}}};let x=global.__RC_COLD_START_TS||Date.now();global.__RC_COLD_START_TS=x;let E=global.__RC_HEALTH_INVOCATIONS||0;async function j(e){let t=new AbortController,a=setTimeout(()=>t.abort(),3500);try{let r=await fetch(`${l.NOW}`,{method:"GET",headers:e,signal:t.signal}),s=r.ok,n=r.status;return clearTimeout(a),{ok:s,status:n}}catch(e){return clearTimeout(a),{ok:!1,error:"AbortError"===e.name?"timeout":e.message}}}global.__RC_HEALTH_INVOCATIONS=E,t.health=async function(e){E++;let t=e&&e.queryStringParameters||{},a=!!process.env.RAPIDAPI_KEY,r=null;if(("ping"in t||"now"in t)&&a)try{r=await j(f())}catch(e){r={ok:!1,error:e.message}}return{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify({success:!0,service:"astrology-mathbrain",version:d,ephemeris_source:m,calibration_boundary:_,timestamp:new Date().toISOString(),environment:"production",rapidapi:{configured:a,ping:r},cold_start_ms:Date.now()-x,invocations:E,uptime_s:process.uptime(),memory:(()=>{try{let e=process.memoryUsage();return{rss:e.rss,heapUsed:e.heapUsed,heapTotal:e.heapTotal}}catch{return null}})()})}}},276:e=>{function t(e,t=2){return Math.round(e*10**t)/10**t}function a(e){let t=String(e||"").toLowerCase().trim();return({opposition:"opposition",opp:"opposition",square:"square",sq:"square",trine:"trine",tri:"trine",sextile:"sextile",sex:"sextile",conjunction:"conjunction",conj:"conjunction",quintile:"quintile",biquintile:"biquintile",quincunx:"quincunx",inconjunct:"quincunx","semi-square":"semi-square",sesquisquare:"sesquiquadrate",sesquiquadrate:"sesquiquadrate","semi-sextile":"semi-sextile"})[t]||t}function r(e){return e?String(("string"==typeof e?e:e.name||e.body||"")||"").trim():""}function s(e){switch(e){case"Sun":case"Moon":return"luminary";case"Mercury":case"Venus":case"Mars":return"personal";case"Jupiter":case"Saturn":return"social";case"Uranus":case"Neptune":case"Pluto":return"outer";case"Ascendant":case"Medium_Coeli":case"Descendant":case"Imum_Coeli":return"angle";case"Chiron":case"Mean_Node":case"True_Node":case"Mean_South_Node":case"True_South_Node":case"Mean_Lilith":return"point";default:return"other"}}function n(e){return"Jupiter"===e||"Venus"===e}function i(e,t,a,r){let n=s(a),i=s(r),o=e=>"luminary"===e||"angle"===e?6:"point"===e?3:4,l=Math.max(o(n),o(i)),u="quintile"===e||"biquintile"===e||"quincunx"===e||"sesquiquadrate"===e||"semi-square"===e||"semi-sextile"===e?1:l,c=Math.abs(Number(t||0));return!(c>=0)||c>=u?0:+(1-c/u)}function o(e,t){let a=new Set([s(e),s(t)]),r=1;return a.has("angle")&&(r*=1.2),a.has("luminary")&&(r*=1.1),a.has("personal")&&(r*=1.05),r}function l(e,t){switch(t){case"support":if("Jupiter"===e||"Venus"===e)return 1.4;if("Moon"===e||"Saturn"===e)return 1.2;return 1;case"counter":if("Mars"===e||"Saturn"===e||"Pluto"===e||"Chiron"===e)return 1.2;if("Neptune"===e)return 1.1;return 1;default:return 1}}function u(e,t,a){switch(e){case"trine":return 1.5;case"sextile":return 1;case"conjunction":if(n(t)||n(a))return 1.2;return 0;default:return 0}}function c(e,t,a){if(!("trine"===e||"sextile"===e))return!1;let r=new Set([t,a]);return r.has("Moon")&&r.has("Saturn")}function p(e){return"quintile"===e||"biquintile"===e}function d(e,t,a){let r=new Set([t,a]);return("square"===e||"opposition"===e)&&(r.has("Jupiter")||r.has("Venus"))?-1.3:"conjunction"===e&&(r.has("Saturn")||r.has("Pluto")||r.has("Chiron"))&&(r.has("Jupiter")||r.has("Venus"))?-.8:0}e.exports={computeSFD:function(e){if(!Array.isArray(e))return{SFD:0,Splus:0,Sminus:0};let s=0,n=0,m=new Set;for(let t of e){let e=a(t.aspect||t.type||t._aspect),n=r(t.p1_name||t.a||t.transit),d=r(t.p2_name||t.b||t.natal),_=null!=t.orb?t.orb:null!=t.orbit?t.orbit:t._orb,h=u(e,n,d);if(c(e,n,d)&&(h=Math.max(h,1.2)),p(e)&&1>=Math.abs(_)&&(h=Math.max(h,.5)),h>0){let t=l(n,"support");s+=Math.max(h*t*l(d,"support")*i(e,_,n,d)*o(n,d),0),m.add(n),m.add(d)}}let _=(e,t)=>m.has(e)||m.has(t);for(let t of e){let e=a(t.aspect||t.type||t._aspect),s=r(t.p1_name||t.a||t.transit),u=r(t.p2_name||t.b||t.natal),c=null!=t.orb?t.orb:null!=t.orbit?t.orbit:t._orb,p=0;p=Math.min(0,d(e,s,u));let h="square"===e||"opposition"===e,y=new Set([...m]);h&&("Saturn"===s||"Mars"===s||"Neptune"===s||"Saturn"===u||"Mars"===u||"Neptune"===u)&&(y.has(s)||y.has(u))&&(p=Math.min(p,-1.1));let f=new Set(["Moon","Mercury"]);if(h&&("Saturn"===s||"Neptune"===s||"Saturn"===u||"Neptune"===u)&&(f.has(s)||f.has(u))&&(y.has("Moon")||y.has("Mercury"))&&(p=Math.min(p,-1.1)),h&&("Mars"===s||"Mars"===u)&&("Venus"===s||"Jupiter"===s||"Venus"===u||"Jupiter"===u)&&(p=Math.min(p,-1.2)),h&&("Saturn"===s||"Saturn"===u)&&("Venus"===s||"Venus"===u)&&(p=Math.min(p,-1.1)),p<0){let t=l(s,"counter"),a=Math.abs(p)*t*l(u,"counter")*i(e,c,s,u)*o(s,u);_(s,u)||(a*=.7),n+=Math.max(a,0)}}let h=+(5*Math.tanh(s/4)).toFixed(2),y=+(5*Math.tanh(n/4)).toFixed(2);return{SFD:t(Math.max(-5,Math.min(5,h-y)),2),Splus:h,Sminus:y}},computeBalanceValence:function(e){if(!Array.isArray(e))return 0;let s=0;for(let t of e){let e;let n=a(t.aspect||t.type||t._aspect),m=r(t.p1_name||t.a||t.transit),_=r(t.p2_name||t.b||t.natal),h=null!=t.orb?t.orb:null!=t.orbit?t.orbit:t._orb,y=i(n,h,m,_),f=o(m,_);e=0+u(n,m,_),c(n,m,_)&&(e=Math.max(e,1.2)),p(n)&&1>=Math.abs(h)&&(e=Math.max(e,.5));let g=d(n,m,_),b=l(m,e>0?"support":"counter"),S=l(_,e>0?"support":"counter");s+=((e>0?e:0)+(g<0?g:0))*b*S*y*f}return t(5*Math.tanh(s/4),2)}}},5084:e=>{e.exports={mapT2NAspects:function(e){return Array.isArray(e)?e.map(e=>({p1:e.p1_name,p2:e.p2_name,aspect:e.aspect,orb:e.orbit,retrograde:!!(e.p2_retrograde||e.retrograde),isOuter:["Saturn","Uranus","Neptune","Pluto"].includes(e.p2_name),isPersonal:["Sun","Moon","Mercury","Venus","Mars","ASC","MC"].includes(e.p1_name),hard:["square","opposition","conjunction"].includes(e.aspect)})):[]}}},9693:e=>{let t=new Set(["Saturn","Uranus","Neptune","Pluto"]),a=new Set(["Sun","Moon","Mercury","Venus","Mars","ASC","MC","IC","DSC"]),r=new Set(["ASC","MC","IC","DSC"]),s={magnitudeDivisor:4,hubBonusCap:.6,sameTargetBonusCap:.3,tightBandDeg:1.5,outerTightenStep:.2,uranusTightFlagDeg:3,fastComponentThreshold:1,rollingWindowDays:14,hookStackCap:5,planetaryWeights:{Sun:1.2,Moon:1.5,ASC:1.3,MC:1.3,IC:1.1,DSC:1.1,Mercury:1,Venus:1,Mars:1.1,Jupiter:.9,Saturn:.8,Uranus:.7,Neptune:.6,Pluto:.6,Chiron:.8,Mean_Node:.7,Mean_South_Node:.7}};function n(e,t=2){return Math.round(e*10**t)/10**t}function i(e){if(e)return"string"==typeof e?e:e.name||e.body}function o(e){let t=i(e?.transit)||i(e?.a);return{transit:{body:t||"?"},natal:{body:i(e?.natal)||i(e?.b)||"?"},type:String(e?.type||e?.aspect||"").toLowerCase(),orbDeg:function(e,t=NaN){if("number"==typeof e)return e;if("string"==typeof e){let a=e.match(/(-?\d+)(?:[°:\s]+(\d+))?/);if(a)return+a[1]+(a[2]?+a[2]:0)/60;let r=parseFloat(e);return Number.isFinite(r)?r:t}return t}(e?.orb??e?.orbit,6.01)}}function l(e,t,a){switch(e){case"trine":return 1;case"sextile":return .7;case"square":case"opposition":return -1.2;case"conjunction":{let e=new Set([t,a]);if(e.has("Venus")||e.has("Jupiter"))return .6;if(e.has("Saturn")||e.has("Pluto")||e.has("Chiron"))return -.8;return 0}default:return 0}}function u(e){return"Chiron"===e?1.2:t.has(e)?1.5:"Moon"===e?.5:1}function c(e){let t=Math.abs(e);return t<=.5?1.5:t<=1.5?1.3:t<=3?1.2:t<=6?1:.6}function p(e,t=!1,r=!1,s=!1){let n=1;return t?n*=1.3:r?n*=1.2:a.has(e)&&(n*=1.1),s&&(n*=1.1),n}function d(e,t={}){let a=o(e),r=a.transit.body,s=a.natal.body,n=l(a.type,r,s),i=Math.max(u(r),u(s)),d=c(a.orbDeg),m=p(s,!!t.isAngleProx,"Sun"===s||"Moon"===s,!!t.critical);return{...a,S:n*i*d*m}}function m(e,t=s){let a=0,r=0,n=new Map;for(let t of e){let e=t.transit.body;n.set(e,(n.get(e)||0)+1)}for(let[,e]of n)e>=3&&(a+=.2*(e-2));a=Math.min(t.hubBonusCap,a);let i=new Map;for(let t of e){let e=t.natal.body;i.set(e,(i.get(e)||0)+1)}for(let[,e]of i)e>=2&&(r+=.1*(e-1));return a+(r=Math.min(t.sameTargetBonusCap,r))}function _(e,a=null,r=s){let n=0,i=0,o=0,l=0,u=e=>`${e.transit.body}|${e.natal.body}|${e.type}`;if(a?.scored){let t=e=>e.filter(e=>e.orbDeg<=r.tightBandDeg),s=new Set(t(a.scored).map(u)),i=new Set(t(e).map(u));for(let e of i)!s.has(e)&&n++;for(let e of s)!i.has(e)&&n++}if("number"==typeof a?.Y_effective){let t=a.Y_effective,r=e.reduce((e,t)=>e+t.S,0);Math.sign(t)!==Math.sign(r)&&Math.abs(t)>.05&&Math.abs(r)>.05&&(i=1)}if(a?.scored){let s=new Map(a.scored.map(e=>[u(e),e]));for(let a of e){let e=s.get(u(a)),n=(t.has(a.transit.body)||t.has(a.natal.body))&&("square"===a.type||"opposition"===a.type);e&&n&&e.orbDeg-a.orbDeg>=r.outerTightenStep&&o++}}e.some(e=>("Uranus"===e.transit.body||"Uranus"===e.natal.body)&&e.orbDeg<=r.uranusTightFlagDeg)&&(l=1);let c=e.map(e=>{let t=r.planetaryWeights[e.transit.body]||.5,a=r.planetaryWeights[e.natal.body]||.5;return e.S*Math.max(t,a)}),p=0;if(c.length>=3){let e=c.reduce((e,t)=>e+t,0)/c.length;p=Math.min(2,.5*Math.sqrt(c.reduce((t,a)=>t+Math.pow(a-e,2),0)/c.length))}return n+i+o+l+Math.round(p)}function h(e,t=null,a=s){let r;if(!t||!t.magnitudes||t.magnitudes.length<1)return e;let{magnitudes:n}=t,i=n.length,o=Math.min(1,i/14);if(i>=14){let e=[...n].sort((e,t)=>e-t),t=Math.floor(e.length/2);r=e.length%2==0?(e[t-1]+e[t])/2:e[t]}else if(i>=2){let e=[...n].sort((e,t)=>e-t),t=Math.floor(e.length/2);r=o*(e.length%2==0?(e[t-1]+e[t])/2:e[t])+(1-o)*4}else r=4;return r<1e-6&&(r=4),Math.max(0,Math.min(10,5*e/(1.6*r)))}e.exports={aggregate:function(e=[],t=null,a={}){if(!Array.isArray(e)||0===e.length)return{magnitude:0,valence:t?.Y_effective?n(t.Y_effective,2):0,volatility:0,scored:[]};let i={...s,...a},o=e.map(e=>d(e,{isAngleProx:r.has(e?.natal?.body||e?.b?.name||e?.b||""),critical:!1})),l=o.reduce((e,t)=>e+Math.abs(t.S),0),u=o.reduce((e,t)=>e+t.S,0),c=Math.min(5,l/i.magnitudeDivisor),p=c=Math.min(5,c+m(o,i)),y=1;a.rollingContext&&a.rollingContext.magnitudes&&(y=n(a.rollingContext.magnitudes.length/14,2)),a.rollingContext&&(c=h(c,a.rollingContext,i));let f=u*(.8+.2*c),g=_(o,t,i);return{magnitude:n(c,2),valence:n(f,2),volatility:g,scored:o,rawMagnitude:n(l/i.magnitudeDivisor,2),originalMagnitude:n(p,2),scaleConfidence:y}},_internals:{normalizeAspect:o,baseValence:l,planetTier:u,orbMultiplier:c,sensitivityMultiplier:p,scoreAspect:d,multiplicityBonus:m,volatility:_,normalizeWithRollingWindow:h}}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,972],()=>a(2866));module.exports=r})();