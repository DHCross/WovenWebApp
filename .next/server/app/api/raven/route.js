(()=>{var a={};a.id=756,a.ids=[756],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63568:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>Q,patchFetch:()=>P,routeModule:()=>L,serverHooks:()=>O,workAsyncStorage:()=>M,workUnitAsyncStorage:()=>N});var d={};c.r(d),c.d(d,{POST:()=>K});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(77533),k=c(32822),l=c(261),m=c(54290),n=c(85328),o=c(38928),p=c(46595),q=c(3421),r=c(17679),s=c(41681),t=c(63446),u=c(86439),v=c(51356),w=c(10641),x=c(55511);let y=/\b(Sun|Moon|Mercury|Venus|Mars|Jupiter|Saturn|Uranus|Neptune|Pluto)\s+in\s+[A-Z][a-z]+\s+\d{1,2}°/,z=/\b(ASC|MC)\s+in\s+[A-Z][a-z]+\s+\d{1,2}°/,A=/\b\d+(st|nd|rd|th)\s+House\s+in\s+[A-Z][a-z]+\s+\d{1,2}°/,B=/\b(Conjunction|Square|Trine|Sextile|Opposition)\b.*\(Orb:\s*\d{1,2}°/,C=/\b(run|make|generate|show)\b|\btransit(s)?\b|\bsynastry\b|\bcomposite\b|\brelocat(e|ion)\b|\bfrom\b.*\bto\b/i;async function D({geo:a,prov:b,options:d,conversational:e=!1}){if(e){let a,e=d?.userMessage||"",f=`You are Poetic Brain, an empathetic, direct assistant. The user says: "${e}". Reply naturally in plain language, then also provide a short structured mirror in five labeled parts: PICTURE, FEELING, CONTAINER, OPTION, NEXT_STEP. Keep the structure clear but use natural, non-form-like language for the primary reply.`,g="";try{let a=(await Promise.all([c.e(364),c.e(404)]).then(c.bind(c,31404))).generateText;g=await a(f,{personaHook:"poetic"})}catch(a){g=`I'm here and listening. ${e?`You said: "${e}".`:""} I notice a quiet moment — take one breath.
PICTURE: A quiet room at dusk.
FEELING: Contemplative.
CONTAINER: Just this moment, right here.
OPTION: You can either explore this feeling further or shift your focus to something practical.
NEXT_STEP: Take one deep breath.`}let h={picture:"",feeling:"",container:"",option:"",next_step:""},i=/PICTURE[:\-\s]*([^\n]+)|FEELING[:\-\s]*([^\n]+)|CONTAINER[:\-\s]*([^\n]+)|OPTION[:\-\s]*([^\n]+)|NEXT[_ ]?STEP[:\-\s]*([^\n]+)/gi;for(;null!==(a=i.exec(g));)a[1]&&(h.picture=h.picture||a[1].trim()),a[2]&&(h.feeling=h.feeling||a[2].trim()),a[3]&&(h.container=h.container||a[3].trim()),a[4]&&(h.option=h.option||a[4].trim()),a[5]&&(h.next_step=h.next_step||a[5].trim());return h.picture||(h.picture=g.split("\n")[0].slice(0,120)),h.feeling||(h.feeling=g.split("\n")[1]?g.split("\n")[1].slice(0,80):"Reflective."),h.container||(h.container="This moment."),h.option||(h.option="You can either explore this further or take a practical step."),h.next_step||(h.next_step="Take one deep breath."),{raw:g,picture:h.picture,feeling:h.feeling,container:h.container,option:h.option,next_step:h.next_step,appendix:{provenance_source:b?.source}}}return{picture:"A compass needle spinning, then finding north.",feeling:"Clarity.",container:"The next 24 hours.",option:"You can act on this new direction, or you can wait and gather more information.",next_step:"Write down the first action that comes to mind.",appendix:{geometry_summary:a?"Geometry data processed.":"No geometry data provided.",provenance_source:b.source}}}function E(a){return{timestamp:new Date().toISOString(),source:"Unknown",house_system:"Placidus",orb_profile:"Default",relocation_mode:"none",versions:{template:"SoloMirror-v1.4.0",schema:"mirror-draft-2025-09"},...a}}let F={mirror:"solo_mirror",solo_mirror:"solo_mirror",balance:"solo_balance_meter",solo_balance:"solo_balance_meter",solo_balance_meter:"solo_balance_meter",transit:"solo_balance_meter",relational_mirror:"relational_mirror",synastry:"relational_mirror",composite:"relational_balance_meter",relational_balance_meter:"relational_balance_meter",relational_balance:"relational_balance_meter"};async function G(a){let b=`${function(){let a=process.env.MATHBRAIN_INTERNAL_BASE_URL||process.env.MATH_BRAIN_INTERNAL_BASE_URL;if(a)return a.replace(/\/$/,"");let b=process.env.NEXT_PUBLIC_SITE_URL||process.env.SITE_URL;if(b)return b.replace(/\/$/,"");let c=process.env.VERCEL_URL;if(c)return`https://${c.replace(/\/$/,"")}`;let d=process.env.PORT||3e3;return`http://127.0.0.1:${d}`}()}/api/astrology-mathbrain`,c=function(a){let b={...a||{}},c=a?.report_type||a?.reportType;return c&&(b.report_type=F[String(c).toLowerCase()]||c),b}(a??{});try{var d;let a=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c),cache:"no-store"}),e=await a.text(),f={};if(e)try{f=JSON.parse(e)}catch(a){f={raw:e}}if(!a.ok)return{success:!1,status:a.status,error:f?.error||`Math Brain API call failed (${a.status})`,details:f};return{success:!0,provenance:function(a,b){let c=b?.provenance&&"object"==typeof b.provenance?b.provenance:{};return{source:"Math Brain API",report_type:a?.reportType||a?.report_type||"unknown",api_version:b?.provenance?.api_version||b?.meta?.api_version||"unversioned",...c}}(c,f),geometry:(d=f)&&"object"==typeof d&&(d.geometry||d.raw_geometry||d.report?.geometry)||null,climate:function(a){if(!a||"object"!=typeof a)return null;if(a.climate)return a.climate;let b=a.balance_meter||a.summary?.balance_meter;return b?.climate?b.climate:b?.climate_line?{line:b.climate_line,magnitude:b.magnitude,valence:b.valence,volatility:b.volatility}:null}(f),data:f}}catch(a){return{success:!1,error:a?.message||"Math Brain API call failed",details:a}}}function H(a,b){return{id:b,text:a,createdAt:new Date().toISOString()}}function I(a){let b={WB:0,ABE:0,OSR:0,total:0};for(let c of a.probes)c.tag&&(b.total+=1,"WB"===c.tag&&(b.WB+=1),"ABE"===c.tag&&(b.ABE+=1),"OSR"===c.tag&&(b.OSR+=1));let c=Math.max(1,b.WB+b.ABE+b.OSR),d=Math.max(1,b.WB+b.ABE),e=b.WB/c;return{accuracy:e,edgeCapture:b.ABE/d,clarity:1,counts:b}}let J=new Map;async function K(a){try{var b,c,d;let{action:e="generate",input:f,options:g={},sessionId:h}=await a.json(),i=h;if(i||(i=(0,x.randomUUID)()),J.has(i)||J.set(i,{probes:[]}),"feedback"===e){let{probeId:a,tag:c}=g,d=J.get(i),e=d.probes.findIndex(b=>b.id===a);if(-1===e)return w.NextResponse.json({ok:!1,error:"Probe not found"},{status:404});d.probes[e]=(b=d.probes[e],{...b,tag:c,committed:!0,committedAt:new Date().toISOString()});let f=I(d);return w.NextResponse.json({ok:!0,sessionId:i,scores:f,probe:d.probes[e]})}if("export"===e){let a=J.get(i),b=I(a);return w.NextResponse.json({ok:!0,sessionId:i,scores:b,log:a})}let j=function(a){let b=a.trim();return y.test(b)||z.test(b)||A.test(b)||B.test(b)?"geometry":C.test(b)?"report":"conversation"}("string"==typeof f?f:"");if("geometry"===j){let a=(c=String(f),console.log("Parsing AstroSeek blob..."),d={parsed:!0,content:c.substring(0,100)+"..."},console.log("Normalizing geometry..."),{points:[],houses:[],drivers:[],normalizedFrom:d}),b=E({source:"AstroSeek (manual paste)"}),e=await D({geo:a,prov:b,options:g}),h=H(e?.next_step||"Reflect on the mirror",(0,x.randomUUID)());return J.get(i).probes.push(h),w.NextResponse.json({intent:j,ok:!0,draft:e,prov:b,sessionId:i,probe:h})}if("report"===j){let a=await G(g);if(!a.success)return w.NextResponse.json({intent:j,ok:!1,error:"Math Brain failed",details:a});let b=E(a.provenance),c=await D({geo:a.geometry,prov:b,options:g}),d=H(c?.next_step||"Note one actionable step",(0,x.randomUUID)());return J.get(i).probes.push(d),w.NextResponse.json({intent:j,ok:!0,draft:c,prov:b,climate:a.climate??null,sessionId:i,probe:d})}let k=E({source:"Conversational"}),l={...g||{},userMessage:"string"==typeof f?f:""},m=await D({geo:null,prov:k,options:l,conversational:!0}),n=H(m?.next_step||"Take one breath",(0,x.randomUUID)());return J.get(i).probes.push(n),w.NextResponse.json({intent:j,ok:!0,draft:m,prov:k,sessionId:i,probe:n})}catch(b){console.error("Raven API Error:",b);let a=b instanceof Error?b.message:"An unknown error occurred";return w.NextResponse.json({ok:!1,error:"Failed to process request",details:a},{status:500})}}let L=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/raven/route",pathname:"/api/raven",filename:"route",bundlePath:"app/api/raven/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/dancross/Documents/GitHub/WovenWebApp/app/api/raven/route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:M,workUnitAsyncStorage:N,serverHooks:O}=L;function P(){return(0,g.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:N})}async function Q(a,b,c){var d;let e="/api/raven/route";"/index"===e&&(e="/");let g=await L.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:w,params:x,nextConfig:y,isDraftMode:z,prerenderManifest:A,routerServerContext:B,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,resolvedPathname:E,clientReferenceManifest:F,serverActionsManifest:G}=g,H=(0,l.normalizeAppPath)(e),I=!!(A.dynamicRoutes[H]||A.routes[E]);if(I&&!z){let a=!!A.routes[E],b=A.dynamicRoutes[H];if(b&&!1===b.fallback&&!a)throw new u.NoFallbackError}let J=null;!I||L.isDev||z||(J="/index"===(J=E)?"/":J);let K=!0===L.isDev||!I,M=I&&!K;G&&F&&(0,j.setReferenceManifestsSingleton)({page:e,clientReferenceManifest:F,serverActionsManifest:G,serverModuleMap:(0,k.createServerModuleMap)({serverActionsManifest:G})});let N=a.method||"GET",O=(0,i.getTracer)(),P=O.getActiveScopeSpan(),Q={params:x,prerenderManifest:A,renderOpts:{experimental:{cacheComponents:!!y.experimental.cacheComponents,authInterrupts:!!y.experimental.authInterrupts},supportsDynamicResponse:K,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=y.experimental)?void 0:d.cacheLife,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>L.onRequestError(a,b,d,B)},sharedContext:{buildId:w}},R=new m.NodeNextRequest(a),S=new m.NodeNextResponse(b),T=n.NextRequestAdapter.fromNodeNextRequest(R,(0,n.signalFromNodeResponse)(b));try{let d=async a=>L.handle(T,Q).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let c=O.getRootSpanAttributes();if(!c)return;if(c.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${c.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let d=c.get("next.route");if(d){let b=`${N} ${d}`;a.setAttributes({"next.route":d,"http.route":d,"next.span_name":b}),a.updateName(b)}else a.updateName(`${N} ${e}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&C&&D&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=Q.renderOpts.fetchMetrics;let i=Q.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=Q.renderOpts.collectedTags;if(!I)return await (0,q.I)(R,S,e,Q.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,r.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[t.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==Q.renderOpts.collectedRevalidate&&!(Q.renderOpts.collectedRevalidate>=t.INFINITE_CACHE)&&Q.renderOpts.collectedRevalidate,d=void 0===Q.renderOpts.collectedExpire||Q.renderOpts.collectedExpire>=t.INFINITE_CACHE?void 0:Q.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await L.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:M,isOnDemandRevalidate:C})},B),b}},l=await L.handleResponse({req:a,nextConfig:y,cacheKey:J,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,responseGenerator:k,waitUntil:c.waitUntil});if(!I)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),z&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,r.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&I||m.delete(t.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,s.getCacheControlHeader)(l.cacheControl)),await (0,q.I)(R,S,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};P?await g(P):await O.withPropagatedContext(a.headers,()=>O.trace(o.BaseServerSpan.handleRequest,{spanName:`${N} ${e}`,kind:i.SpanKind.SERVER,attributes:{"http.method":N,"http.target":a.url}},g))}catch(b){if(b instanceof u.NoFallbackError||await L.onRequestError(a,b,{routerKind:"App Router",routePath:H,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:M,isOnDemandRevalidate:C})}),I)throw b;return await (0,q.I)(R,S,new Response(null,{status:500})),null}}},78335:()=>{},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},96487:()=>{}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[828,428,692],()=>b(b.s=63568));module.exports=c})();