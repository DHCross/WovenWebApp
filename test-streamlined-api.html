<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        button { padding: 10px 20px; margin: 10px; background: #0ea5e9; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0284c7; }
        .output { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        .error { background: #7f1d1d; }
        .success { background: #14532d; }
    </style>
</head>
<body>
    <h1>Streamlined API Test</h1>
    <p>Testing the streamlined context modes with the updated validation logic.</p>
    
    <button onclick="testNatalTransits()">Test Natal + Transits</button>
    <button onclick="testSynastryTransits()">Test Synastry + Transits</button>
    <button onclick="testCompositeTransits()">Test Composite + Transits</button>
    <button onclick="testMissingTransitDates()">Test Missing Transit Dates (Should Fail)</button>
    <button onclick="toggleRaw()">Toggle Raw JSON</button>
    
    <div id="output" class="output"></div>
    <pre id="raw-json" style="display:none;background:#2a2a2a;padding:15px;border-radius:5px;"></pre>

    <script>
        const apiEndpoint = '/.netlify/functions/astrology-mathbrain';
        
        function log(message, isError = false, isSuccess = false) {
            const output = document.getElementById('output');
            const className = isError ? 'error' : (isSuccess ? 'success' : '');
            output.innerHTML += `<div class="${className}">${new Date().toISOString()}: ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function assertBasics(json){
            const planets = json?.natal?.planets || [];
            log(`Planet count: ${planets.length}`, planets.length < 11);
            const houses = json?.natal?.houses || [];
            log(`House count: ${houses.length}`, houses.length !== 12);
            const aspects = json?.natal?.aspects || [];
            log(`Aspect rows: ${aspects.length}`, aspects.length === 0);
            const angles = json?.natal?.angles || {};
            const hasAngles = angles.ASC && angles.MC;
            log(`Angles ASC/MC present: ${hasAngles}`, !hasAngles);
            const satMoon = aspects.some(a => (a.a === 'Saturn' && a.b === 'Moon') || (a.a === 'Moon' && a.b === 'Saturn'));
            log(`Saturn↔Moon present: ${satMoon}`, !satMoon);
        }

        function toggleRaw(){
            const pre = document.getElementById('raw-json');
            pre.style.display = pre.style.display === 'none' ? 'block' : 'none';
        }

        async function makeApiCall(data, testName) {
            log(`\n=== ${testName} ===`);
            log(`Sending data: ${JSON.stringify(data, null, 2)}`);
            
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const text = await response.text();
                try {
                    const result = JSON.parse(text);
                    document.getElementById('raw-json').textContent = JSON.stringify(result, null, 2);
                    if (response.ok) {
                        log(`✅ ${testName} SUCCESS`, false, true);
                        log(`Response preview: ${JSON.stringify(result).substring(0, 200)}...`);
                        assertBasics(result);
                    } else {
                        log(`❌ ${testName} FAILED: ${result.error}`, true);
                        if (result.missing) {
                            log(`Missing fields: ${result.missing.join(', ')}`, true);
                        }
                    }
                } catch(e){
                    log(`❌ ${testName} JSON parse error: ${e.message}`, true);
                }
            } catch (error) {
                log(`❌ ${testName} ERROR: ${error.message}`, true);
            }
        }

        function testNatalTransits() {
            const data = {
                personA: {
                    name: "Test Person A",
                    city: "New York",
                    nation: "US",
                    year: 1990,
                    month: 6,
                    day: 15,
                    hour: 12,
                    minute: 0,
                    latitude: 40.7128,
                    longitude: -74.0060,
                    zodiac_type: "Tropic",
                    timezone: "America/New_York"
                },
                context: {
                    mode: "natal"
                },
                transit: {
                    startDate: "2024-01-01",
                    endDate: "2024-01-31",
                    step: "1d"
                }
            };
            makeApiCall(data, "Natal + Transits");
        }

        function testSynastryTransits() {
            const data = {
                personA: {
                    name: "Test Person A",
                    city: "New York",
                    nation: "US",
                    year: 1990,
                    month: 6,
                    day: 15,
                    hour: 12,
                    minute: 0,
                    latitude: 40.7128,
                    longitude: -74.0060,
                    zodiac_type: "Tropic",
                    timezone: "America/New_York"
                },
                personB: {
                    name: "Test Person B",
                    city: "Los Angeles",
                    nation: "US",
                    year: 1988,
                    month: 3,
                    day: 22,
                    hour: 18,
                    minute: 30,
                    latitude: 34.0522,
                    longitude: -118.2437,
                    zodiac_type: "Tropic",
                    timezone: "America/Los_Angeles"
                },
                context: {
                    mode: "synastry-transits",
                    relationship_type: "partner",
                    intimacy_tier: "P3"
                },
                transit: {
                    startDate: "2024-01-01",
                    endDate: "2024-01-31",
                    step: "1d"
                }
            };
            makeApiCall(data, "Synastry + Transits");
        }

        function testCompositeTransits() {
            const data = {
                personA: {
                    name: "Test Person A",
                    city: "New York",
                    nation: "US",
                    year: 1990,
                    month: 6,
                    day: 15,
                    hour: 12,
                    minute: 0,
                    latitude: 40.7128,
                    longitude: -74.0060,
                    zodiac_type: "Tropic",
                    timezone: "America/New_York"
                },
                personB: {
                    name: "Test Person B",
                    city: "Los Angeles",
                    nation: "US",
                    year: 1988,
                    month: 3,
                    day: 22,
                    hour: 18,
                    minute: 30,
                    latitude: 34.0522,
                    longitude: -118.2437,
                    zodiac_type: "Tropic",
                    timezone: "America/Los_Angeles"
                },
                context: {
                    mode: "composite-transits",
                    relationship_type: "partner",
                    intimacy_tier: "P2"
                },
                transit: {
                    startDate: "2024-01-01",
                    endDate: "2024-01-31",
                    step: "1d"
                }
            };
            makeApiCall(data, "Composite + Transits");
        }

        function testMissingTransitDates() {
            const data = {
                personA: {
                    name: "Test Person A",
                    city: "New York",
                    nation: "US",
                    year: 1990,
                    month: 6,
                    day: 15,
                    hour: 12,
                    minute: 0,
                    latitude: 40.7128,
                    longitude: -74.0060,
                    zodiac_type: "Tropic",
                    timezone: "America/New_York"
                },
                context: {
                    mode: "natal"
                }
                // Missing transit dates - should trigger validation error
            };
            makeApiCall(data, "Missing Transit Dates (Expected to Fail)");
        }

        // Auto-run a basic test on load
        window.onload = () => {
            log("🧪 Streamlined API Test Page Loaded");
            log("Click buttons above to test different scenarios");
            log("All modes now require transit dates per the updated protocol\n");
        };
    </script>
</body>
</html>
