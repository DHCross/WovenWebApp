# Auth0 Application Login URI Configuration Guide

## Overview

This guide explains how to configure Auth0's "Application Login URI" setting to work with the WovenWebApp deployment at `https://sprightly-genie-998c07.netlify.app`.

## What is the Application Login URI?

The Application Login URI is a special Auth0 setting that determines where Auth0 redirects users in various scenarios:

1. **Bookmarked Login Pages**: When users bookmark Auth0's login page and return later after the session expires
2. **Password Reset Completion**: After users complete a password reset flow
3. **Email Verification Completion**: After users verify their email address
4. **Organization Invitations**: When users click invitation links to join organizations
5. **Disabled Cookies**: When browsers have cookies disabled and Auth0 needs to redirect back

## Current Configuration

### Correct Application Login URI
```
https://sprightly-genie-998c07.netlify.app/login
```

**Note**: Use the Netlify deployment URL (`sprightly-genie-998c07.netlify.app`) rather than `ravencalder.com` because:
- It matches the actual application deployment location
- It ensures consistent routing through the Netlify infrastructure
- It maintains proper SSL certificate validation

## How to Configure in Auth0 Dashboard

### Step 1: Access Application Settings
1. Go to [Auth0 Dashboard](https://manage.auth0.com/)
2. Navigate to **Applications** in the left sidebar
3. Select your Single Page Application (SPA)
4. Click on the **Settings** tab

### Step 2: Set Application Login URI
1. Scroll down to the **Application Login URI** field
2. Enter: `https://sprightly-genie-998c07.netlify.app/login`
3. Click **Save Changes**

### Step 3: Using Management API (Alternative)
You can also set this via the Auth0 Management API:

```bash
curl --request PATCH \
  --url 'https://dev-z8gw1uk6zgsrzubk.us.auth0.com/api/v2/clients/YOUR_CLIENT_ID' \
  --header 'authorization: Bearer YOUR_MGMT_API_TOKEN' \
  --header 'cache-control: no-cache' \
  --header 'content-type: application/json' \
  --data '{"initiate_login_uri": "https://sprightly-genie-998c07.netlify.app/login"}'
```

## How the Login Initiation Works

### 1. Login Route Handler
The `/login` route is handled by the `login-initiate.js` Netlify function which:

- Accepts various query parameters from Auth0
- Extracts organization, invitation, and other parameters
- Builds a proper Auth0 authorization URL
- Redirects users to Auth0's `/authorize` endpoint

### 2. Supported Query Parameters

The login initiation endpoint handles these parameters:

| Parameter | Description | Example |
|-----------|-------------|---------|
| `iss` | Issuer identifier for OIDC third-party login | Added automatically by Auth0 |
| `invitation` | Invitation ticket ID for organization invites | `inv_abc123` |
| `organization` | Organization ID | `org_def456` |
| `organization_name` | Human-readable organization name | `My Company` |
| `state` | Auth0 state parameter | Generated by Auth0 |
| `prompt` | Authentication prompt type | `select_account`, `login` |

### 3. Example Flow

1. User clicks organization invitation link
2. Auth0 redirects to: `https://sprightly-genie-998c07.netlify.app/login?invitation=inv_123&organization=org_456&organization_name=My%20Company`
3. Login function extracts parameters
4. Function redirects to: `https://dev-z8gw1uk6zgsrzubk.us.auth0.com/authorize?client_id=...&invitation=inv_123&organization=org_456`
5. User completes auth flow
6. Auth0 redirects back to main application

## Testing the Configuration

### 1. Test the Login Endpoint
```bash
curl -I https://sprightly-genie-998c07.netlify.app/login
```
Should return a 302 redirect to Auth0.

### 2. Test with Parameters
```bash
curl -I "https://sprightly-genie-998c07.netlify.app/login?organization=test&prompt=login"
```
Should redirect to Auth0 with organization parameter included.

### 3. Test Organization Invitation Flow
Create a test invitation in Auth0 and verify the email link points to the correct login URI.

## Environment Variables Required

Ensure these environment variables are set in Netlify:

```bash
AUTH0_DOMAIN=dev-z8gw1uk6zgsrzubk.us.auth0.com
AUTH0_CLIENT_ID=your_spa_client_id
AUTH0_AUDIENCE=your_api_identifier  # Optional
```

## Related Auth0 Settings

### Other URLs that should still be configured:

**Allowed Callback URLs**:
```
http://localhost:8888, https://sprightly-genie-998c07.netlify.app
```

**Allowed Logout URLs**:
```
http://localhost:8888, https://sprightly-genie-998c07.netlify.app
```

**Allowed Web Origins**:
```
http://localhost:8888, https://sprightly-genie-998c07.netlify.app
```

### Important Distinctions

- **Application Login URI**: Where Auth0 redirects for login initiation (`/login`)
- **Callback URLs**: Where Auth0 redirects after successful authentication (`/`)
- **Logout URLs**: Where Auth0 redirects after logout (`/`)

## Troubleshooting

### Common Issues

1. **"Application Login URI not found"**
   - Verify the `/login` route is working: `curl -I https://sprightly-genie-998c07.netlify.app/login`
   - Check Netlify function logs for errors

2. **Redirect loops**
   - Ensure the login URI points to `/login`, not `/` or Auth0 URLs
   - Verify the login function redirects to Auth0, not back to itself

3. **Missing organization parameters**
   - Check that the login function properly extracts and forwards query parameters
   - Verify organization invitation emails contain correct URL format

4. **Cookie warnings**
   - The login endpoint should handle cookie-disabled scenarios gracefully
   - Consider adding cookie detection to the login page

### Debugging

Enable debug logging:
```bash
LOG_LEVEL=debug netlify dev
```

Check Netlify function logs for login initiation requests and Auth0 redirects.

## Security Considerations

1. **HTTPS Required**: The Application Login URI must use HTTPS in production
2. **Parameter Validation**: The login function validates and sanitizes query parameters
3. **No Secrets in URLs**: Client ID is logged but masked in debug output
4. **State Parameter**: Auth0's state parameter is properly forwarded for CSRF protection

## Summary

Setting the Auth0 Application Login URI to `https://sprightly-genie-998c07.netlify.app/login` ensures that all Auth0-initiated redirects (bookmarked pages, password resets, email verification, organization invitations, and cookie-disabled scenarios) properly route through the application's login initiation handler, which then redirects users to Auth0 with the correct parameters for a seamless authentication experience.