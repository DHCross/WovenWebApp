// Test the API with real RAPIDAPI - local handler call
// This script invokes the local astrology-mathbrain handler for ad-hoc testing

(async () => {
  process.env.MB_MOCK = 'false';

  const handler = require('../../lib/server/astrology-mathbrain.js');

  const event = {
    httpMethod: 'POST',
    body: JSON.stringify({
      personA: {
        name: 'Test Subject',
        year: 1990,
        month: 1,
        day: 1,
        hour: 12,
        minute: 0,
        latitude: 40.0167,
        longitude: -75.3,
        timezone: 'America/New_York'
      },
      window: {
        start: '2025-09-01',
        end: '2025-09-03',
        step: 'daily'
      },
      context: {
        mode: 'NATAL_TRANSITS'
      }
    })
  };

  console.log('üöÄ Calling real Astrologer API...');

  try {
    const response = await handler.handler(event);
    console.log('‚úÖ Status:', response.statusCode);

    const body = JSON.parse(response.body);

    // Check our improvements
    console.log('üìä Math Brain version:', body.provenance?.math_brain_version);
    console.log('üéØ Person A has chart:', !!body.person_a?.chart);
    console.log('üìÖ Transit dates found:', Object.keys(body.person_a?.chart?.transitsByDate || {}));
    console.log('üîç Provenance dates:', Object.keys(body.person_a?.chart?.provenanceByDate || {}));

    // Check first day details
    const firstDate = Object.keys(body.person_a?.chart?.transitsByDate || {})[0];
    if (firstDate) {
      const dayData = body.person_a.chart.transitsByDate[firstDate];
      const provData = body.person_a.chart.provenanceByDate?.[firstDate];

      console.log(`\nüìà Day ${firstDate}:`);
      console.log('  Raw aspects:', dayData?.aspects?.length || 0);
      console.log('  Filtered aspects:', dayData?.filtered_aspects?.length || 0);
      console.log('  Hooks:', dayData?.hooks?.length || 0);
      console.log('  Seismograph:', dayData?.seismograph);
      console.log('  Provenance:', provData);

      if (dayData?.hooks?.length > 0) {
        console.log('  First hook:', dayData.hooks[0]);
      }
    }

    console.log('\n‚ú® Test completed successfully!');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.error('Stack:', error.stack);
  }
})();
